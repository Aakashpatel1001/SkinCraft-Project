{% extends 'base.html' %}

{% block content %}
<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeInUp { animation: fadeInUp 0.45s ease; }
    .otp-input:focus { box-shadow: 0 0 0 3px rgba(45, 90, 74, 0.25); }
</style>

<div class="min-h-screen bg-gradient-to-br from-stone-50 via-white to-stone-100 py-12 px-4">
    <div class="max-w-xl mx-auto">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <div class="bg-gradient-to-r from-ayur-dark to-ayur-primary p-10 text-white text-center">
                <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-shield-halved text-xl"></i>
                </div>
                <h1 class="text-3xl font-bold font-serif">Reset your password</h1>
                <p class="text-sm text-white/80 mt-2">Secure your account in minutes</p>
            </div>

            <div class="p-8 lg:p-12">
                <div class="mb-6 text-sm text-gray-500">
                    Follow the steps below to verify your email and create a new password.
                </div>

                <div class="flex items-center justify-between mb-10">
                    <div class="flex items-center gap-3">
                        <div id="stepCircle1" class="w-9 h-9 rounded-full bg-ayur-dark text-white flex items-center justify-center text-sm font-bold">1</div>
                        <span id="stepLabel1" class="text-sm font-semibold text-ayur-dark">Email</span>
                    </div>
                    <div class="flex-1 h-1 mx-4 bg-gray-200 rounded-full overflow-hidden">
                        <div id="stepBar1" class="h-full bg-ayur-dark w-1/3 transition-all"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="stepCircle2" class="w-9 h-9 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-bold">2</div>
                        <span id="stepLabel2" class="text-sm font-semibold text-gray-500">Verify</span>
                    </div>
                    <div class="flex-1 h-1 mx-4 bg-gray-200 rounded-full overflow-hidden">
                        <div id="stepBar2" class="h-full bg-ayur-dark w-0 transition-all"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="stepCircle3" class="w-9 h-9 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-bold">3</div>
                        <span id="stepLabel3" class="text-sm font-semibold text-gray-500">Reset</span>
                    </div>
                </div>

                <div id="toast" class="hidden mb-6 rounded-lg px-4 py-3 text-sm border"></div>

                <form id="emailForm" class="space-y-6 animate-fadeInUp">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="send_otp">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Email Address</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-gray-400"><i class="fa-solid fa-envelope"></i></span>
                            <input type="email" name="email" id="emailInput" required
                                class="w-full rounded-xl border border-gray-200 px-10 py-3.5 focus:outline-none focus:ring-2 focus:ring-ayur-primary"
                                placeholder="you@example.com">
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-ayur-dark text-white px-6 py-3.5 rounded-xl font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg">
                        Send Verification Code
                    </button>
                </form>

                <form id="otpForm" class="space-y-6 hidden">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify_otp">
                    <input type="hidden" name="email" id="otpEmail">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Enter OTP</label>
                        <div class="flex justify-between gap-2">
                            {% for i in "123456" %}
                            <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]*"
                                class="otp-input w-12 h-12 text-center border border-gray-200 rounded-xl text-lg font-bold focus:outline-none focus:ring-2 focus:ring-ayur-primary" />
                            {% endfor %}
                        </div>
                        <input type="hidden" name="otp" id="otpValue">
                        <p class="text-xs text-gray-500 mt-2">Check your email for the 6-digit code.</p>
                        <p id="otpTimer" class="text-xs font-semibold text-amber-700 mt-1"></p>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" id="verifyOtpBtn"
                            class="flex-1 bg-ayur-dark text-white px-6 py-3.5 rounded-xl font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg">
                            Verify Code
                        </button>
                        <button type="button" id="resendBtn"
                            class="flex-1 bg-white border-2 border-gray-300 text-gray-700 px-6 py-3.5 rounded-xl font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all">
                            Resend
                        </button>
                    </div>
                </form>

                <form id="resetForm" class="space-y-6 hidden">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reset_password">
                    <input type="hidden" name="email" id="resetEmail">
                    <input type="hidden" name="otp" id="resetOtp">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">New Password</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-gray-400"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" name="password1" required
                                class="w-full rounded-xl border border-gray-200 px-10 py-3.5 focus:outline-none focus:ring-2 focus:ring-ayur-primary"
                                placeholder="Enter new password">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Confirm Password</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-gray-400"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" name="password2" required
                                class="w-full rounded-xl border border-gray-200 px-10 py-3.5 focus:outline-none focus:ring-2 focus:ring-ayur-primary"
                                placeholder="Confirm new password">
                        </div>
                        <p class="text-[11px] text-gray-500 mt-2">Use a strong password for better security.</p>
                    </div>
                    <button type="submit"
                        class="w-full bg-ayur-dark text-white px-6 py-3.5 rounded-xl font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg">
                        Reset Password
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const emailForm = document.getElementById('emailForm');
    const otpForm = document.getElementById('otpForm');
    const resetForm = document.getElementById('resetForm');

    const otpInputs = document.querySelectorAll('.otp-input');
    const otpValue = document.getElementById('otpValue');
    const otpTimer = document.getElementById('otpTimer');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendBtn = document.getElementById('resendBtn');

    const toast = document.getElementById('toast');

    const stepCircle1 = document.getElementById('stepCircle1');
    const stepCircle2 = document.getElementById('stepCircle2');
    const stepCircle3 = document.getElementById('stepCircle3');
    const stepLabel1 = document.getElementById('stepLabel1');
    const stepLabel2 = document.getElementById('stepLabel2');
    const stepLabel3 = document.getElementById('stepLabel3');
    const stepBar1 = document.getElementById('stepBar1');
    const stepBar2 = document.getElementById('stepBar2');
    let otpTimerInterval = null;

    function startOtpTimer(expiresAt) {
        const expiryTs = Number(expiresAt || 0);
        if (!otpTimer || !expiryTs) return;

        if (otpTimerInterval) {
            clearInterval(otpTimerInterval);
        }

        function tick() {
            const now = Math.floor(Date.now() / 1000);
            const remaining = Math.max(0, expiryTs - now);
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;

            if (remaining <= 0) {
                otpTimer.textContent = 'OTP expired. Please resend.';
                verifyOtpBtn.disabled = true;
                verifyOtpBtn.classList.add('opacity-60', 'cursor-not-allowed');
                resendBtn.disabled = false;
                resendBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                clearInterval(otpTimerInterval);
                return;
            }

            otpTimer.textContent = `Expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            resendBtn.disabled = true;
            resendBtn.classList.add('opacity-60', 'cursor-not-allowed');
        }

        tick();
        otpTimerInterval = setInterval(tick, 1000);
    }

    function showMessage(message, type = 'success') {
        toast.classList.remove('hidden');
        toast.classList.remove('bg-green-50', 'text-green-700', 'border-green-200');
        toast.classList.remove('bg-red-50', 'text-red-700', 'border-red-200');

        if (type === 'success') {
            toast.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
        } else {
            toast.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
        }
        toast.textContent = message;
    }

    function activatePanel(panel) {
        [emailForm, otpForm, resetForm].forEach(p => {
            p.classList.add('hidden');
            p.classList.remove('animate-fadeInUp');
        });
        panel.classList.remove('hidden');
        panel.classList.add('animate-fadeInUp');
    }

    function updateSteps(step) {
        if (step === 1) {
            stepCircle1.classList.add('bg-ayur-dark', 'text-white');
            stepCircle2.classList.remove('bg-ayur-dark', 'text-white');
            stepCircle3.classList.remove('bg-ayur-dark', 'text-white');
            stepCircle2.classList.add('bg-gray-200', 'text-gray-500');
            stepCircle3.classList.add('bg-gray-200', 'text-gray-500');
            stepLabel1.classList.add('text-ayur-dark');
            stepLabel2.classList.remove('text-ayur-dark');
            stepLabel3.classList.remove('text-ayur-dark');
            stepLabel2.classList.add('text-gray-500');
            stepLabel3.classList.add('text-gray-500');
            stepBar1.style.width = '33%';
            stepBar2.style.width = '0%';
        }
        if (step === 2) {
            stepCircle2.classList.remove('bg-gray-200', 'text-gray-500');
            stepCircle2.classList.add('bg-ayur-dark', 'text-white');
            stepLabel2.classList.remove('text-gray-500');
            stepLabel2.classList.add('text-ayur-dark');
            stepBar1.style.width = '100%';
            stepBar2.style.width = '33%';
        }
        if (step === 3) {
            stepCircle3.classList.remove('bg-gray-200', 'text-gray-500');
            stepCircle3.classList.add('bg-ayur-dark', 'text-white');
            stepLabel3.classList.remove('text-gray-500');
            stepLabel3.classList.add('text-ayur-dark');
            stepBar2.style.width = '100%';
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function postForgotPassword(formData) {
        try {
            const response = await fetch(window.location.pathname, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                return { success: false, message: 'Server error. Please refresh and try again.' };
            }

            const data = await response.json();
            if (!response.ok) {
                return { success: false, message: data.message || 'Request failed. Please try again.' };
            }
            return data;
        } catch (error) {
            return { success: false, message: 'Network error. Please check your connection and try again.' };
        }
    }

    otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            if (value && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
            otpValue.value = Array.from(otpInputs).map(i => i.value).join('');
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });
    });

    otpInputs[0].addEventListener('paste', (e) => {
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = paste.replace(/\D/g, '').slice(0, 6).split('');
        digits.forEach((d, i) => {
            if (otpInputs[i]) otpInputs[i].value = d;
        });
        otpValue.value = Array.from(otpInputs).map(i => i.value).join('');
    });

    emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(emailForm);
        const data = await postForgotPassword(formData);
        if (data.success) {
            showMessage(data.message, 'success');
            document.getElementById('otpEmail').value = document.getElementById('emailInput').value;
            activatePanel(otpForm);
            updateSteps(2);
            startOtpTimer(data.expires_at);
            otpInputs[0].focus();
        } else {
            showMessage(data.message, 'error');
        }
    });

    otpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(otpForm);
        const data = await postForgotPassword(formData);
        if (data.success) {
            showMessage(data.message, 'success');
            document.getElementById('resetEmail').value = document.getElementById('otpEmail').value;
            document.getElementById('resetOtp').value = document.getElementById('otpValue').value;
            activatePanel(resetForm);
            updateSteps(3);
        } else {
            showMessage(data.message, 'error');
        }
    });

    resetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(resetForm);
        const data = await postForgotPassword(formData);
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => {
                window.location.href = "{% url 'login' %}";
            }, 1500);
        } else {
            showMessage(data.message, 'error');
        }
    });

    document.getElementById('resendBtn').addEventListener('click', async () => {
        resendBtn.disabled = true;
        resendBtn.classList.add('opacity-60', 'cursor-not-allowed');
        const email = document.getElementById('otpEmail').value;
        const formData = new FormData();
        formData.append('action', 'send_otp');
        formData.append('email', email);
        const data = await postForgotPassword(formData);
        if (data.success) {
            showMessage('A new code has been sent.', 'success');
            otpInputs.forEach(i => i.value = '');
            otpValue.value = '';
            startOtpTimer(data.expires_at);
            otpInputs[0].focus();
        } else {
            resendBtn.disabled = false;
            resendBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            showMessage(data.message, 'error');
        }
    });
</script>
{% endblock %}
