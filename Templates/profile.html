{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile | SkinCraft{% endblock %}

{% block extra_head %}
<style>
    /* 1. Tab Animations */
    .tab-content {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 1;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 2. Sidebar Navigation */
    .nav-btn {
        transition: all 0.2s;
        border-radius: 0.5rem;
        color: #4B5563;
    }

    .nav-btn:hover {
        background-color: #F3F4F6;
        color: #1A3C34;
    }

    /* Active State - Matches your image (Green background, dark text) */
    .nav-btn.active {
        background-color: #E8F3E8;
        color: #1A3C34;
        font-weight: 700;
        border-left: 4px solid #1A3C34;
    }

    /* 3. Inputs */
    .custom-input {
        width: 100%;
        padding: 0.75rem;
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        outline: none;
        transition: 0.3s;
        font-size: 0.9rem;
    }

    .custom-input:focus {
        border-color: #D4AF37;
        background: #FFFFFF;
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    /* 4. Address Button Visibility Fix */
    button[onclick*="editAddress"],
    button[onclick*="deleteAddress"] {
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-stone-50 py-10">
    <div class="container mx-auto px-4 max-w-6xl">

        <div class="mb-8">
            <h1 class="font-serif text-3xl font-bold text-ayur-dark">My Dashboard</h1>
            <p class="text-sm text-gray-500 mt-1">Manage your account and preferences.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden sticky top-24">

                    <div class="bg-ayur-dark p-6 text-center text-white relative">
                        <div class="relative w-24 h-24 mx-auto mb-3">
                            <div
                                class="w-full h-full rounded-full border-4 border-white/20 shadow-lg overflow-hidden bg-white">
                                {% if user.profile_image and user.profile_image.url != '/media/default.jpg' %}
                                <img src="{{ user.profile_image.url }}" class="w-full h-full object-cover">
                                {% else %}
                                <div
                                    class="w-full h-full flex items-center justify-center text-3xl font-bold text-white bg-gradient-to-br from-ayur-gold via-amber-400 to-orange-500">
                                    {{ user.first_name|first|upper|default:user.username|first|upper }}
                                </div>
                                {% endif %}
                            </div>
                            <!-- Upload Button (Only show in Edit Profile tab) -->
                            <button id="profileImageActionBtn"
                                data-has-image="{% if user.profile_image and user.profile_image.url != '/media/default.jpg' %}true{% else %}false{% endif %}"
                                class="absolute bottom-0 right-0 bg-ayur-gold text-ayur-dark w-7 h-7 rounded-full flex items-center justify-center shadow-md hover:bg-white transition-colors cursor-pointer border-2 border-ayur-dark hidden"
                                title="{% if user.profile_image and user.profile_image.url != '/media/default.jpg' %}Remove profile picture{% else %}Upload profile picture{% endif %}">
                                {% if user.profile_image and user.profile_image.url != '/media/default.jpg' %}
                                <i class="fa-solid fa-trash-can text-[10px]"></i>
                                {% else %}
                                <i class="fa-solid fa-camera text-[10px]"></i>
                                {% endif %}
                            </button>
                        </div>
                        <h2 class="font-serif text-lg font-bold tracking-wide">{{ user.first_name }} {{ user.last_name }}</h2>
                        <p class="text-xs opacity-70 mt-1">{{ user.email }}</p>
                    </div>

                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-stone-50">
                        <span class="text-xs font-bold text-gray-600">Default Profile Photo</span>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer">
                            <div
                                class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-ayur-primary">
                            </div>
                        </label>
                    </div>

                    <nav class="p-3 space-y-1 bg-white">
                        <button onclick="switchTab('edit')" id="btn-edit"
                            class="nav-btn w-full text-left px-4 py-3 flex items-center gap-3">
                            <i class="fa-regular fa-id-card w-5 text-center"></i> Edit Profile
                        </button>
                        <button onclick="switchTab('orders')" id="btn-orders"
                            class="nav-btn w-full text-left px-4 py-3 flex items-center gap-3">
                            <i class="fa-solid fa-box-open w-5 text-center"></i> My Orders
                        </button>
                        <button onclick="switchTab('bank')" id="btn-bank"
                            class="nav-btn w-full text-left px-4 py-3 flex items-center gap-3">
                            <i class="fa-solid fa-building-columns w-5 text-center"></i> Bank Details
                        </button>
                        <button onclick="switchTab('address')" id="btn-address"
                            class="nav-btn w-full text-left px-4 py-3 flex items-center gap-3">
                            <i class="fa-solid fa-map-location-dot w-5 text-center"></i> Addresses
                        </button>
                        <button onclick="switchTab('security')" id="btn-security"
                            class="nav-btn w-full text-left px-4 py-3 flex items-center gap-3">
                            <i class="fa-solid fa-lock w-5 text-center"></i> Security
                        </button>
                        <div class="h-px bg-gray-100 my-2"></div>
                        <a href="{% url 'logout' %}"
                            class="nav-btn w-full text-left px-4 py-3 flex items-center gap-3 text-red-500 hover:text-red-600 hover:bg-red-50">
                            <i class="fa-solid fa-arrow-right-from-bracket w-5 text-center"></i> Logout
                        </a>
                    </nav>

                </div>
            </div>

            <div class="lg:col-span-3">

                {% if messages %}
                {% for message in messages %}
                <div class="mb-6 px-4 py-3 rounded-lg text-sm flex items-center gap-3 shadow-sm
                        {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200
                        {% else %}bg-red-50 text-red-800 border border-red-200{% endif %}">
                    <i class="fa-solid fa-circle-info"></i> {{ message }}
                </div>
                {% endfor %}
                {% endif %}

                <div id="tab-edit" class="tab-content bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-serif text-2xl text-ayur-dark font-bold mb-6 border-b border-gray-100 pb-4">Personal
                        Details</h3>

                    <form method="POST" enctype="multipart/form-data" class="space-y-6">
                        {% csrf_token %}
                        <input type="hidden" name="update_profile" value="1">
                        <div class="hidden">{{ user_form.profile_image }}</div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">First Name</label>
                                {{ user_form.first_name }}
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Last Name</label>
                                {{ user_form.last_name }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Email
                                    Address</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-400"><i
                                            class="fa-regular fa-envelope"></i></span>
                                    {{ user_form.email }}
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Phone Number</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-400"><i
                                            class="fa-solid fa-phone"></i></span>
                                    {{ user_form.phone }}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Date of
                                    Birth</label>
                                {{ user_form.date_of_birth }}
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Gender</label>
                                <div class="relative">
                                    {{ user_form.gender }}
                                    <i
                                        class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 text-right">
                            <button type="submit"
                                class="bg-ayur-dark text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg hover:shadow-ayur-primary/30">Save
                                Changes</button>
                        </div>
                    </form>
                </div>

                <div id="tab-orders" class="tab-content bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-8 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="font-serif text-2xl text-ayur-dark font-bold">My Orders</h3>
                            <p class="text-xs text-gray-500 mt-1">Track and manage your orders</p>
                        </div>
                    </div>
                    {% if orders %}
                    <div class="space-y-6">
                        {% for order in orders %}
                        <div
                            class="border-2 {% if order.id|add:0|divisibleby:2 %}border-gray-200{% else %}border-gray-200{% endif %} rounded-2xl overflow-hidden hover:shadow-lg transition-all duration-300">
                            <!-- Order Header -->
                            <div class="bg-stone-50 px-6 py-4 flex items-center justify-between cursor-pointer hover:bg-stone-100 transition-colors"
                                onclick="toggleOrderDetails({{ order.id }})">
                                <div class="flex items-center gap-6">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-ayur-dark text-sm">#{{ order.order_number }}</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">{{ order.created_at|date:"M d, Y" }}</p>
                                    </div>
                                    <div class="hidden md:block">
                                        <p class="text-xs text-gray-500 uppercase font-bold">Customer</p>
                                        <p class="text-sm font-medium text-gray-800">{{ order.full_name }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase font-bold">Total Price</p>
                                        <p class="text-sm font-bold text-ayur-dark">₹{{ order.total_amount|floatformat:2 }}</p>
                                        <p class="text-xs text-gray-400">{{ order.items.count }} item{% if order.items.count > 1 %}s{% endif %}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider
                                            {% if order.status == 'Delivered' %}bg-green-100 text-green-700
                                            {% elif order.status == 'Cancelled' %}bg-red-100 text-red-700
                                            {% elif order.status == 'Shipped' %}bg-blue-100 text-blue-700
                                            {% else %}bg-amber-100 text-amber-700{% endif %}">
                                        {{ order.status }}
                                    </span>
                                    <i
                                        class="fa-solid fa-chevron-down text-gray-400 transition-transform order-chevron-{{ order.id }}"></i>
                                </div>
                            </div>

                            <!-- Order Details (Hidden by default) -->
                            <div id="order-details-{{ order.id }}" class="hidden border-t border-gray-200">
                                <!-- Order Status Tracker -->
                                <div class="bg-white px-8 py-6 border-b border-gray-100">
                                    <div class="flex items-center justify-between relative">
                                        <!-- Progress Line -->
                                        <div class="absolute top-5 left-0 right-0 h-1 bg-gray-200 z-0">
                                            <div class="h-full bg-green-500 transition-all duration-500"
                                                style="width: {% if order.status == 'Delivered' %}100%{% elif order.status == 'Shipped' or order.status == 'On Way' %}66%{% elif order.status == 'Pending' %}33%{% else %}0%{% endif %}">
                                            </div>
                                        </div>

                                        <!-- Status Steps -->
                                        <div class="flex-1 text-center relative z-10">
                                            <div
                                                class="w-10 h-10 mx-auto rounded-full {% if order.status in 'Pending,Shipped,On Way,Delivered' %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %} flex items-center justify-center mb-2 border-4 border-white shadow-md">
                                                <i class="fa-solid fa-check text-sm"></i>
                                            </div>
                                            <p class="text-xs font-bold text-gray-700">Ordered</p>
                                        </div>
                                        <div class="flex-1 text-center relative z-10">
                                            <div
                                                class="w-10 h-10 mx-auto rounded-full {% if order.status in 'Shipped,On Way,Delivered' %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %} flex items-center justify-center mb-2 border-4 border-white shadow-md">
                                                <i class="fa-solid fa-box text-sm"></i>
                                            </div>
                                            <p class="text-xs font-bold text-gray-700">Shipped</p>
                                        </div>
                                        <div class="flex-1 text-center relative z-10">
                                            <div
                                                class="w-10 h-10 mx-auto rounded-full {% if order.status in 'On Way,Delivered' %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %} flex items-center justify-center mb-2 border-4 border-white shadow-md">
                                                <i class="fa-solid fa-truck text-sm"></i>
                                            </div>
                                            <p class="text-xs font-bold text-gray-700">On Way</p>
                                        </div>
                                        <div class="flex-1 text-center relative z-10">
                                            <div
                                                class="w-10 h-10 mx-auto rounded-full {% if order.status == 'Delivered' %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-500{% endif %} flex items-center justify-center mb-2 border-4 border-white shadow-md">
                                                <i class="fa-solid fa-house text-sm"></i>
                                            </div>
                                            <p class="text-xs font-bold text-gray-700">Delivered</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Items -->
                                <div class="px-6 py-4 bg-white">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-4">Items Ordered</h4>
                                    <div class="space-y-3">
                                        {% for item in order.items.all %}
                                        <div
                                            class="flex items-center gap-4 bg-stone-50 p-4 rounded-xl border border-gray-100 hover:border-gray-300 transition-all">
                                            <a href="{% url 'product_detail' item.product.id %}"
                                                class="w-16 h-16 bg-white rounded-lg overflow-hidden border border-gray-200 flex-shrink-0 hover:shadow-lg transition-shadow cursor-pointer block">
                                                {% if item.product.thumbnail %}
                                                <img src="{{ item.product.thumbnail.url }}"
                                                    alt="{{ item.product.name }}"
                                                    class="w-full h-full object-cover hover:scale-105 transition-transform">
                                                {% else %}
                                                <div
                                                    class="w-full h-full flex items-center justify-center text-gray-300">
                                                    <i class="fa-solid fa-image"></i>
                                                </div>
                                                {% endif %}
                                            </a>
                                            <div class="flex-1">
                                                <a href="{% url 'product_detail' item.product.id %}"
                                                    class="font-bold text-gray-800 text-sm hover:text-ayur-dark transition-colors block">{{ item.product.name }}</a>
                                                <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                                                    <p class="text-xs text-ayur-primary font-semibold">{{ item.product.category.name }}</p>
                                                    <span class="text-gray-400">•</span>
                                                    <p class="text-xs text-gray-600">{{ item.variant.unit_value }}{{ item.variant.unit_type }}</p>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">{{ item.product.sku }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold text-ayur-dark text-lg">₹{{ item.variant.price|floatformat:2 }}</p>
                                                <p class="text-xs text-gray-400 mt-1">per unit</p>
                                                <p class="text-xs text-gray-500 mt-2">x{{ item.quantity }}</p>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Compact Shipping & Delivery Status -->
                                <div class="px-6 py-4 border-t border-gray-200 bg-white">
                                    <div class="grid grid-cols-2 gap-4">
                                        <!-- Left: Shipping Details (Compact) -->
                                        <div>
                                            <p class="text-xs font-bold text-gray-400 uppercase mb-2">Shipping Details</p>
                                            <p class="text-xs text-gray-800 leading-relaxed">{{ order.street_address }}<br>{{ order.city }}, {{ order.state }} - {{ order.zip_code }}<br>Phone: {{ order.phone }}</p>
                                        </div>

                                        <!-- Right: Delivery Status (Compact) -->
                                        <div>
                                            {% if order.status == 'Shipped' and order.assigned_to %}
                                            <!-- Shipped - Delivery Partner Assigned -->
                                            <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                                                <p class="text-xs font-bold text-purple-900 mb-2">
                                                    <i class="fa-solid fa-check-circle text-purple-600 mr-1"></i>Delivery Partner Assigned
                                                </p>
                                                <p class="text-xs text-gray-800 mb-1">
                                                    <i class="fa-solid fa-user-tie text-purple-600 mr-1"></i>
                                                    <strong>{{ order.assigned_to.get_full_name }}</strong>
                                                </p>
                                                <p class="text-xs text-purple-600 font-semibold">
                                                    <i class="fa-solid fa-phone text-purple-600 mr-1"></i>{{ order.assigned_to.phone }}
                                                </p>
                                                {% if order.assigned_to.delivery_profile %}
                                                <p class="text-xs text-gray-600 mt-1">
                                                    <i class="fa-solid fa-motorcycle text-purple-600 mr-1"></i>
                                                    {{ order.assigned_to.delivery_profile.vehicle_type }} - {{ order.assigned_to.delivery_profile.vehicle_number }}
                                                </p>
                                                <p class="text-xs text-gray-500 mt-2 italic">
                                                    <i class="fa-solid fa-box text-purple-600 mr-1"></i>Preparing for pickup
                                                </p>
                                                {% endif %}
                                            </div>
                                            {% elif order.status == 'On Way' and order.assigned_to %}
                                            <!-- Out for Delivery -->
                                            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                                <p class="text-xs font-bold text-blue-900 mb-2">Out for Delivery</p>
                                                <p class="text-xs text-gray-800 mb-1"><i class="fa-solid fa-user-tie text-blue-600 mr-1"></i><strong>{{ order.assigned_to.get_full_name }}</strong></p>
                                                <p class="text-xs text-blue-600 font-semibold"><i class="fa-solid fa-phone text-blue-600 mr-1"></i>{{ order.assigned_to.phone }}</p>
                                                {% if order.assigned_to.delivery_profile %}
                                                <p class="text-xs text-gray-600 mt-1"><i class="fa-solid fa-motorcycle text-blue-600 mr-1"></i>{{ order.assigned_to.delivery_profile.vehicle_type }} - {{ order.assigned_to.delivery_profile.vehicle_number }}</p>
                                                {% endif %}
                                            </div>
                                            {% elif order.status == 'Delivered' %}
                                            <!-- Delivered -->
                                            <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                                                <p class="text-xs font-bold text-green-900">Delivered</p>
                                                {% if order.delivered_at %}
                                                <p class="text-xs text-gray-700 mt-1">{{ order.delivered_at|date:"M d, Y" }}</p>
                                                {% endif %}
                                            </div>
                                            {% else %}
                                            <!-- Other Status -->
                                            <div class="bg-amber-50 rounded-lg p-3 border border-amber-200">
                                                <p class="text-xs font-bold text-amber-900">{{ order.status }}</p>
                                            </div>
                                            {% endif %}

                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-center gap-3 flex-wrap">
                                    {% if order.status in 'Pending,Shipped' %}
                                    <button type="button"
                                        onclick="openCancelOrderModal(this)"
                                        data-cancel-url="{% url 'cancel_order' order.id %}"
                                        data-order-number="{{ order.order_number }}"
                                        class="px-6 py-2 bg-red-500 text-white rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-red-600 transition-all flex items-center gap-2 shadow-sm hover:shadow-md">
                                        <i class="fa-solid fa-times-circle"></i> Cancel Order
                                    </button>
                                    {% endif %}
                                    {% if order.status == 'Delivered' %}
                                    <button onclick="openReviewModal({{ order.id }})"
                                        class="px-6 py-2 bg-ayur-primary text-white rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-ayur-dark transition-all flex items-center gap-2 shadow-sm hover:shadow-md">
                                        <i class="fa-solid fa-star"></i> Review
                                    </button>
                                    {% if order.assigned_to and order.assigned_to.delivery_profile %}
                                    <button
                                        onclick="openDeliveryReviewModal(this)"
                                        data-order-id="{{ order.id }}"
                                        data-partner="{{ order.assigned_to.get_full_name|default:order.assigned_to.username }}"
                                        data-rating="{{ order.delivery_partner_review.rating|default:'' }}"
                                        data-comment="{{ order.delivery_partner_review.comment|default:''|escapejs }}"
                                        class="px-6 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-black transition-all flex items-center gap-2 shadow-sm hover:shadow-md">
                                        <i class="fa-solid fa-truck"></i> Rate Delivery
                                    </button>
                                    {% endif %}
                                    {% if not order.return_request %}
                                    <button onclick="openReturnModal({{ order.id }}, '{{ order.order_number }}')"
                                        class="px-6 py-2 bg-red-500 text-white rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-red-600 transition-all flex items-center gap-2 shadow-sm hover:shadow-md">
                                        <i class="fa-solid fa-undo"></i> Return
                                    </button>
                                    {% endif %}
                                    {% endif %}
                                    {% if order.return_request %}
                                    <div class="px-6 py-2 {% if order.return_request.status == 'Completed' %}bg-green-100 border-green-300{% else %}bg-orange-100 border-orange-300{% endif %} border rounded-lg text-xs font-bold uppercase tracking-wider flex flex-col gap-1">
                                        <span class="{% if order.return_request.status == 'Completed' %}text-green-800{% else %}text-orange-800{% endif %} flex items-center gap-2">
                                            {% if order.return_request.status == 'Completed' %}
                                            <i class="fa-solid fa-check-circle"></i> Return Completed
                                            {% else %}
                                            <i class="fa-solid fa-clock"></i> Return {{ order.return_request.status }}
                                            {% endif %}
                                        </span>
                                        
                                        {% if order.return_request.status == 'Completed' %}
                                        <div class="mt-2">
                                            <button type="button" onclick="openRefundStatusModal({{ order.id }}, 'refund')"
                                                class="px-4 py-2 bg-white border border-green-300 text-green-800 rounded-lg text-[10px] font-bold uppercase tracking-wider hover:bg-green-50 transition-all flex items-center gap-2">
                                                <i class="fa-solid fa-receipt"></i> Refund Status
                                            </button>

                                            {% with refund_record=order.return_request.refund_record %}
                                            <div id="refund-status-{{ order.id }}" class="hidden">
                                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                                                    <p class="text-green-900 font-bold text-xs mb-1">
                                                        <i class="fa-solid fa-box-open"></i> Pickup Completed
                                                    </p>
                                                    <p class="text-green-800 text-xs">
                                                        <i class="fa-solid fa-calendar-check"></i> {{ order.return_request.picked_up_at|date:"M d, Y - h:i A" }}
                                                    </p>
                                                    <p class="text-green-700 text-xs mt-1">
                                                        <i class="fa-solid fa-user-check"></i> By: {{ order.return_request.assigned_to.get_full_name }}
                                                    </p>
                                                </div>
                                                {% if refund_record %}
                                                <div class="bg-green-100 border-2 border-green-400 p-3 rounded-lg">
                                                    <p class="text-green-900 font-bold text-xs mb-1 flex items-center gap-2">
                                                        <i class="fa-solid fa-check-double"></i> REFUND {{ refund_record.status|upper }}
                                                    </p>
                                                    <p class="text-green-800 text-xs font-semibold">
                                                        <i class="fa-solid fa-money-bill-wave"></i> Amount: &#8377;{{ refund_record.amount }}
                                                    </p>
                                                    <p class="text-green-700 text-xs mt-1">
                                                        <i class="fa-solid fa-info-circle"></i> Processed: {{ refund_record.processed_at|default:"Pending" }}
                                                    </p>
                                                    <p class="text-green-700 text-xs mt-1">
                                                        <i class="fa-solid fa-user-shield"></i> Refunded By: {{ refund_record.processed_by.get_full_name|default:refund_record.processed_by.username|default:"Admin" }}
                                                    </p>
                                                    <p class="text-green-700 text-xs mt-1">
                                                        <i class="fa-solid fa-credit-card"></i> Method: {{ order.payment_method|default:"COD" }}
                                                    </p>
                                                    {% if order.payment_method == 'Razorpay' and order.razorpay_payment_id %}
                                                    <p class="text-green-700 text-xs mt-1">
                                                        <i class="fa-solid fa-receipt"></i> Payment ID: {{ order.razorpay_payment_id }}
                                                    </p>
                                                    {% elif order.payment_method == 'COD' %}
                                                    {% if order.user and order.user.bank_details %}
                                                    <div class="mt-2 bg-white border border-green-200 rounded-lg p-2 text-xs text-green-800">
                                                        <div class="font-semibold mb-1"><i class="fa-solid fa-building-columns"></i> Bank Transfer Details</div>
                                                        <div>Account Holder: {{ order.user.bank_details.account_holder_name }}</div>
                                                        <div>Bank: {{ order.user.bank_details.bank_name }}</div>
                                                        <div>Account: ****{{ order.user.bank_details.account_number|slice:"-4:" }}</div>
                                                        <div>IFSC: {{ order.user.bank_details.ifsc_code }}</div>
                                                        {% if order.user.bank_details.upi_id %}
                                                        <div>UPI: {{ order.user.bank_details.upi_id }}</div>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <p class="text-amber-700 text-xs mt-2">
                                                        <i class="fa-solid fa-info-circle"></i> Bank details not available.
                                                    </p>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% else %}
                                                <div class="bg-amber-50 border border-amber-300 p-2 rounded">
                                                    <p class="text-amber-900 font-bold text-xs mb-1">
                                                        <i class="fa-solid fa-clock"></i> REFUND STATUS: Pending
                                                    </p>
                                                    <p class="text-amber-700 text-xs mt-1">
                                                        <i class="fa-solid fa-info-circle"></i> Refund will be processed soon.
                                                    </p>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endwith %}
                                        </div>
                                        
                                        {% elif order.return_request.status == 'Approved' %}
                                        <div class="mt-2 pt-2 border-t border-orange-200">
                                            <p class="text-orange-900 font-bold text-xs mb-1">
                                                <i class="fa-solid fa-circle-check"></i> Return Approved
                                            </p>
                                            {% if order.return_request.assigned_to %}
                                            <p class="text-orange-800 text-xs">
                                                <i class="fa-solid fa-user-tie"></i> Pickup Partner Assigned: {{ order.return_request.assigned_to.get_full_name }}
                                            </p>
                                            <p class="text-orange-700 text-xs">
                                                <i class="fa-solid fa-phone"></i> {{ order.return_request.assigned_to.phone }}
                                            </p>
                                            {% if order.return_request.assigned_to.delivery_profile %}
                                            <p class="text-orange-600 text-xs">
                                                <i class="fa-solid fa-motorcycle"></i> {{ order.return_request.assigned_to.delivery_profile.vehicle_type }} - {{ order.return_request.assigned_to.delivery_profile.vehicle_number }}
                                            </p>
                                            {% endif %}
                                            {% else %}
                                            <p class="text-orange-800 text-xs">
                                                <i class="fa-solid fa-clock"></i> Pickup partner will be assigned soon.
                                            </p>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    {% if order.status == 'Cancelled' %}
                                    <div class="w-full bg-red-50 border border-red-200 rounded-xl p-4 text-xs font-semibold text-red-900">
                                        <div class="flex items-center justify-between gap-3 flex-wrap">
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle-xmark"></i> Order Cancelled
                                            </div>
                                            {% if order.payment_status == 'Paid' or order.payment_status == 'Refunded' %}
                                            <button type="button" onclick="openRefundStatusModal({{ order.id }}, 'cancel')"
                                                class="px-3 py-2 bg-white border border-red-300 text-red-800 rounded-lg text-[10px] font-bold uppercase tracking-wider hover:bg-red-50 transition-all flex items-center gap-2">
                                                <i class="fa-solid fa-receipt"></i> Refund Status
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% if order.cancel_reason %}
                                        <div class="mt-2 text-red-800">
                                            Cancellation Reason: <span class="font-bold">{{ order.cancel_reason }}</span>
                                        </div>
                                        {% endif %}
                                        {% if order.payment_status == 'Paid' or order.payment_status == 'Refunded' %}
                                        <div id="cancel-refund-status-{{ order.id }}" class="hidden mt-3 bg-white border border-red-200 rounded-lg p-3 text-[11px] text-gray-700">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                <div>Product Total: <span class="font-bold text-gray-900">&#8377;{{ order.product_total|floatformat:2 }}</span></div>
                                                <div>Delivery Charges: <span class="font-bold text-gray-900">&#8377;{{ order.delivery_fee|default:0|floatformat:2 }}</span></div>
                                                {% if order.discount_amount and order.discount_amount > 0 %}
                                                <div>Coupon Discount: <span class="font-bold text-red-600">-&#8377;{{ order.discount_amount|floatformat:2 }}</span></div>
                                                {% endif %}
                                                <div class="md:col-span-2 text-green-700">
                                                    Refund Amount: <span class="font-bold">&#8377;{{ order.refund_amount|floatformat:2 }}</span>
                                                </div>
                                                <div>Payment Method: <span class="font-bold text-gray-900">{{ order.payment_method|default:"Online" }}</span></div>
                                                {% if order.razorpay_payment_id %}
                                                <div>Payment ID: <span class="font-bold text-gray-900">{{ order.razorpay_payment_id }}</span></div>
                                                {% endif %}
                                                <div>Refund Status: <span class="font-bold text-gray-900">{{ order.payment_status }}</span></div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="mt-2 text-red-700">
                                            Payment was not completed. No refund is applicable.
                                        </div>
                                    {% endif %}
                                    </div>
                                    {% endif %}
                                    <a href="{% url 'invoice_view' order.id %}" target="_blank"
                                        class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center gap-2 shadow-sm hover:shadow-md">
                                        <i class="fa-solid fa-file-invoice"></i> Invoice
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-16 border-2 border-dashed border-gray-200 rounded-2xl bg-stone-50">
                        <div
                            class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300 shadow-sm">
                            <i class="fa-solid fa-basket-shopping text-3xl"></i>
                        </div>
                        <h4 class="text-lg font-bold text-gray-700 mb-2">No orders yet</h4>
                        <p class="text-gray-500 mb-6">Start exploring our products and place your first order!</p>
                        <a href="{% url 'product' %}"
                            class="inline-flex items-center gap-2 bg-ayur-dark text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg">
                            <i class="fa-solid fa-shopping-bag"></i> Start Shopping
                        </a>
                    </div>
                    {% endif %}
                </div>

                <div id="tab-bank" class="tab-content bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="font-serif text-2xl text-ayur-dark font-bold">Bank Details</h3>
                            <p class="text-xs text-gray-500 mt-1">Add bank details for COD refund during returns.</p>
                        </div>
                    </div>
                    <form method="POST" class="space-y-4 max-w-xl">
                        {% csrf_token %}
                        <input type="hidden" name="save_bank_details" value="1">
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-user"></i></span>
                            {{ bank_form.account_holder_name }}
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-building-columns"></i></span>
                            {{ bank_form.bank_name }}
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-hashtag"></i></span>
                            {{ bank_form.account_number }}
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-code"></i></span>
                            {{ bank_form.ifsc_code }}
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-qrcode"></i></span>
                            {{ bank_form.upi_id }}
                        </div>
                        <button type="submit"
                            class="bg-ayur-dark text-white px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-ayur-primary transition-all">
                            Save Details
                        </button>
                    </form>
                </div>

                <div id="tab-address" class="tab-content bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-8 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="font-serif text-2xl text-ayur-dark font-bold">Address Book</h3>
                            <p class="text-xs text-gray-500 mt-1">Manage your delivery addresses</p>
                        </div>
                        <button type="button" onclick="location.href='{% url 'profile' %}?tab=address'"
                            class="bg-ayur-dark text-white px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-ayur-primary transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add New
                        </button>
                    </div>

                    {% if addresses %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        {% for addr in addresses %}
                        <div class="p-6 border-2 rounded-xl relative overflow-visible
                            {% if addr.is_default %}border-ayur-gold bg-gradient-to-br from-amber-50 to-amber-50/50{% else %}border-gray-200 bg-white{% endif %}"
                            style="display: flex; flex-direction: column;">

                            {% if addr.is_default %}
                            <span
                                class="absolute top-4 right-4 text-[10px] bg-gradient-to-r from-ayur-gold to-yellow-500 text-white px-3 py-1 rounded-full font-bold uppercase shadow-md">Default</span>
                            {% endif %}

                            <div class="flex items-start gap-4 mb-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-gradient-to-br from-stone-100 to-stone-50 flex items-center justify-center text-ayur-dark text-xl flex-shrink-0">
                                    {% if addr.address_type == 'Home' %}
                                    <i class="fa-solid fa-house"></i>
                                    {% elif addr.address_type == 'Work' %}
                                    <i class="fa-solid fa-briefcase"></i>
                                    {% else %}
                                    <i class="fa-solid fa-location-dot"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <h5 class="font-bold text-gray-800 text-sm">{{ addr.address_type }}</h5>
                                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mt-0.5">
                                        Delivery Address</p>
                                </div>
                            </div>

                            <div class="bg-white/50 rounded-lg p-4 mb-4 space-y-2">
                                <p class="text-sm font-semibold text-gray-800">{{ user.get_full_name }}</p>
                                <p class="text-sm text-gray-600">{{ addr.street_address }}</p>
                                <p class="text-sm text-gray-600">{{ addr.city }}, {{ addr.state }} - {{ addr.zip_code }}
                                </p>
                                {% if addr.phone_number %}
                                <p class="text-sm text-gray-600 flex items-center gap-2">
                                    <i class="fa-solid fa-phone text-xs text-gray-400"></i>{{ addr.phone_number }}
                                </p>
                                {% endif %}
                            </div>

                            <div
                                style="display: flex; gap: 0.75rem; padding-top: 1rem; border-top: 1px solid #f3f4f6; margin-top: auto;">
                                <button type="button" onclick="editAddress({{ addr.id }})"
                                    style="flex: 1; padding: 0.5rem 0.75rem; background-color: rgba(26, 60, 52, 0.05); color: #1A3C34; border-radius: 0.5rem; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; cursor: pointer;">
                                    <i class="fa-solid fa-pen-to-square"></i> Edit
                                </button>
                                <button type="button" onclick="deleteAddress({{ addr.id }})"
                                    style="flex: 1; padding: 0.5rem 0.75rem; background-color: #fef2f2; color: #dc2626; border-radius: 0.5rem; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; cursor: pointer;">
                                    <i class="fa-solid fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div
                        class="text-center py-16 bg-gradient-to-br from-stone-50 to-stone-25 rounded-2xl border-2 border-dashed border-gray-200 mb-8">
                        <div
                            class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300">
                            <i class="fa-solid fa-map-location-dot text-2xl"></i>
                        </div>
                        <p class="text-gray-500 font-medium">No addresses saved yet</p>
                        <p class="text-gray-400 text-sm mt-1">Add your first delivery address to get started</p>
                    </div>
                    {% endif %}

                    {% if edit_address_id %}
                    <div
                        class="bg-gradient-to-r from-blue-50 to-blue-50/50 p-6 rounded-xl border border-blue-200 mb-8 flex items-center gap-3">
                        <i class="fa-solid fa-info-circle text-blue-600"></i>
                        <p class="text-sm text-blue-800"><span class="font-bold">Editing Address:</span> Make changes
                            below and click "Update Address" to save.</p>
                    </div>
                    {% endif %}

                    <div class="bg-stone-50 p-8 rounded-xl border border-gray-200">
                        <h4
                            class="font-bold text-gray-800 mb-6 text-sm uppercase flex items-center gap-2 tracking-wider">
                            <i
                                class="fa-solid fa-{% if edit_address_id %}pen-to-square{% else %}plus-circle{% endif %} text-ayur-primary"></i>
                            {% if edit_address_id %}Edit Address{% else %}Add New Address{% endif %}
                        </h4>

                        <form method="POST" class="space-y-6" id="addressForm">
                            {% csrf_token %}
                            <input type="hidden" name="add_address" value="1">
                            {% if edit_address_id %}<input type="hidden" name="address_id"
                                value="{{ edit_address_id }}">{% endif %}

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Address
                                        Type</label>
                                    <div class="relative">
                                        <select name="address_type" class="custom-input appearance-none font-medium"
                                            required>
                                            {% for value, label in address_choices %}
                                            <option value="{{ value }}" {% if address_form.address_type.value == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        <i
                                            class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                                    </div>
                                </div>

                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Street
                                        Address</label>
                                    <input type="text" name="street_address" required class="custom-input"
                                        placeholder="House No, Street, Area"
                                        value="{{ address_form.street_address.value|default:'' }}">
                                </div>

                                <div>
                                    <label
                                        class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">City</label>
                                    <input type="text" name="city" id="address-city" required class="custom-input" placeholder="City"
                                        value="{{ address_form.city.value|default:'Surat' }}" readonly>
                                </div>

                                <div>
                                    <label
                                        class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">State</label>
                                    <input type="text" name="state" id="address-state" required class="custom-input" placeholder="State"
                                        value="{{ address_form.state.value|default:'Gujarat' }}" readonly>
                                </div>

                                <div>
                                    <label
                                        class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Zip
                                        Code</label>
                                    <input type="text" name="zip_code" id="address-zip" required class="custom-input"
                                        placeholder="Pincode" value="{{ address_form.zip_code.value|default:'' }}">
                                    <p id="pincodeStatus" class="mt-2 text-[10px] font-semibold text-stone-400 hidden"></p>
                                </div>

                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">Phone
                                        Number</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-3 text-gray-400"><i
                                                class="fa-solid fa-phone"></i></span>
                                        <input type="text" name="phone_number" class="custom-input pl-10"
                                            placeholder="Your phone number"
                                            value="{{ address_form.phone_number.value|default:'' }}">
                                    </div>
                                </div>
                            </div>

                            <div
                                class="bg-white rounded-lg p-4 flex items-center justify-between border border-gray-200">
                                <div>
                                    <label class="text-sm font-bold text-gray-700 uppercase tracking-wider">Set as
                                        default shipping address</label>
                                    <p class="text-xs text-gray-500 mt-0.5">This will be your primary delivery address
                                    </p>
                                </div>
                                <label class="inline-flex items-center cursor-pointer flex-shrink-0">
                                    <input type="checkbox" name="is_default" class="sr-only peer" {% if address_form.is_default.value %}checked{% endif %}>
                                    <div
                                        class="relative w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-ayur-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-ayur-primary">
                                    </div>
                                </label>
                            </div>

                            <div class="pt-4 border-t border-gray-200 flex gap-3">
                                {% if edit_address_id %}
                                <button type="submit"
                                    class="flex-1 bg-ayur-dark text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg hover:shadow-ayur-primary/30 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-check"></i> Update Address
                                </button>
                                <button type="button" onclick="location.href='{% url 'profile' %}?tab=address'"
                                    class="flex-1 bg-white border-2 border-gray-300 text-gray-600 px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-times"></i> Cancel
                                </button>
                                {% else %}
                                <button type="submit"
                                    class="flex-1 bg-ayur-dark text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg hover:shadow-ayur-primary/30 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Add Address
                                </button>
                                <button type="reset"
                                    class="flex-1 bg-white border-2 border-gray-300 text-gray-600 px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-redo"></i> Clear
                                </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
                <div id="tab-security" class="tab-content bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="font-serif text-2xl text-ayur-dark font-bold">Security</h3>
                            <p class="text-xs text-gray-500 mt-1">Manage your password and account security</p>
                        </div>
                        <a href="{% url 'forgot_password' %}" class="text-sm text-ayur-gold hover:text-ayur-dark transition-colors font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-key"></i> Forgot Password?
                        </a>
                    </div>

                    <form method="POST" class="max-w-lg space-y-6">
                        {% csrf_token %}
                        <input type="hidden" name="change_password" value="1">

                        {% for field in password_form %}
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-600 mb-2 tracking-wider">{{ field.label }}</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3.5 text-gray-400"><i
                                        class="fa-solid fa-lock text-xs"></i></span>
                                {{ field }}
                            </div>
                            {% if field.help_text %}
                            <p class="text-[10px] text-gray-400 mt-1">{{ field.help_text|striptags }}</p>
                            {% endif %}
                            {% if field.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <div class="pt-4 flex gap-3">
                            <button type="submit"
                                class="flex-1 bg-ayur-dark text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg hover:shadow-ayur-primary/30 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-check"></i> Update Password
                            </button>
                            <button type="reset"
                                class="flex-1 bg-white border-2 border-gray-300 text-gray-700 px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-redo"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-gradient-to-r from-ayur-dark to-ayur-primary p-6 text-white">
            <div class="flex items-center justify-between">
                <h3 class="font-serif text-2xl font-bold">Write Your Review</h3>
                <button onclick="closeReviewModal()"
                    class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-white/80 mt-2">Share your experience with our products</p>
        </div>

        <form id="reviewForm" method="POST" action="{% url 'submit_review' %}" class="p-6">
            {% csrf_token %}
            <input type="hidden" name="order_id" id="review_order_id">

            <!-- Product Reviews Section -->
            <div id="productReviewsContainer" class="space-y-6">
                <!-- Products will be dynamically loaded here -->
            </div>
            
            <div class="mt-8 flex gap-3">
                <button type="submit"
                    class="flex-1 bg-ayur-dark text-white px-8 py-4 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-ayur-primary transition-all shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Submit Reviews
                </button>
                <button type="button" onclick="closeReviewModal()"
                    class="flex-1 bg-white border-2 border-gray-300 text-gray-700 px-8 py-4 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delivery Partner Review Modal -->
<div id="deliveryReviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-gradient-to-r from-slate-900 to-slate-700 p-6 text-white">
            <div class="flex items-center justify-between">
                <h3 class="font-serif text-2xl font-bold">Rate Your Delivery</h3>
                <button onclick="closeDeliveryReviewModal()"
                    class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-white/80 mt-2" id="deliveryReviewPartner"></p>
        </div>

        <form id="deliveryReviewForm" method="POST" action="{% url 'submit_delivery_partner_review' %}" class="p-6 space-y-6">
            {% csrf_token %}
            <input type="hidden" name="order_id" id="delivery_review_order_id">

            <div>
                <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">Rating</label>
                <select name="rating" id="delivery_review_rating" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-slate-900 bg-white font-medium">
                    <option value="">Select rating</option>
                    <option value="5">5 - Excellent</option>
                    <option value="4">4 - Good</option>
                    <option value="3">3 - Average</option>
                    <option value="2">2 - Poor</option>
                    <option value="1">1 - Very Poor</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">Your Feedback</label>
                <textarea name="comment" id="delivery_review_comment" rows="4"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg resize-none focus:border-slate-900 focus:ring-2 focus:ring-slate-900/20 outline-none transition-all"
                    placeholder="Share your delivery experience..."></textarea>
            </div>

            <div class="mt-8 flex gap-3">
                <button type="submit"
                    class="flex-1 bg-slate-900 text-white px-8 py-4 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-black transition-all shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Submit Rating
                </button>
                <button type="button" onclick="closeDeliveryReviewModal()"
                    class="flex-1 bg-white border-2 border-gray-300 text-gray-700 px-8 py-4 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
            </div>
        </form>
</div>
</div>

<!-- Cancel Order Modal -->
<div id="cancelOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        <div class="sticky top-0 bg-gradient-to-r from-red-600 to-red-500 p-5 text-white">
            <div class="flex items-center justify-between">
                <h3 class="font-serif text-xl font-bold">Cancel Order</h3>
                <button type="button" onclick="closeCancelOrderModal()"
                    class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-white/80 mt-2">Please select the reason for cancellation.</p>
            <p id="cancelOrderModalNumber" class="text-xs text-white/80 mt-1"></p>
        </div>

        <form id="cancelOrderForm" method="POST" action="" class="p-6 space-y-5">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider">
                    <i class="fa-solid fa-circle-info text-red-500 mr-2"></i>Cancellation Reason
                </label>
                <select name="cancel_reason" id="cancelReasonSelect" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-500 bg-white font-medium">
                    <option value="">-- Select a reason --</option>
                    <option value="Changed Mind">Changed Mind</option>
                    <option value="Found Better Price">Found Better Price</option>
                    <option value="Ordered by Mistake">Ordered by Mistake</option>
                    <option value="Delivery Taking Too Long">Delivery Taking Too Long</option>
                    <option value="Address Issue">Address Issue</option>
                    <option value="Payment Concern">Payment Concern</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="mt-4 flex gap-3">
                <button type="submit"
                    class="flex-1 bg-red-500 text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-red-600 transition-all shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-times-circle"></i> Confirm Cancel
                </button>
                <button type="button" onclick="closeCancelOrderModal()"
                    class="flex-1 bg-white border-2 border-gray-300 text-gray-700 px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Refund Status Modal -->
<div id="refundStatusModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        <div class="sticky top-0 bg-gradient-to-r from-ayur-dark to-ayur-primary p-4 text-white flex items-center justify-between">
            <h3 class="font-serif text-xl font-bold">Refund Status</h3>
            <button type="button" onclick="closeRefundStatusModal()"
                class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-all flex items-center justify-center">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div id="refundStatusContent" class="p-6 text-sm text-gray-700">
            <!-- Filled dynamically -->
        </div>
    </div>
</div>

<!-- Return Modal -->
<div id="returnModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-gradient-to-r from-red-600 to-red-500 p-6 text-white">
            <div class="flex items-center justify-between">
                <h3 class="font-serif text-2xl font-bold">Request Return</h3>
                <button onclick="closeReturnModal()"
                    class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-white/80 mt-2" id="returnOrderNumber"></p>
        </div>

        <form id="returnForm" method="POST" action="{% url 'submit_return' %}" class="p-6 space-y-6">
            {% csrf_token %}
            <input type="hidden" name="order_id" id="return_order_id">

            <!-- Return Reason -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wider">
                    <i class="fa-solid fa-exclamation-circle text-red-500 mr-2"></i> Return Reason
                </label>
                <select name="reason" id="returnReason" required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-500 bg-white font-medium">
                    <option value="">-- Select a reason --</option>
                    <option value="Damaged">Damaged Product</option>
                    <option value="Wrong Item">Wrong Item Received</option>
                    <option value="Not as Described">Not as Described</option>
                    <option value="Quality Issue">Quality Issue</option>
                    <option value="Expired">Product Expired</option>
                    <option value="Missing Items">Missing Items</option>
                    <option value="Changed Mind">Changed Mind</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <!-- Additional Details -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wider">
                    <i class="fa-solid fa-pen-fancy text-gray-500 mr-2"></i> Additional Details
                </label>
                <textarea name="additional_details" id="returnDetails" placeholder="Please provide any additional information that might help us process your return..."
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-500 font-medium resize-none h-32"></textarea>
                <p class="text-xs text-gray-500 mt-2">Optional: Add photos or detailed explanation</p>
            </div>

            <!-- Submit Button -->
            <div class="mt-8 flex gap-3">
                <button type="submit"
                    class="flex-1 bg-red-500 text-white px-8 py-4 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-red-600 transition-all shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Submit Return Request
                </button>
                <button type="button" onclick="closeReturnModal()"
                    class="flex-1 bg-white border-2 border-gray-300 text-gray-700 px-8 py-4 rounded-lg font-bold text-sm uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function removeProfilePicture() {
        if (confirm('Are you sure you want to remove your profile picture? It will be replaced with your initial.')) {
            // Create a form to submit the removal request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'profile' %}';

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrfmiddlewaretoken';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            // Add remove_profile_image field
            const removeInput = document.createElement('input');
            removeInput.type = 'hidden';
            removeInput.name = 'remove_profile_image';
            removeInput.value = '1';
            form.appendChild(removeInput);

            // Submit the form
            document.body.appendChild(form);
            form.submit();
        }
    }

    function setProfileImageAction(action) {
        const actionBtn = document.getElementById('profileImageActionBtn');
        if (!actionBtn) return;

        if (action === 'delete') {
            actionBtn.title = 'Remove profile picture';
            actionBtn.innerHTML = '<i class="fa-solid fa-trash-can text-[10px]"></i>';
            actionBtn.dataset.action = 'delete';
        } else {
            actionBtn.title = 'Upload profile picture';
            actionBtn.innerHTML = '<i class="fa-solid fa-camera text-[10px]"></i>';
            actionBtn.dataset.action = 'camera';
        }
    }
    // check image size which have define in profile image 
    const MAX_PROFILE_IMAGE_SIZE_BYTES = 5 * 1024 * 1024;
    const MAX_PROFILE_IMAGE_SIZE_MB = 5;
    const ALLOWED_PROFILE_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    const ALLOWED_PROFILE_IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.webp', '.gif'];

    function validateProfileImageFile(file) {
        if (!file) return '';

        const fileType = (file.type || '').toLowerCase();
        const fileName = (file.name || '').toLowerCase();
        const hasValidType = ALLOWED_PROFILE_IMAGE_TYPES.includes(fileType);
        const hasValidExtension = ALLOWED_PROFILE_IMAGE_EXTENSIONS.some(ext => fileName.endsWith(ext));

        if (file.size > MAX_PROFILE_IMAGE_SIZE_BYTES) {
            return `Image is too large. Max allowed size is ${MAX_PROFILE_IMAGE_SIZE_MB}MB.`;
        }

        if (!hasValidType && !hasValidExtension) {
            return 'Only JPG, JPEG, PNG, WEBP, and GIF images are allowed. PDF files are not allowed.';
        }

        return '';
    }

    function setPincodeStatus(text, tone) {
        const statusEl = document.getElementById('pincodeStatus');
        if (!statusEl) return;
        statusEl.textContent = text;
        statusEl.classList.remove('hidden', 'text-red-500', 'text-emerald-600', 'text-stone-400');
        statusEl.classList.add(tone);
    }

    function clearPincodeStatus() {
        const statusEl = document.getElementById('pincodeStatus');
        if (!statusEl) return;
        statusEl.textContent = '';
        statusEl.classList.add('hidden');
    }

    const FIXED_CITY = 'Surat';
    const FIXED_STATE = 'Gujarat';

    function isSurat(value) {
        return (value || '').trim().toLowerCase() === FIXED_CITY.toLowerCase();
    }

    function setFixedCityState(cityInput, stateInput) {
        if (cityInput) {
            cityInput.value = FIXED_CITY;
            cityInput.readOnly = true;
        }
        if (stateInput) {
            stateInput.value = FIXED_STATE;
            stateInput.readOnly = true;
        }
    }

    function setupPincodeAutofill() {
        const zipInput = document.getElementById('address-zip');
        const cityInput = document.getElementById('address-city');
        const stateInput = document.getElementById('address-state');

        if (!zipInput || !cityInput || !stateInput) return;

        setFixedCityState(cityInput, stateInput);

        let lookupTimeout = null;

        const fetchPincode = (pin) => {
            setPincodeStatus('Checking pincode...', 'text-stone-400');
            fetch(`https://api.postalpincode.in/pincode/${pin}`)
                .then(res => res.json())
                .then(data => {
                    if (!Array.isArray(data) || !data[0] || data[0].Status !== 'Success') {
                        zipInput.dataset.cityAllowed = 'false';
                        setPincodeStatus('Invalid pincode. Please check and try again.', 'text-red-500');
                        return;
                    }

                    const offices = Array.isArray(data[0].PostOffice) ? data[0].PostOffice : [];
                    if (!offices.length) {
                        zipInput.dataset.cityAllowed = 'false';
                        setPincodeStatus('No city found for this pincode.', 'text-red-500');
                        return;
                    }

                    const isSuratPin = offices.some(office => {
                        const district = (office.District || '').trim();
                        const block = (office.Block || '').trim();
                        const name = (office.Name || '').trim();
                        return isSurat(district) || isSurat(block) || isSurat(name);
                    });

                    setFixedCityState(cityInput, stateInput);

                    if (!isSuratPin) {
                        zipInput.dataset.cityAllowed = 'false';
                        setPincodeStatus('We provide only Surat orders. Please use a Surat pincode.', 'text-red-500');
                        return;
                    }

                    zipInput.dataset.cityAllowed = 'true';
                    setPincodeStatus(`Valid pincode`, 'text-emerald-600');
                })
                .catch(() => {
                    zipInput.dataset.cityAllowed = 'unknown';
                    setFixedCityState(cityInput, stateInput);
                    setPincodeStatus('Unable to verify pincode. Please try again.', 'text-red-500');
                });
        };

        zipInput.addEventListener('input', function() {
            const pin = (zipInput.value || '').replace(/\D/g, '');
            if (zipInput.value !== pin) zipInput.value = pin;

            clearTimeout(lookupTimeout);
            if (pin.length !== 6) {
                zipInput.dataset.cityAllowed = 'false';
                clearPincodeStatus();
                setFixedCityState(cityInput, stateInput);
                return;
            }
            lookupTimeout = setTimeout(() => fetchPincode(pin), 400);
        });
    }

    // Initialize profile image action button on page load
    document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        const activeTab = params.get('tab') || 'edit';
        const actionBtn = document.getElementById('profileImageActionBtn');
        const fileInput = document.getElementById('id_profile_image');
        if (fileInput) {
            fileInput.setAttribute('accept', 'image/jpeg,image/png,image/webp,image/gif');
        }

        if (actionBtn) {
            const hasImage = actionBtn.dataset.hasImage === 'true';
            setProfileImageAction(hasImage ? 'delete' : 'camera');

            actionBtn.addEventListener('click', function() {
                const currentAction = actionBtn.dataset.action || (hasImage ? 'delete' : 'camera');
                if (currentAction === 'delete') {
                    if (hasImage) {
                        removeProfilePicture();
                    } else if (fileInput) {
                        fileInput.value = '';
                        setProfileImageAction('camera');
                    }
                } else if (fileInput) {
                    fileInput.click();
                }
            });
        }

        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const selectedFile = fileInput.files && fileInput.files.length > 0 ? fileInput.files[0] : null;
                const validationError = validateProfileImageFile(selectedFile);
                if (validationError) {
                    alert(validationError);
                    fileInput.value = '';
                    if (actionBtn && actionBtn.dataset.hasImage !== 'true') {
                        setProfileImageAction('camera');
                    }
                    return;
                }

                if (fileInput.files && fileInput.files.length > 0) {
                    setProfileImageAction('delete');
                } else if (actionBtn && actionBtn.dataset.hasImage !== 'true') {
                    setProfileImageAction('camera');
                }
            });
        }

        if (actionBtn) {
            if (activeTab === 'edit') {
                actionBtn.classList.remove('hidden');
            } else {
                actionBtn.classList.add('hidden');
            }
        }

        setupPincodeAutofill();

        const addressForm = document.getElementById('addressForm');
        if (addressForm) {
            addressForm.addEventListener('submit', function(e) {
                const zipInput = document.getElementById('address-zip');
                if (!zipInput) return;

                const pin = (zipInput.value || '').trim();
                const allowed = (zipInput.dataset.cityAllowed || 'unknown').toLowerCase();

                if (!pin || pin.length !== 6) {
                    e.preventDefault();
                    setPincodeStatus('We provide only Surat orders. Please enter a valid Surat pincode.', 'text-red-500');
                    return;
                }

                if (allowed !== 'true') {
                    e.preventDefault();
                    setPincodeStatus('We provide only Surat orders. Please use a Surat address.', 'text-red-500');
                }
            });
        }
    });

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('btn-' + tabId).classList.add('active');

        // Show profile image action button only in 'edit' tab
        const actionBtn = document.getElementById('profileImageActionBtn');
        if (actionBtn) {
            if (tabId === 'edit') {
                actionBtn.classList.remove('hidden');
            } else {
                actionBtn.classList.add('hidden');
            }
        }

        const url = new URL(window.location);
        url.searchParams.set('tab', tabId);
        window.history.pushState({}, '', url);
    }

    function toggleOrderDetails(orderId) {
        const detailsElement = document.getElementById('order-details-' + orderId);
        const chevronElement = document.querySelector('.order-chevron-' + orderId);

        if (detailsElement.classList.contains('hidden')) {
            detailsElement.classList.remove('hidden');
            detailsElement.classList.add('animate-fadeIn');
            chevronElement.style.transform = 'rotate(180deg)';
        } else {
            detailsElement.classList.add('hidden');
            chevronElement.style.transform = 'rotate(0deg)';
        }
    }

    function openRefundStatusModal(orderId, type) {
        const modal = document.getElementById('refundStatusModal');
        const content = document.getElementById('refundStatusContent');
        if (!modal || !content) return;

        const panelId = type === 'cancel' ? 'cancel-refund-status-' + orderId : 'refund-status-' + orderId;
        const panel = document.getElementById(panelId);
        if (!panel) return;

        content.innerHTML = panel.innerHTML;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeRefundStatusModal() {
        const modal = document.getElementById('refundStatusModal');
        if (!modal) return;
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function toggleBankDetailsForm(orderId) {
        const panel = document.getElementById('bank-details-form-' + orderId);
        if (!panel) return;
        panel.classList.toggle('hidden');
    }

    function toggleCancelRefundStatus(orderId) {
        openRefundStatusModal(orderId, 'cancel');
    }

    function openCancelOrderModal(button) {
        const modal = document.getElementById('cancelOrderModal');
        const form = document.getElementById('cancelOrderForm');
        const orderNumberLabel = document.getElementById('cancelOrderModalNumber');
        const reasonSelect = document.getElementById('cancelReasonSelect');
        if (!modal || !form) return;

        form.action = button.getAttribute('data-cancel-url') || '';
        const orderNumber = button.getAttribute('data-order-number') || '';
        if (orderNumberLabel) {
            orderNumberLabel.textContent = orderNumber ? `Order #${orderNumber}` : '';
        }
        if (reasonSelect) {
            reasonSelect.value = '';
        }

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeCancelOrderModal() {
        const modal = document.getElementById('cancelOrderModal');
        if (!modal) return;
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function openReviewModal(orderId) {
        document.getElementById('review_order_id').value = orderId;

        // Fetch order items via AJAX
        fetch(`/get-order-items/${orderId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const container = document.getElementById('productReviewsContainer');
                    container.innerHTML = '';

                    data.items.forEach(item => {
                        const productReviewHtml = `
                            <div class="bg-stone-50 rounded-xl p-6 border-2 border-gray-200">
                                <div class="flex items-start gap-4 mb-4">
                                    <div class="w-20 h-20 bg-white rounded-lg overflow-hidden border border-gray-200 flex-shrink-0">
                                        <img src="${item.thumbnail}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-800 mb-1">${item.name}</h4>
                                        <p class="text-xs text-gray-500">${item.variant}</p>
                                        ${item.has_review ? '<span class="inline-block mt-2 px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold"><i class="fa-solid fa-check"></i> Review Submitted (Edit below)</span>' : ''}
                                    </div>
                                </div>
                                
                                <input type="hidden" name="product_id[]" value="${item.product_id}">
                                
                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">Your Rating</label>
                                    <div class="flex gap-2 rating-group-${item.product_id}" onmouseenter="setupRating(${item.product_id})" onmouseleave="resetRating(${item.product_id})">
                                        ${[1, 2, 3, 4, 5].map(star => `
                                            <label class="cursor-pointer star-item-${item.product_id}" data-rating="${star}" onmouseenter="highlightProfileStars(${item.product_id}, ${star})" onmouseleave="resetRating(${item.product_id})">
                                                <input type="radio" name="rating_${item.product_id}" value="${star}" class="sr-only" ${Number(item.review_rating) === star ? 'checked' : ''} required onchange="selectProfileStars(${item.product_id}, ${star})">
                                                <i class="fa-solid fa-star text-3xl star-icon-${item.product_id} transition-all" style="color: ${Number(item.review_rating) >= star ? '#FBBF24' : '#D1D5DB'}"></i>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">Your Review</label>
                                    <textarea name="comment_${item.product_id}" rows="3" 
                                        class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg resize-none focus:border-ayur-primary focus:ring-2 focus:ring-ayur-primary/20 outline-none transition-all" 
                                        placeholder="Share your experience with this product..." required>${item.review_comment || ''}</textarea>
                                </div>
                            </div>
                        `;
                        container.innerHTML += productReviewHtml;
                    });

                    document.getElementById('reviewModal').classList.remove('hidden');
                } else {
                    alert('Error loading order items');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load order items');
            });
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
        document.getElementById('reviewForm').reset();
    }

    function openDeliveryReviewModal(button) {
        const orderId = button.getAttribute('data-order-id');
        const partnerName = button.getAttribute('data-partner') || 'Delivery Partner';
        const rating = button.getAttribute('data-rating') || '';
        const comment = button.getAttribute('data-comment') || '';

        document.getElementById('delivery_review_order_id').value = orderId;
        document.getElementById('deliveryReviewPartner').textContent = `For ${partnerName}`;
        document.getElementById('delivery_review_rating').value = rating;
        document.getElementById('delivery_review_comment').value = comment;
        document.getElementById('deliveryReviewModal').classList.remove('hidden');
    }

    function closeDeliveryReviewModal() {
        document.getElementById('deliveryReviewModal').classList.add('hidden');
        document.getElementById('deliveryReviewForm').reset();
    }

    // Return Modal Functions
    function openReturnModal(orderId, orderNumber) {
        document.getElementById('return_order_id').value = orderId;
        document.getElementById('returnOrderNumber').textContent = `Order #${orderNumber}`;
        document.getElementById('returnModal').classList.remove('hidden');
    }

    function closeReturnModal() {
        document.getElementById('returnModal').classList.add('hidden');
        document.getElementById('returnForm').reset();
    }

    // Close return modal when clicking outside
    document.getElementById('returnModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeReturnModal();
        }
    });

    // Profile Rating - Dynamic Fill
    function setupRating(productId) {
        // Initialize on hover
    }

    function highlightProfileStars(productId, rating) {
        document.querySelectorAll(`.star-item-${productId}`).forEach((item, index) => {
            const icon = item.querySelector(`.star-icon-${productId}`);
            if (index < rating) {
                icon.style.color = '#FBBF24'; // Yellow
            } else {
                icon.style.color = '#D1D5DB'; // Gray
            }
        });
    }

    function resetRating(productId) {
        const checkedInput = document.querySelector(`.rating-group-${productId} input[type="radio"]:checked`);
        const rating = checkedInput ? parseInt(checkedInput.value) : 0;

        document.querySelectorAll(`.star-item-${productId}`).forEach((item, index) => {
            const icon = item.querySelector(`.star-icon-${productId}`);
            if (index < rating) {
                icon.style.color = '#FBBF24'; // Yellow
            } else {
                icon.style.color = '#D1D5DB'; // Gray
            }
        });
    }

    function selectProfileStars(productId, rating) {
        document.querySelectorAll(`.star-item-${productId}`).forEach((item, index) => {
            const icon = item.querySelector(`.star-icon-${productId}`);
            if (index < rating) {
                icon.style.color = '#FBBF24'; // Yellow
            } else {
                icon.style.color = '#D1D5DB'; // Gray
            }
        });
    }

    // Close modal when clicking outside
    document.getElementById('reviewModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeReviewModal();
        }
    });

    document.getElementById('refundStatusModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeRefundStatusModal();
        }
    });

    document.getElementById('cancelOrderModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeCancelOrderModal();
        }
    });

    document.getElementById('cancelOrderForm')?.addEventListener('submit', function (e) {
        const reasonSelect = document.getElementById('cancelReasonSelect');
        if (!reasonSelect || !reasonSelect.value) {
            e.preventDefault();
            alert('Please select a cancellation reason.');
        }
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeCancelOrderModal();
        }
    });

    function editAddress(addressId) {
        // Redirect to edit page with address ID
        window.location.href = `{% url 'profile' %}?tab=address&edit=${addressId}`;
    }

    function deleteAddress(addressId) {
        // Show confirmation dialog
        if (confirm('Are you sure you want to delete this address?')) {
            // Create and submit a form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'profile' %}';

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'csrfmiddlewaretoken';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            // Add delete_address field
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'delete_address';
            deleteInput.value = addressId;
            form.appendChild(deleteInput);

            // Submit the form
            document.body.appendChild(form);
            form.submit();
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab') || 'edit';
    switchTab(activeTab);

    // Apply styles to inputs
    document.querySelectorAll('input, select').forEach(el => {
        if (!el.classList.contains('custom-input')) {
            el.classList.add('custom-input');
        }
        if (el.parentElement.querySelector('.fa-envelope') || el.parentElement.querySelector('.fa-phone')) {
            el.classList.add('pl-10');
        }
        // Tailwind class for toggle switch input (ensures checkboxes don't look like text boxes)
        if (el.type === 'checkbox') {
            el.classList.add('sr-only', 'peer');
            el.classList.remove('custom-input');
        }
    });
</script>
{% endblock %}
