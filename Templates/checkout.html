{% extends 'base.html' %}
{% block content %}
<div class="bg-[#FDFBF7] min-h-screen py-12 font-['Poppins']">
    <div class="max-w-[1200px] mx-auto px-5">
        <h1 class="font-['Playfair_Display'] text-3xl font-bold text-[#1A3C34] mb-10 text-center lg:text-left uppercase tracking-widest">Finalize Your Ritual</h1>
        <form method="POST" action="{% url 'process_order' %}" id="checkout-form">
            {% csrf_token %}
            <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
            <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
            <input type="hidden" name="razorpay_signature" id="razorpay_signature">
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-10 items-start">
                <div class="space-y-6">
                    <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-sm">
                        <h2 class="text-sm font-bold text-[#1A3C34] mb-8 flex items-center gap-3">
                            <span class="w-6 h-6 rounded-full bg-[#1A3C34] text-white flex items-center justify-center text-[10px]">1</span>
                            Contact Details
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Full Name</label>
                                <input type="text" name="full_name" value="{{ initial_contact.full_name }}" required class="w-full p-3 border border-gray-200 rounded text-sm focus:border-[#1A3C34] outline-none transition-all" placeholder="Receiver Name">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Phone Number</label>
                                <input type="text" name="phone" value="{{ initial_contact.phone }}" required class="w-full p-3 border border-gray-200 rounded text-sm focus:border-[#1A3C34] outline-none transition-all" placeholder="Mobile Number">
                            </div>
                            <div class="md:col-span-2 space-y-1">
                                <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Email Address</label>
                                <input type="email" name="email" value="{{ initial_contact.email }}" required class="w-full p-3 border border-gray-200 rounded text-sm focus:border-[#1A3C34] outline-none transition-all" placeholder="sanctuary@email.com">
                                <p class="text-[9px] text-stone-400 mt-2 italic"><i class="fa-solid fa-lock mr-1"></i> We'll use these details for your invoice and order updates.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-sm">
                        <h2 class="text-sm font-bold text-[#1A3C34] mb-8 flex items-center gap-3">
                            <span class="w-6 h-6 rounded-full bg-[#1A3C34] text-white flex items-center justify-center text-[10px]">2</span>
                            Order Summary
                        </h2>
                        <div class="space-y-6">
                            {% for item in cart.items.all %}
                            <div class="flex gap-5 items-center border-b border-stone-50 pb-5 last:border-0">
                                <div class="w-20 h-24 bg-stone-50 rounded-lg overflow-hidden flex-shrink-0 p-2">
                                    <img src="{{ item.product.thumbnail.url }}" class="w-full h-full object-contain mix-blend-multiply">
                                </div>
                                <div class="flex-grow">
                                    <h4 class="text-xs font-bold text-[#1A3C34] leading-tight">{{ item.product.name }}</h4>
                                    <p class="text-[10px] text-stone-400 mt-1 uppercase tracking-tighter">Size: {{ item.variant.unit_value }}{{ item.variant.unit_type }} • Qty: {{ item.quantity }}</p>
                                    <span class="inline-block mt-2 text-[8px] bg-stone-100 px-2 py-0.5 rounded font-black uppercase text-stone-500">Ritual Item</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-bold text-[#1A3C34]">₹{{ item.subtotal }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-sm">
                        <h2 class="text-sm font-bold text-[#1A3C34] mb-8 flex items-center gap-3">
                            <span class="w-6 h-6 rounded-full bg-[#1A3C34] text-white flex items-center justify-center text-[10px]">3</span>
                            Payment Method
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="payment" value="cod" checked class="hidden peer">
                                <div class="p-5 border-2 border-stone-100 rounded-xl flex flex-col items-center gap-2 peer-checked:border-[#1A3C34] peer-checked:bg-emerald-50/30 transition-all group">
                                    <i class="fa-solid fa-money-bill-transfer text-emerald-600 text-xl"></i>
                                    <span class="text-[11px] font-bold text-[#1A3C34]">Cash on Delivery</span>
                                    <p class="text-[9px] text-stone-400">Pay when it arrives</p>
                                    <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100"><i class="fa-solid fa-circle-check text-[#1A3C34] text-xs"></i></div>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="payment" value="online" class="hidden peer">
                                <div class="p-5 border-2 border-stone-100 rounded-xl flex flex-col items-center gap-2 peer-checked:border-[#1A3C34] peer-checked:bg-emerald-50/30 transition-all group">
                                    <i class="fa-solid fa-mobile-screen text-emerald-600 text-xl"></i>
                                    <span class="text-[11px] font-bold text-[#1A3C34]">Online Payment</span>
                                    <p class="text-[9px] text-stone-400">UPI, Card, Netbanking</p>
                                    <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100"><i class="fa-solid fa-circle-check text-[#1A3C34] text-xs"></i></div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-sm">
                        <h2 class="text-sm font-bold text-[#1A3C34] mb-8 flex items-center gap-3">
                            <span class="w-6 h-6 rounded-full bg-[#1A3C34] text-white flex items-center justify-center text-[10px]">4</span>
                            Delivery Address
                        </h2>
                        
                        <div class="space-y-4">
                            {% for addr in addresses %}
                            <label class="block cursor-pointer group">
                                <input type="radio" name="selected_address" value="{{ addr.id }}" {% if addr.is_default %}checked{% endif %} required class="hidden peer">
                                <div class="p-5 border-2 border-stone-100 rounded-xl peer-checked:border-[#1A3C34] peer-checked:bg-emerald-50/30 transition-all relative">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-[#1A3C34] group-hover:bg-white transition-colors">
                                                {% if addr.address_type == 'Home' %}
                                                    <i class="fa-solid fa-house text-xs"></i>
                                                {% elif addr.address_type == 'Office' or addr.address_type == 'Work' %}
                                                    <i class="fa-solid fa-briefcase text-xs"></i>
                                                {% else %}
                                                    <i class="fa-solid fa-location-dot text-xs"></i>
                                                {% endif %}
                                            </div>
                                            <span class="text-xs font-bold text-[#1A3C34]">{{ user.get_full_name }}</span>
                                        </div>
                                        <span class="bg-white border border-stone-200 px-2 py-0.5 rounded text-[8px] uppercase font-black text-stone-400 peer-checked:text-[#1A3C34] peer-checked:border-[#1A3C34]">
                                            {{ addr.address_type }}
                                        </span>
                                    </div>
                                    <p class="text-[11px] text-stone-500 leading-relaxed ml-11">
                                        {{ addr.street_address }}, {{ addr.city }}, {{ addr.state }} - {{ addr.zip_code }}<br>
                                        {% if addr.phone_number %}
                                        <span class="font-bold text-stone-400">Phone:</span> {{ addr.phone_number }}
                                        {% elif user.phone %}
                                        <span class="font-bold text-stone-400">Phone:</span> {{ user.phone }}
                                        {% endif %}
                                    </p>
                                    <div class="absolute top-4 right-4 opacity-0 peer-checked:opacity-100 transition-opacity">
                                        <i class="fa-solid fa-circle-check text-[#1A3C34]"></i>
                                    </div>
                                </div>
                            </label>
                            {% empty %}
                            <div class="text-center py-8 border-2 border-dashed border-stone-100 rounded-xl">
                                <p class="text-stone-300 text-xs italic">No saved sanctuaries found.</p>
                            </div>
                            {% endfor %}
                            
                            <a href="{% url 'profile' %}?tab=address" class="block w-full border-2 border-dashed border-stone-200 p-4 rounded-xl text-center text-stone-400 text-[11px] font-bold hover:bg-stone-50 hover:border-stone-300 transition-all uppercase tracking-widest">
                                + Add New Address
                            </a>
                        </div>
                    </div>
                </div>

                <div class="lg:sticky lg:top-24 h-fit">
                    <div class="bg-white p-8 rounded-xl border border-gray-100 shadow-xl space-y-6">
                        <h3 class="text-sm font-bold text-[#1A3C34] border-b border-stone-50 pb-4 uppercase tracking-widest">Price Details</h3>
                        <div class="space-y-4 text-xs">
                            <div class="flex justify-between text-stone-400"><span>Subtotal</span><span class="text-[#1A3C34] font-bold">₹{{ cart.total_price }}</span></div>
                            <div class="flex justify-between text-emerald-600 font-bold"><span>Delivery Charges</span><span class="uppercase">Free</span></div>
                        </div>
                        
                        <div class="flex items-center gap-2 py-2">
                            <input type="text" placeholder="PROMO CODE" class="flex-grow p-3 border border-stone-100 rounded-lg text-[10px] outline-none focus:border-stone-300">
                            <button type="button" class="bg-black text-white px-5 py-3 rounded-lg text-[10px] font-bold uppercase tracking-widest hover:bg-stone-800 transition-all">Apply</button>
                        </div>

                        <div class="flex justify-between items-center border-t border-stone-50 pt-6">
                            <span class="text-xs font-bold text-[#1A3C34] uppercase tracking-tighter">Total Amount</span>
                            <span class="text-xl font-bold text-[#1A3C34]">₹{{ cart.total_price }}</span>
                        </div>

                        <button type="submit" class="w-full bg-[#1A3C34] text-white py-5 rounded-lg font-bold uppercase tracking-[0.2em] text-[10px] hover:bg-[#0e241f] flex items-center justify-center gap-3 shadow-lg shadow-emerald-900/10 transition-all hover:-translate-y-1" id="place-order-btn">
                            Place Order <i class="fa-solid fa-arrow-right text-[10px]"></i>
                        </button>
                        <p class="text-[9px] text-center text-stone-300 pt-2"><i class="fa-solid fa-shield-halved mr-1"></i> Secure Checkout Ritual</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    (function () {
        const form = document.getElementById('checkout-form');
        const placeOrderBtn = document.getElementById('place-order-btn');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        form.addEventListener('submit', async function (e) {
            const paymentMethod = form.querySelector('input[name="payment"]:checked')?.value || 'cod';
            if (paymentMethod !== 'online') {
                return;
            }

            e.preventDefault();
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Processing...';

            try {
                const response = await fetch("{% url 'create_razorpay_order' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message || 'Unable to create payment.');
                }

                const options = {
                    key: data.key_id,
                    amount: data.amount,
                    currency: data.currency,
                    name: 'SkinCraft',
                    description: 'Order Payment',
                    order_id: data.order_id,
                    prefill: data.prefill || {},
                    handler: function (response) {
                        document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
                        document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                        document.getElementById('razorpay_signature').value = response.razorpay_signature;
                        form.submit();
                    },
                    theme: {
                        color: '#1A3C34'
                    }
                };

                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response) {
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Place Order';
                    alert('Payment failed: ' + response.error.description);
                });
                rzp.open();
            } catch (err) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'Place Order';
                alert('Error: ' + err.message);
            }
        });
    })();
</script>
</div>
{% endblock %}