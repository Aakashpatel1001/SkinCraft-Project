{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delivery Partner | Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* --- RESET & VARIABLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        :root {
            --sidebar-width: 260px;
            --primary-color: #1a1a1a;
            --accent-color: #d4af37;
            --bg-color: #f4f6f9;
            --text-color: #333;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* --- OVERLAY (Mobile) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 998;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .overlay.active { display: block; opacity: 1; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: #fff;
            position: fixed;
            height: 100%;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex; flex-direction: column;
            left: 0; top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .logo-area { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .logo-area h3 { font-size: 1.2rem; letter-spacing: 1px; }

        .nav-links { list-style: none; padding: 20px 0; flex: 1; }
        .nav-item { padding: 15px 25px; display: flex; align-items: center; gap: 15px; cursor: pointer; color: #bbb; transition: 0.2s; text-decoration: none; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: #fff; border-left: 4px solid var(--accent-color); }
        .nav-item i { width: 25px; text-align: center; font-size: 1.1rem; }

        .driver-profile { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .driver-info { font-size: 0.95rem; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .vehicle-info { font-size: 0.8rem; color: #aaa; display: flex; align-items: center; gap: 8px; }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 30px;
            width: 100%;
            transition: 0.3s;
        }

        /* Top Header (Mobile Toggle) */
        .top-header { display: none; align-items: center; justify-content: space-between; margin-bottom: 25px; background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .menu-toggle { font-size: 1.4rem; cursor: pointer; color: #333; padding: 5px; }

        /* --- EARNINGS CARD --- */
        .earnings-card {
            background: linear-gradient(135deg, #1e1e2d 0%, #2d2d44 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .ec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; opacity: 0.8; font-size: 0.9rem; }
        .ec-amount { font-size: 2rem; font-weight: 800; margin-bottom: 5px; letter-spacing: -0.5px; }
        .ec-label { font-size: 0.85rem; opacity: 0.7; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        .ec-progress { 
            background: rgba(255,255,255,0.1); 
            height: 6px; 
            border-radius: 3px; 
            margin: 20px 0; 
            overflow: hidden; 
        }
        .ec-bar { 
            height: 100%; 
            background: #0bb783; 
            border-radius: 3px; 
            transition: width 0.5s ease;
        }

        .ec-stats { display: flex; justify-content: space-between; margin-top: 10px; }
        .ec-stat-item { text-align: center; width: 33%; }
        .ec-val { font-weight: 700; font-size: 1rem; display: block; margin-bottom: 2px; }
        .ec-desc { font-size: 0.7rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .status-text-paid { color: #0bb783; }
        .status-text-due { color: #f64e60; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; }
        .stat-card h3 { font-size: 1.8rem; margin-bottom: 5px; color: #333; font-weight: 800; }
        .stat-card p { font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .stat-icon { font-size: 2.5rem; opacity: 0.15; transform: rotate(-10deg); }
        
        .border-yellow::after { background: var(--warning-color); }
        .border-green::after { background: var(--success-color); }
        .border-dark::after { background: #333; }
        .border-blue::after { background: var(--info-color); }

        /* Content Area */
        .content-box { background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); overflow: hidden; border: 1px solid #eee; margin-bottom: 30px; }
        .box-header { padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .box-title { font-size: 1.05rem; font-weight: 700; color: #333; }

        /* Task Cards (List Style) */
        .task-list { padding: 20px; }
        .task-item { border: 1px solid #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden; transition: 0.2s; background: #fff; }
        .task-item:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.06); transform: translateY(-2px); border-color: transparent; }
        
        .task-header { background: #f8f9fa; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .order-id { font-weight: 800; font-size: 1rem; color: #1a1a1a; }
        
        .task-body { padding: 20px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        
        .info-group { margin-bottom: 12px; }
        .info-label { font-size: 0.7rem; color: #999; text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 4px; letter-spacing: 0.5px; }
        .info-value { font-size: 0.95rem; color: #333; font-weight: 600; line-height: 1.4; }

        /* Badges */
        .badge { padding: 6px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-pending { background: #fff8e1; color: #b7860b; }
        .badge-shipped { background: #e3f2fd; color: #0277bd; }
        .badge-out { background: #e8f5e9; color: #2e7d32; }
        .badge-type { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-right: 8px; color: #fff; }
        .type-delivery { background: #28a745; } 
        .type-pickup { background: #fd7e14; }

        /* Buttons */
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; font-size: 0.9rem; width: 100%; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-info { background: #17a2b8; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-call { background: #fff; color: #333; border: 2px solid #eee; }
        .btn:active { transform: scale(0.98); }

        /* OTP Input */
        .otp-group { display: flex; gap: 10px; margin-top: 10px; }
        .otp-input { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 8px; text-align: center; letter-spacing: 4px; font-weight: 800; font-size: 1.1rem; outline: none; transition: 0.2s; }
        .otp-input:focus { border-color: var(--success-color); }

        /* Toast */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 2000; width: 90%; max-width: 350px; }
        .toast { background: #333; color: #fff; padding: 16px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 12px; font-size: 0.9rem; }
        .toast.error { background: #dc3545; }
        .toast.success { background: #28a745; }

        /* Alerts (Django Messages) */
        .alert { padding: 14px 18px; border-radius: 10px; margin-bottom: 18px; font-weight: 600; box-shadow: 0 6px 14px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 10px; }
        .alert-success { background: #e7f7ef; color: #1d6b44; border: 1px solid #bfe7d0; }
        .alert-error { background: #fdecea; color: #7a1c1c; border: 1px solid #f5c6c6; }

        /* Pulse Animation for New Badge */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }
        /* Help Desk */
        .helpdesk-wrap { display: grid; grid-template-columns: 1.2fr 2fr; gap: 18px; }
        .helpdesk-side { background: linear-gradient(135deg, #1a3cff 0%, #6a5bff 100%); color: #fff; border-radius: 12px; padding: 18px; display: flex; flex-direction: column; gap: 10px; }
        .helpdesk-side h4 { margin: 0; font-size: 1.05rem; }
        .helpdesk-side p { margin: 0; font-size: 0.85rem; opacity: 0.9; }
        .helpdesk-form { background: #f9fbff; border: 1px solid #e6ecff; border-radius: 12px; padding: 16px; }
        .helpdesk-field { display: flex; flex-direction: column; gap: 6px; }
        .helpdesk-field select,
        .helpdesk-field textarea { width: 100%; padding: 12px; border: 2px solid #e9eef7; border-radius: 10px; font-weight: 600; background: #fff; }
        .helpdesk-field textarea { min-height: 90px; resize: vertical; }
        .helpdesk-actions { margin-top: 16px; display: flex; justify-content: flex-end; }
        .helpdesk-btn { background: #2f6bff; color: #fff; border: none; }
        .helpdesk-btn:hover { filter: brightness(0.95); }

        @media (max-width: 900px) {
            .helpdesk-wrap { grid-template-columns: 1fr; }
        }

        /* Table */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .custom-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .custom-table th { text-align: left; padding: 15px 20px; background: #f9f9f9; color: #888; font-size: 0.8rem; text-transform: uppercase; font-weight: 700; }
        .custom-table td { padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .custom-table tr:last-child td { border-bottom: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .top-header { display: flex; }
            .stats-grid { grid-template-columns: 1fr; }
            .task-body { grid-template-columns: 1fr; gap: 15px; }
            .driver-profile { padding-bottom: 40px; } 
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="logo-area">
            <h3><i class="fas fa-shipping-fast" style="color:var(--accent-color);"></i> Partner App</h3>
        </div>
        
        <ul class="nav-links">
            <li class="nav-item active" onclick="showTab('dashboard', this)">
                <i class="fas fa-th-large"></i> Dashboard
            </li>
            <li class="nav-item" onclick="showTab('history', this)">
                <i class="fas fa-history"></i> Order History
            </li>
            <li class="nav-item" onclick="showTab('helpdesk', this)">
                <i class="fas fa-headset"></i> Help Desk
            </li>
            <li class="nav-item" onclick="location.href='{% url 'homepage' %}'">
                <i class="fas fa-store"></i> Go to Website
            </li>
            <li class="nav-item" onclick="location.href='{% url 'logout' %}'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </li>
        </ul>

        <div class="driver-profile">
            <div class="driver-info">{{ user.first_name }} {{ user.last_name }}</div>
            {% if profile %}
            <div class="vehicle-info"><i class="fas fa-motorcycle"></i> {{ profile.vehicle_number }}</div>
            {% endif %}
        </div>
    </div>

    <div class="main-content">
        
        <div class="top-header">
            <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <h3 style="font-size:1.2rem; margin:0;">Dashboard</h3>
            <div style="width:24px;"></div> 
        </div>

        <div id="toast-box"></div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i>
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        {% endif %}

        <div id="tab-dashboard" class="view-section">
            
            <div class="earnings-card">
                <div class="ec-header"><span>Monthly Salary</span><i class="fas fa-wallet"></i></div>
                <div class="ec-amount">₹{{ stats.salary_paid|default:"0" }}</div>
                <div class="ec-label">Received This Month</div>
                <div class="ec-progress">
                    <div class="ec-bar" style="width: {% widthratio stats.salary_paid stats.monthly_salary 100 %}%"></div>
                </div>
                <div class="ec-stats">
                    <div class="ec-stat-item">
                        <span class="ec-val">₹{{ stats.monthly_salary }}</span><span class="ec-desc">Fixed</span>
                    </div>
                    <div class="ec-stat-item" style="border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1);">
                        <span class="ec-val status-text-paid">₹{{ stats.salary_paid }}</span><span class="ec-desc">Paid</span>
                    </div>
                    <div class="ec-stat-item">
                        <span class="ec-val status-text-due">₹{{ stats.salary_due }}</span><span class="ec-desc">Due</span>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card border-blue">
                    <div><h3>₹{{ stats.monthly_salary }}</h3><p>Fixed Salary</p></div>
                    <i class="fas fa-money-bill-wave stat-icon" style="color: var(--info-color);"></i>
                </div>
                <div class="stat-card border-yellow">
                    <div><h3>{{ stats.pending_count }}</h3><p>Pending Deliveries</p></div>
                    <i class="fas fa-clock stat-icon" style="color: var(--warning-color);"></i>
                </div>
                <div class="stat-card border-dark">
                    <div><h3>{{ stats.total_delivered }}</h3><p>Orders Delivered</p></div>
                    <i class="fas fa-check-double stat-icon" style="color: #333;"></i>
                </div>
                <div class="stat-card" style="border-left: 4px solid #d63031;">
                    <div><h3>{{ stats.return_pickups }}</h3><p>Return Pickups</p></div>
                    <i class="fas fa-undo stat-icon" style="color: #d63031;"></i>
                </div>
            </div>

            <div class="content-box">
                <div class="box-header">
                    <span class="box-title text-success"><i class="fas fa-box"></i> Deliveries</span>
                    <span class="badge badge-pending" style="background:#e8f5e9; color:#2e7d32;">{{ tasks|length }} Pending</span>
                </div>
                <div class="task-list">
                    {% for task in tasks %}
                    <div class="task-item" style="border-left: 5px solid #28a745;">
                        <div class="task-header">
                            <div>
                                <span class="badge-type type-delivery">DELIVERY</span>
                                <span class="order-id">Order #{{ task.order_number }}</span>
                                {% if task.status == 'Shipped' %}
                                    <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; margin-left: 8px; animation: pulse 2s infinite;">
                                        <i class="fas fa-star"></i> NEW ASSIGNMENT
                                    </span>
                                {% endif %}
                            </div>
                            <span class="badge {% if task.status == 'Pending' %}badge-pending{% elif task.status == 'Shipped' %}badge-shipped{% else %}badge-out{% endif %}">
                                {{ task.status }}
                            </span>
                        </div>
                        <div class="task-body">
                            <div>
                                <div class="info-group">
                                    <span class="info-label">Customer Name</span>
                                    <div class="info-value">
                                        {% if task.full_name %}
                                            {{ task.full_name }}
                                        {% elif task.user %}
                                            {{ task.user.first_name }} {{ task.user.last_name }}
                                        {% else %}
                                            Customer
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Delivery Address</span>
                                    <div class="info-value">
                                        {% if task.street_address %}
                                            <i class="fas fa-map-marker-alt" style="color:#dc3545; margin-right:5px;"></i>
                                            {{ task.street_address }}<br>
                                            <span style="font-size:0.85rem; color:#666;">{{ task.city }}, {{ task.state }} - {{ task.zip_code }}</span>
                                        {% else %}
                                            <span style="color:red;">Address Unavailable</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Payment Amount</span>
                                    <div class="info-value" style="color:var(--success-color); font-weight:800;">
                                        ₹{{ task.total_amount }} <small class="text-muted">({{ task.payment_method }})</small>
                                    </div>
                                </div>
                            </div>

                            <div style="display:flex; flex-direction:column; gap:12px;">
                                <a href="tel:{% if task.phone %}{{ task.phone }}{% elif task.user and task.user.phone %}{{ task.user.phone }}{% endif %}" class="btn btn-call">
                                    <i class="fas fa-phone"></i> Call Customer
                                </a>

                                {% if task.street_address %}
                                    <a href="https://www.google.com/maps/dir/?api=1&origin=Surbhi+The+Royal+Town+Pasodara+Patia+Surat&destination={{ task.street_address|urlencode }},{{ task.city|urlencode }},{{ task.state|urlencode }}" 
                                       target="_blank" class="btn btn-info" style="background-color: #4285F4; color: white;">
                                        <i class="fas fa-directions"></i> Directions
                                    </a>
                                {% endif %}

                                {% if task.status == 'Pending' %}
                                    <form class="ajax-form status-form" action="{% url 'update_delivery_status' task.id %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" name="new_status" value="Shipped" class="btn btn-warning">
                                            <i class="fas fa-box-open"></i> Pick Up Order
                                        </button>
                                    </form>

                                {% elif task.status == 'Shipped' %}
                                    <form class="ajax-form status-form" action="{% url 'update_delivery_status' task.id %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" name="new_status" value="On Way" class="btn btn-info">
                                            <i class="fas fa-motorcycle"></i> Start Journey
                                        </button>
                                    </form>

                                {% elif task.status == 'On Way' %}
                                    
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #ccc;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                            <span style="font-size:0.85rem; font-weight:700; color:#555;">PAYMENT STATUS</span>
                                            {% if task.payment_status == 'Paid' %}
                                                <span class="badge" style="background:#d4edda; color:#155724;">PAID</span>
                                            {% else %}
                                                <span class="badge" id="pay-status-{{ task.id }}" style="background:#f8d7da; color:#721c24;">UNPAID: ₹{{ task.total_amount }}</span>
                                            {% endif %}
                                        </div>

                                        {% if task.payment_status != 'Paid' %}
                                        <div id="pay-options-{{ task.id }}">
                                            <button type="button" class="btn btn-info" onclick="startRazorpayPayment('{{ task.id }}')" style="background-color: #3399cc; border:none; margin-bottom: 5px;">
                                                <i class="fas fa-qrcode"></i> Collect Online (Razorpay)
                                            </button>
                                            <div style="text-align:center; font-size:0.8rem; color:#888; margin:5px 0;">- OR -</div>
                                            <div style="text-align:center; font-size:0.85rem; font-weight:600; color:#333;">Collect Cash & Verify OTP</div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <form class="ajax-form otp-send-form" action="{% url 'send_delivery_otp' task.id %}" method="POST" id="send-otp-{{ task.id }}" {% if task.delivery_otp %}style="display:none;"{% endif %}>
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-bell"></i> Arrived & Send OTP
                                        </button>
                                    </form>

                                    <div id="verify-otp-{{ task.id }}" {% if not task.delivery_otp %}style="display:none;"{% endif %}>
                                        <form class="ajax-form otp-verify-form" action="{% url 'complete_delivery' task.id %}" method="POST">
                                            {% csrf_token %}
                                            <div class="otp-group">
                                                <input type="number" name="otp" class="otp-input" placeholder="OTP" required>
                                                <button type="submit" class="btn btn-success" style="width:auto;">Verify</button>
                                            </div>
                                        </form>
                                        
                                        <form class="ajax-form resend-form" action="{% url 'send_delivery_otp' task.id %}" method="POST" style="margin-top:10px; text-align:center;">
                                            {% csrf_token %}
                                            <button type="submit" style="background:none; border:none; color:#007bff; cursor:pointer; font-size:0.85rem; font-weight:600;">Resend OTP</button>
                                        </form>
                                    </div>

                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <div style="text-align:center; padding:50px 20px; color:#999;">
                            <i class="fas fa-clipboard-check" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
                            <p>No pending deliveries.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="content-box">
                <div class="box-header">
                    <span class="box-title text-warning" style="color:#fd7e14;"><i class="fas fa-undo"></i> Return Pickups</span>
                    <span class="badge badge-pending" style="background:#fff3cd; color:#856404;">{{ pickup_tasks|length }} Pending</span>
                </div>
                <div class="task-list">
                    {% for return_item in pickup_tasks %}
                    <div class="task-item" style="border-left: 5px solid #fd7e14;">
                        <div class="task-header">
                            <div>
                                <span class="badge-type type-pickup" style="background:#dc3545;">RETURN PICKUP</span>
                                <span class="order-id">Order #{{ return_item.order.order_number }}</span>
                                <span class="badge" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; margin-left: 8px; animation: pulse 2s infinite;">
                                    <i class="fas fa-star"></i> NEW RETURN
                                </span>
                            </div>
                            <span class="badge badge-shipped" style="background: #ffeaa7; color: #d63031;">Approved</span>
                        </div>
                        
                        <div class="task-body">
                            <div>
                                <div class="info-group">
                                    <span class="info-label">Customer Name</span>
                                    <div class="info-value">
                                        {% if return_item.order.full_name %}
                                            {{ return_item.order.full_name }}
                                        {% elif return_item.user %}
                                            {{ return_item.user.first_name }} {{ return_item.user.last_name }}
                                        {% else %}
                                            Customer
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Pickup Address</span>
                                    <div class="info-value">
                                        {% if return_item.order.street_address %}
                                            <i class="fas fa-map-marker-alt" style="color:#dc3545; margin-right:5px;"></i>
                                            {{ return_item.order.street_address }}<br>
                                            <span style="font-size:0.85rem; color:#666;">{{ return_item.order.city }}, {{ return_item.order.state }} - {{ return_item.order.zip_code }}</span>
                                        {% else %}
                                            <span style="color:red;">Address Unavailable</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Return Reason</span>
                                    <div class="info-value" style="color:#d63031; font-weight:700;">
                                        {{ return_item.get_reason_display }}
                                    </div>
                                </div>
                                <div class="info-group">
                                    <span class="info-label">Issue Details</span>
                                    <div class="info-value" style="font-size:0.85rem;">
                                        {{ return_item.issue }}
                                    </div>
                                </div>
                            </div>

                            <div style="display:flex; flex-direction:column; gap:12px;">
                                <a href="tel:{% if return_item.order.phone %}{{ return_item.order.phone }}{% elif return_item.user and return_item.user.phone %}{{ return_item.user.phone }}{% endif %}" class="btn btn-call">
                                    <i class="fas fa-phone"></i> Call Customer
                                </a>

                                {% if return_item.order.street_address %}
                                    <a href="https://www.google.com/maps/dir/?api=1&origin=Surbhi+The+Royal+Town+Pasodara+Patia+Surat&destination={{ return_item.order.street_address|urlencode }},{{ return_item.order.city|urlencode }},{{ return_item.order.state|urlencode }}" 
                                       target="_blank" class="btn btn-info" style="background-color: #4285F4; color: white;">
                                        <i class="fas fa-directions"></i> Directions
                                    </a>
                                {% endif %}

                                <a href="{% url 'confirm_return_pickup' return_item.id %}" class="btn btn-success" style="background: #28a745; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;">
                                    <i class="fas fa-check-circle"></i> Complete Pickup
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <div style="text-align:center; padding:50px 20px; color:#999;">
                            <i class="fas fa-box-open" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
                            <p>No return pickups pending.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

        </div>

        <div id="tab-history" class="view-section" style="display:none;">
            <div class="content-box">
                <div class="box-header"><span class="box-title">Delivery History</span></div>
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead><tr><th>Order ID</th><th>Date</th><th>Location</th><th>Amount</th><th>Type</th><th>Status</th></tr></thead>
                        <tbody>
                            {% for item in history %}
                            <tr>
                                <td style="font-weight:bold;">#{{ item.order_number }}</td>
                                <td>{{ item.created_at|date:"M d" }} <span style="font-size:0.75rem; color:#999; display:block;">{{ item.created_at|date:"h:i A" }}</span></td>
                                <td>{{ item.city|default:"-" }}</td>
                                <td style="font-weight:bold; color:var(--success-color);">₹{{ item.total_amount }}</td>
                                <td><span class="badge" style="background:#007bff; color:white;">Delivery</span></td>
                                <td><span class="badge" style="background:#d4edda; color:#155724;">Delivered</span></td>
                            </tr>
                            {% endfor %}
                            
                            {% for pickup in completed_pickups %}
                            <tr style="background:#f0fdf4;">
                                <td style="font-weight:bold;">#{{ pickup.order.order_number }}</td>
                                <td>{{ pickup.picked_up_at|date:"M d" }} <span style="font-size:0.75rem; color:#999; display:block;">{{ pickup.picked_up_at|date:"h:i A" }}</span></td>
                                <td>{{ pickup.order.city|default:"-" }}</td>
                                <td style="font-weight:bold; color:#10b981;">₹{{ pickup.order.total_amount }}</td>
                                <td><span class="badge" style="background:#10b981; color:white;"><i class="fas fa-undo"></i> Return Pickup</span></td>
                                <td><span class="badge" style="background:#d4edda; color:#155724;">Completed</span></td>
                            </tr>
                            {% endfor %}
                            
                            {% if not history and not completed_pickups %}
                            <tr><td colspan="6" style="text-align:center; padding:40px; color:#888;">No completed deliveries or pickups yet.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-helpdesk" class="view-section" style="display:none;">
            <div class="content-box">
                <div class="box-header">
                    <span class="box-title" style="color:#007bff;"><i class="fas fa-headset"></i> Help Desk</span>
                </div>
                <div class="task-list" style="padding:20px;">
                    <form action="{% url 'submit_helpdesk_ticket' %}" method="POST">
                        {% csrf_token %}
                        <div class="helpdesk-wrap">
                            <div class="helpdesk-side">
                                <h4>Need quick assistance?</h4>
                                <p>Select a reason and add remarks. Our support team will review and get back soon.</p>
                                <div style="font-size:0.8rem; opacity:0.9;">
                                    <i class="fas fa-clock"></i> Avg response: 2-4 hrs
                                </div>
                            </div>
                            <div class="helpdesk-form">
                                <div class="helpdesk-field">
                                    <label class="info-label">Reason</label>
                                    <select name="reason" required>
                                        <option value="" disabled selected>Select a reason</option>
                                        {% for value, label in helpdesk_reasons %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="helpdesk-field" style="margin-top:12px;">
                                    <label class="info-label">Remarks</label>
                                    <textarea name="remarks" placeholder="Write remarks (optional)"></textarea>
                                </div>
                                <div class="helpdesk-actions">
                                    <button type="submit" class="btn helpdesk-btn" style="width:auto;">
                                        <i class="fas fa-paper-plane"></i> Submit Request
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function showTab(tabName, linkElement) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.getElementById('tab-' + tabName).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            linkElement.classList.add('active');
            if(window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        // AJAX Form Handling
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.alert').forEach(function(el) {
                setTimeout(function() {
                    el.style.transition = 'opacity 0.4s ease';
                    el.style.opacity = '0';
                    setTimeout(function() { el.remove(); }, 450);
                }, 2500);
            });

            document.body.addEventListener('submit', function(e) {
                if (e.target.matches('.ajax-form')) {
                    e.preventDefault();
                    const form = e.target;
                    const btn = form.querySelector('button[type="submit"]');
                    const originalText = btn.innerHTML;
                    
                    const formData = new FormData(form);
                    if (e.submitter && e.submitter.name) {
                        formData.append(e.submitter.name, e.submitter.value);
                    }

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (form.classList.contains('status-form')) {
                                showToast('Success', 'success');
                                setTimeout(() => location.reload(), 500);
                            }
                            else if (form.classList.contains('otp-send-form')) {
                                const id = form.id.split('-')[2];
                                form.style.display = 'none';
                                document.getElementById('verify-otp-'+id).style.display = 'block';
                                showToast('OTP Sent Successfully', 'success');
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }
                            else if (form.classList.contains('otp-verify-form')) {
                                showToast('Delivery Completed!', 'success');
                                setTimeout(() => location.reload(), 1000);
                            }
                        } else {
                            showToast(data.message, 'error');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('Connection Error', 'error');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
                }
            });

            function showToast(msg, type) {
                const box = document.getElementById('toast-box');
                const div = document.createElement('div');
                div.className = `toast ${type}`;
                div.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-circle'}"></i> ${msg}`;
                box.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        });

        // --- RAZORPAY INTEGRATION ---
        function startRazorpayPayment(deliveryId) {
            const btn = document.querySelector(`button[onclick="startRazorpayPayment('${deliveryId}')"]`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;

            fetch(`/delivery/payment/start/${deliveryId}/`)
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    var options = {
                        "key": data.key_id,
                        "amount": data.amount,
                        "currency": "INR",
                        "name": "SkinCraft Delivery",
                        "description": "Order #" + deliveryId,
                        "order_id": data.razorpay_order_id,
                        "handler": function (response){
                            verifyPayment(response, deliveryId, btn);
                        },
                        "prefill": {
                            "name": data.customer_name,
                            "email": data.customer_email,
                            "contact": data.customer_phone
                        },
                        "theme": { "color": "#0f5132" },
                        "modal": {
                            "ondismiss": function(){
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }
                        }
                    };
                    var rzp1 = new Razorpay(options);
                    rzp1.on('payment.failed', function (response){
                        alert("Payment Failed: " + response.error.description);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
                    rzp1.open();
                } else {
                    alert("Error starting payment");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function verifyPayment(response, deliveryId, btn) {
            btn.innerHTML = 'Verifying...';
            const formData = new FormData();
            formData.append('razorpay_payment_id', response.razorpay_payment_id);
            formData.append('razorpay_order_id', response.razorpay_order_id);
            formData.append('razorpay_signature', response.razorpay_signature);
            formData.append('delivery_id', deliveryId);

            fetch("/delivery/payment/verify/", {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    const statusBadge = document.getElementById(`pay-status-${deliveryId}`);
                    if(statusBadge) {
                        statusBadge.style.background = "#d4edda";
                        statusBadge.style.color = "#155724";
                        statusBadge.innerText = "PAID";
                    }
                    const optionsDiv = document.getElementById(`pay-options-${deliveryId}`);
                    if(optionsDiv) optionsDiv.style.display = 'none';
                    
                    alert("Payment Successful! Proceed to deliver.");
                } else {
                    alert("Verification Failed: " + data.message);
                    btn.innerHTML = '<i class="fas fa-qrcode"></i> Retry Payment';
                    btn.disabled = false;
                }
            });
        }
    </script>
</body>
</html>