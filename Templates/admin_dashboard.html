{% load static %}
<html lang="en">
<head>
    <title>Admin Dashboard - SkinCraft Ayurveda</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="{% static 'images/img.png' %}" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ayur: {
                            ink: '#0E1B14',
                            dark: '#1C2E22',
                            primary: '#2F6B3A',
                            mint: '#DFF3E7',
                            sand: '#F6F1E7',
                            gold: '#C9A227'
                        }
                    },
                    fontFamily: {
                        serif: ['"Fraunces"', 'serif'],
                        sans: ['"Space Grotesk"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --shadow-soft: 0 10px 30px rgba(14, 27, 20, 0.08);
            --shadow-tight: 0 6px 18px rgba(14, 27, 20, 0.12);
            --ring: 0 0 0 2px rgba(47, 107, 58, 0.18);
        }

        body {
            background: radial-gradient(1200px 600px at 10% -10%, #E9F7EF 0%, transparent 60%),
                radial-gradient(900px 480px at 90% 0%, #F5EEE2 0%, transparent 55%),
                #F7F8F5;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: floatIn 0.45s ease;
        }

        .nav-item-active {
            background: linear-gradient(135deg, #E9F7EF 0%, #CFE8D7 100%);
            box-shadow: var(--ring);
        }

        .nav-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.9rem;
            background: #DFF3E7;
            color: #2F6B3A;
            box-shadow: 0 8px 16px rgba(14, 27, 20, 0.08);
        }

        .nav-item-active .nav-icon {
            background: #2F6B3A;
            color: #ffffff;
        }

        .stat-card-gradient {
            position: relative;
            overflow: hidden;
            border: 1px solid #E5E7EB;
            background: #ffffff;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.06);
        }

        .stat-card-gradient::before,
        .stat-card-gradient::after {
            display: none;
        }

        .stat-card-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            box-shadow: 0 10px 18px rgba(14, 27, 20, 0.08);
        }

        .glass {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.72));
            backdrop-filter: blur(8px);
        }

        .pill {
            border: 1px solid rgba(46, 77, 58, 0.18);
            background: #fff;
        }

        .section-title {
            letter-spacing: 0.06em;
        }

        .btn-ghost {
            border: 1px solid rgba(14, 27, 20, 0.12);
            background: #ffffff;
            color: #2F3D34;
            box-shadow: 0 10px 18px rgba(14, 27, 20, 0.06);
        }

        .btn-ghost:hover {
            border-color: rgba(47, 107, 58, 0.4);
            color: #2F6B3A;
            transform: translateY(-1px);
        }

        .badge-soft {
            background: rgba(17, 24, 39, 0.08);
            color: #1C2E22;
        }

        .data-table th {
            color: #6B7280;
            font-size: 0.7rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
        }

        .data-table td {
            color: #334155;
            font-size: 0.9rem;
        }

        .data-table tbody tr {
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(47, 107, 58, 0.06);
            transform: translateX(2px);
        }

        @media (-webkit-min-device-pixel-ratio: 0) {
            .sidebar-nav::-webkit-scrollbar {
                width: 6px;
            }

            .sidebar-nav::-webkit-scrollbar-thumb {
                background: #D1D5DB;
                border-radius: 10px;
            }
        }
</style>
</head>

<body class="m-0 p-0 box-border font-sans text-ayur-ink md:flex">
    <!-- SIDEBAR -->
    <aside
        class="hidden md:flex w-[292px] h-screen bg-white/90 fixed left-0 top-0 border-r border-white/60 flex-col shadow-[8px_0_30px_rgba(14,27,20,0.08)] glass">
                <!-- Logo Section -->
        <div class="p-7 border-b border-gray-200">
            <a href="{% url 'admin_dashboard' %}"
                class="flex items-center gap-2 no-underline transition-all duration-500 group cursor-pointer">
                <div
                    class="relative w-10 h-10 flex items-center justify-center bg-ayur-light rounded-full group-hover:bg-ayur-primary transition-colors duration-500">
                    <i
                        class="fa-solid fa-leaf text-ayur-primary text-lg group-hover:text-white group-hover:rotate-45 transition-all duration-500"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-serif text-2xl font-bold text-ayur-dark tracking-wide leading-none">Skin<span
                            class="text-ayur-primary">Craft</span></span>
                    <span
                        class="text-[10px] uppercase tracking-[0.2em] text-gray-500 group-hover:text-ayur-gold transition-colors">Ayurveda</span>
                </div>
            </a>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 sidebar-nav">
            <div class="mb-6">
                <a href="#dashboard"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)] active nav-item-active text-ayur-primary font-semibold"
                    data-section="dashboard">
                    <i class="fas fa-chart-line nav-icon"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#analytics"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="analytics">
                    <i class="fas fa-chart-pie nav-icon"></i>
                    <span>Analytics</span>
                </a>
            
                <a href="#salary"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="salary">
                    <i class="fas fa-money-bill-wave nav-icon"></i>
                    <span>Salary Payments</span>
                </a>
            
                <a href="#returns"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="returns">
                    <i class="fas fa-exchange-alt nav-icon"></i>
                    <span>Returns Approval</span>
                    <span id="badge-returns"
                        class="ml-auto bg-red-500 text-white px-2 py-0.5 rounded-[10px] text-[0.7rem] font-semibold">{{ returns_pending_count }}</span>
                </a>
                <a href="#refunds"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="refunds">
                    <i class="fas fa-money-bill-wave nav-icon"></i>
                    <span>Refunds</span>
                    <span id="badge-refunds"
                        class="ml-auto bg-red-500 text-white px-2 py-0.5 rounded-[10px] text-[0.7rem] font-semibold">{{ refunds.count }}</span>
                </a>
                <a href="#users"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="users">
                    <i class="fas fa-users nav-icon"></i>
                    <span>Users</span>
                </a>
                <a href="#orders"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="orders">
                    <i class="fas fa-shopping-bag nav-icon"></i>
                    <span>Orders</span>
                    <span id="badge-orders"
                        class="ml-auto bg-red-500 text-white px-2 py-0.5 rounded-[10px] text-[0.7rem] font-semibold">{{ stats.total_orders }}</span>
                </a>
                <a href="#inventory"
                    class="flex items-center gap-3 py-3 px-4 mx-3 my-1 rounded-2xl text-gray-600 no-underline transition-all duration-300 cursor-pointer relative hover:bg-white hover:text-ayur-primary hover:translate-x-1 hover:shadow-[0_10px_22px_rgba(14,27,20,0.08)]"
                    data-section="inventory">
                    <i class="fas fa-boxes nav-icon"></i>
                    <span>Inventory</span>
                    <span id="badge-inventory"
                        class="ml-auto bg-red-500 text-white px-2 py-0.5 rounded-[10px] text-[0.7rem] font-semibold">{{ stats.inventory_count }}</span>
                </a>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-5 border-t border-gray-200 flex flex-col gap-2 mt-4">
                <a href="{% url 'homepage' %}"
                    class="flex items-center justify-center gap-2 px-5 py-3 rounded-2xl text-white no-underline transition-all duration-300 bg-gradient-to-br from-ayur-primary to-ayur-dark shadow-[0_12px_24px_rgba(14,27,20,0.16)] hover:translate-y-[-1px]">
                    <i class="fas fa-globe"></i>
                    <span class="font-medium">View Website</span>
                </a>
                <a href="{% url 'logout' %}"
                    class="flex items-center justify-center gap-2 px-5 py-3 rounded-2xl text-white no-underline transition-all duration-300 bg-gradient-to-br from-red-500 to-red-600 shadow-[0_12px_24px_rgba(239,68,68,0.22)] hover:translate-y-[-1px]">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="font-medium">Logout</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 min-h-screen md:ml-[292px]">
                <!-- Header -->
        <header
            class="bg-gradient-to-r from-white via-ayur-mint/2 to-white border-b border-ayur-primary/10 px-8 py-4 sticky top-0 z-50 shadow-[0_4px_16px_rgba(47,107,58,0.06)]">
            <div class="flex flex-wrap justify-between items-center gap-6">
                <div class="flex-1">
                    <p class="text-[0.7rem] section-title uppercase text-ayur-primary/70 m-0 font-bold tracking-widest">Admin Dashboard</p>
                    <h1 class="text-4xl font-bold text-ayur-dark m-0 mt-1 font-serif tracking-tight">Overview</h1>
                </div>
                <div class="flex items-center gap-4 w-full md:flex-1 md:max-w-md order-3 md:order-none">
                    <div
                        class="flex items-center gap-3 bg-white border border-ayur-primary/15 rounded-2xl px-5 py-3 w-full shadow-[0_4px_12px_rgba(47,107,58,0.04)]">
                        <i class="fas fa-magnifying-glass text-ayur-primary/50 text-sm"></i>
                        <input id="globalSearch" class="w-full bg-transparent outline-none text-sm text-ayur-dark placeholder-gray-400 font-medium"
                            placeholder="Search products..." />
                    </div>
                </div>
                <div class="flex items-center gap-3 flex-wrap">
                    <button
                        class="px-6 py-3 bg-gradient-to-br from-ayur-primary to-ayur-dark text-white rounded-2xl transition-all duration-300 hover:shadow-lg hover:translate-y-[-2px] font-semibold text-sm border-none cursor-pointer inline-flex items-center gap-2"
                        data-action="open-add-product" title="Add new product">
                        <i class="fas fa-plus"></i> New Product
                    </button>
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-ayur-primary to-ayur-dark flex items-center justify-center shadow-md border border-ayur-primary/30">
                        <i class="fas fa-user-shield text-white"></i>
                    </div>
                    <div class="hidden sm:block">
                        <h4 class="font-serif font-bold text-ayur-dark m-0 text-sm">{{ user.get_full_name|default:"Admin" }}</h4>
                        <p class="text-ayur-primary/60 text-[0.7rem] m-0 font-medium">Super Admin</p>
                    </div>
                </div>
            </div>
        </header>
        {% if messages %}
        <script>
            window.dashboardFlashMessages = [
                {% for message in messages %}
                {
                    text: "{{ message|escapejs }}",
                    tags: "{{ message.tags|default:''|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
        </script>
        {% endif %}
        <!-- Content Area -->
        <div class="p-8">
            <!-- DASHBOARD SECTION -->
            <div id="dashboard" class="content-section active">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-5 mb-8">
                    <div class="stat-card-gradient rounded-2xl p-6">
                        <div class="stat-card-icon bg-gray-100 text-gray-700">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div id="stat-total-revenue" class="text-3xl font-bold text-ayur-dark mb-2">&#8377;{{ stats.total_revenue|floatformat:0 }}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-[0.22em]">Total Revenue</div>
                    </div>

                    <div class="stat-card-gradient rounded-2xl p-6">
                        <div class="stat-card-icon bg-gray-100 text-gray-700">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div id="stat-total-orders" class="text-3xl font-bold text-ayur-dark mb-2">{{ stats.total_orders }}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-[0.22em]">Total Orders</div>
                    </div>

                    <div class="stat-card-gradient rounded-2xl p-6">
                        <div class="stat-card-icon bg-gray-100 text-gray-700">
                            <i class="fas fa-users"></i>
                        </div>
                        <div id="stat-active-users" class="text-3xl font-bold text-ayur-dark mb-2">{{ stats.active_users }}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-[0.22em]">Active Users</div>
                    </div>

                    <div class="stat-card-gradient rounded-2xl p-6">
                        <div class="stat-card-icon bg-gray-100 text-gray-700">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div id="stat-active-delivery" class="text-3xl font-bold text-ayur-dark mb-2">{{ stats.active_delivery_partners }}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-[0.22em]">Active Delivery Partners</div>
                    </div>

                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-5 mb-8">
                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Revenue</h3>
                                <p class="text-xs text-gray-500 mt-1">Filter by date range.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <select id="revenueRange"
                                    class="px-3 py-2 rounded-lg text-xs font-semibold border border-gray-200 bg-white text-gray-700 cursor-pointer">
                                    <option value="day" {% if revenue_range == 'day' %}selected{% endif %}>1 Day</option>
                                    <option value="week" {% if revenue_range == 'week' %}selected{% endif %}>1 Week</option>
                                    <option value="month" {% if revenue_range == 'month' %}selected{% endif %}>1 Month</option>
                                    <option value="year" {% if revenue_range == 'year' %}selected{% endif %}>1 Year</option>
                                    <option value="custom" {% if revenue_range == 'custom' %}selected{% endif %}>Custom</option>
                                </select>
                                <div id="revenueCustomInputs" class="flex items-center gap-2 {% if revenue_range != 'custom' %}hidden{% endif %}">
                                    <input id="revenueFrom" type="date" value="{{ revenue_from }}"
                                        class="px-3 py-2 text-xs border border-gray-200 rounded-lg text-gray-700">
                                    <span class="text-xs text-gray-400">to</span>
                                    <input id="revenueTo" type="date" value="{{ revenue_to }}"
                                        class="px-3 py-2 text-xs border border-gray-200 rounded-lg text-gray-700">
                                </div>
                                <button id="revenueApply"
                                    class="px-3 py-2 rounded-lg text-xs font-semibold border border-gray-200 bg-white text-gray-700 hover:border-ayur-primary transition-all">
                                    Apply
                                </button>
                                <span id="revenueStatus" class="text-[11px] text-gray-400"></span>
                            </div>
                        </div>
                        <div class="relative h-64">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Order Status</h3>
                        </div>
                        <div class="relative h-64">
                            <canvas id="orderChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <script id="weeklyRevenueLabels" type="application/json">{{ weekly_revenue_labels|safe }}</script>
                <script id="weeklyRevenueValues" type="application/json">{{ weekly_revenue_values|safe }}</script>
                <script id="orderStatusLabels" type="application/json">{{ order_status_labels|safe }}</script>
                <script id="orderStatusValues" type="application/json">{{ order_status_values|safe }}</script>
                <script id="monthlyRevenueLabels" type="application/json">{{ monthly_revenue_labels|safe }}</script>
                <script id="monthlyRevenueValues" type="application/json">{{ monthly_revenue_values|safe }}</script>
                <script id="categoryLabels" type="application/json">{{ category_labels|safe }}</script>
                <script id="categoryValues" type="application/json">{{ category_values|safe }}</script>
                <script id="topProductLabels" type="application/json">{{ top_product_labels|safe }}</script>
                <script id="topProductValues" type="application/json">{{ top_product_values|safe }}</script>

                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Recent Orders</h3>
                        <a href="#orders"
                            class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">View
                            All</a>
                    </div>
                    <table class="w-full border-collapse data-table">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Order ID</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Customer</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Product</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Amount</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Status</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Date</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody">
                            {% for order in recent_orders %}
                            <tr class="border-b border-gray-100 transition-all duration-300">
                                <td class="p-4 text-sm text-gray-700"><strong>#{{ order.order_number }}</strong></td>
                                <td class="p-4 text-sm text-gray-700">
                                    {{ order.full_name|default:order.user.get_full_name|default:order.user.username|default:"Customer"}}
                                </td>
                                <td class="p-4 text-sm text-gray-700">
                                    {% with first_item=order.items.first %}
                                    {% if first_item and first_item.product %}
                                    {{ first_item.product.name }}{% if order.items.count > 1 %}, +{{ order.items.count|add:"-1" }} more{% endif %}
                                    {% else %}
                                    —
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="p-4 text-sm text-gray-700"><strong>&#8377;{{ order.total_amount|floatformat:0 }}</strong></td>
                                <td class="p-4 text-sm text-gray-700">
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold
                                        {% if order.status == 'Delivered' %}bg-green-100 text-green-700
                                        {% elif order.status == 'Shipped' %}bg-blue-100 text-blue-700
                                        {% elif order.status == 'On Way' %}bg-purple-100 text-purple-700
                                        {% elif order.status == 'Cancelled' %}bg-red-100 text-red-700
                                        {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                        {{ order.status }}
                                    </span>
                                    {% if order.status == 'Cancelled' and order.cancel_reason %}
                                    <div class="mt-1 text-[11px] text-red-700">Reason: {{ order.cancel_reason }}</div>
                                    {% endif %}
                                </td>
                                <td class="p-4 text-sm text-gray-700">{{ order.created_at|date:"M j, Y" }}</td>
                                <td class="p-4 text-sm text-gray-700">
                                    <button
                                        class="order-view-btn px-4 py-2 bg-blue-500 text-white rounded-lg no-underline transition-all duration-300 hover:bg-blue-600 text-xs border-none cursor-pointer"
                                        data-order-id="{{ order.id }}">
                                        View
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td class="p-6 text-sm text-gray-500" colspan="7">No recent orders found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pending Refunds Section -->
                {% if pending_refunds %}
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass mt-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif flex items-center gap-2">
                            <i class="fas fa-money-bill-wave text-amber-600"></i>
                            Pending Refunds
                            <span class="ml-2 px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold">{{ pending_refunds.count }} Awaiting</span>
                        </h3>
                    </div>
                    <table class="w-full border-collapse data-table">
                        <thead>
                            <tr class="border-b border-gray-200 bg-amber-50">
                                <th class="text-left p-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                    Order #</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                    Customer</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                    Amount</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                    Method</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                    Bank Details</th>
                                <th class="text-center p-4 text-xs font-semibold text-gray-600 uppercase tracking-wide">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in pending_refunds %}
                            <tr class="border-b border-gray-100 transition-all duration-300 hover:bg-amber-50">
                                <td class="p-4 text-sm text-gray-700">
                                    <strong class="text-ayur-dark">#{{ payment.order.order_number }}</strong>
                                </td>
                                <td class="p-4 text-sm text-gray-700">
                                    <div class="flex flex-col">
                                        <span class="font-semibold text-gray-800">{{ payment.order.user.get_full_name }}</span>
                                        <span class="text-xs text-gray-500">{{ payment.order.user.email }}</span>
                                    </div>
                                </td>
                                <td class="p-4 text-sm text-gray-700">
                                    <strong class="text-ayur-primary text-lg">&#8377;{{ payment.amount|floatformat:2 }}</strong>
                                </td>
                                <td class="p-4 text-sm text-gray-700">
                                    <span class="px-3 py-1 rounded-lg text-xs font-bold
                                        {% if payment.payment_method == 'Bank Transfer' %}bg-blue-100 text-blue-700
                                        {% else %}bg-purple-100 text-purple-700{% endif %}">
                                        {{ payment.payment_method }}
                                    </span>
                                </td>
                                <td class="p-4 text-sm text-gray-700">
                                    <span class="text-xs text-gray-500">{{ payment.order.payment_method }}</span>
                                </td>
                                <td class="p-4 text-sm text-center">
                                    <a href="{% url 'complete_refund_payment' payment.id %}"
                                        onclick="return confirm('Mark this refund as completed and notify customer via email?')"
                                        class="inline-block px-4 py-2 bg-green-500 text-white rounded-lg no-underline transition-all duration-300 hover:bg-green-600 text-xs font-bold border-none cursor-pointer">
                                        <i class="fas fa-check-circle"></i> Complete Refund
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                        <p class="text-xs text-amber-800 m-0">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> Clicking "Complete Refund" will mark the refund as processed and send
                            an email notification to the customer.
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- SALARY PAYMENTS SECTION -->
            <div id="salary" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Salary Payments</h3>
                        <span class="text-xs text-gray-500">Pay monthly salary to delivery partners.</span>
                    </div>
                    <form id="salaryPaymentForm" method="POST" action="{% url 'process_salary_payment' %}" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6 p-4 bg-stone-50 border border-gray-200 rounded-xl">
                        {% csrf_token %}
                        <div class="md:col-span-2">
                            <label for="salaryPartner" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Delivery Partner</label>
                            <select id="salaryPartner" name="delivery_partner_id" required
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                                <option value="">Select partner</option>
                                {% for partner in all_delivery_partners %}
                                <option value="{{ partner.user.id }}"
                                    data-base-salary="{{ partner.salary }}"
                                    data-bank-holder="{{ partner.user.bank_details.account_holder_name|default:'' }}"
                                    data-bank-number="{{ partner.user.bank_details.account_number|default:'' }}"
                                    data-bank-ifsc="{{ partner.user.bank_details.ifsc_code|default:'' }}"
                                    data-bank-name="{{ partner.user.bank_details.bank_name|default:'' }}"
                                    data-bank-upi="{{ partner.user.bank_details.upi_id|default:'' }}">
                                    {{ partner.user.get_full_name|default:partner.user.username }} ({{ partner.user.username }})
                                </option>
                                {% endfor %}
                            </select>
                            <div id="salaryBankPreview" class="mt-3 p-3 rounded-lg border border-amber-200 bg-amber-50 text-xs text-amber-900">
                                Select a delivery partner to view bank details for salary transfer.
                            </div>
                        </div>
                        <div>
                            <label for="salaryMonth" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Month</label>
                            <select id="salaryMonth" name="month" required
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                                <option value="">Select month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label for="salaryYear" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Year</label>
                            <input id="salaryYear" name="year" type="number" min="2020" max="2100" required
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm">
                        </div>
                        <div>
                            <label for="salaryBase" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Base Salary</label>
                            <input id="salaryBase" name="base_salary" type="number" min="0" step="0.01"
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                placeholder="Auto from partner">
                        </div>
                        <div>
                            <label for="salaryBonus" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Bonus</label>
                            <input id="salaryBonus" name="bonus" type="number" min="0" step="0.01" value="0"
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm">
                        </div>
                        <div>
                            <label for="salaryDeduction" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Deductions</label>
                            <input id="salaryDeduction" name="deductions" type="number" min="0" step="0.01" value="0"
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm">
                        </div>
                        <div>
                            <label for="salaryPaymentMode" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Payment Mode</label>
                            <select id="salaryPaymentMode" name="payment_mode" required
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                                <option value="">Select mode</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="UPI">UPI</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="salaryNet" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Transfer Salary</label>
                            <input id="salaryNet" type="text" readonly
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm bg-gray-100 font-semibold text-ayur-dark"
                                value="₹0.00">
                        </div>
                        <div class="md:col-span-4">
                            <label for="salaryRemarks" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Remarks</label>
                            <textarea id="salaryRemarks" name="remarks" rows="2"
                                class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                placeholder="Optional notes"></textarea>
                        </div>
                        <div class="md:col-span-4 text-right">
                            <button id="salarySubmitBtn" type="submit"
                                class="px-5 py-2.5 bg-ayur-primary text-white rounded-lg transition-all duration-300 hover:bg-ayur-dark font-medium border-none cursor-pointer">
                                <i class="fas fa-check-circle mr-1"></i> Pay Salary
                            </button>
                        </div>
                    </form>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Partner</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Period</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Base</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Bonus</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Deductions</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Net</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Mode</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Transfer To</th>
                                    <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Status</th>
                                </tr>
                            </thead>
                            <tbody id="salaryPaymentsTbody">
                                {% for salary in salary_payments %}
                                <tr class="border-b border-gray-100 transition-all duration-300">
                                    <td class="p-4 text-sm text-gray-700">{{ salary.delivery_partner.get_full_name|default:salary.delivery_partner.username }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ salary.get_period_display }}</td>
                                    <td class="p-4 text-sm text-gray-700">&#8377;{{ salary.base_salary|floatformat:2 }}</td>
                                    <td class="p-4 text-sm text-gray-700">&#8377;{{ salary.bonus|floatformat:2 }}</td>
                                    <td class="p-4 text-sm text-gray-700">&#8377;{{ salary.deductions|floatformat:2 }}</td>
                                    <td class="p-4 text-sm text-gray-700 font-semibold text-ayur-dark">&#8377;{{ salary.net_salary|floatformat:2 }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ salary.payment_mode|default:"-" }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ salary.get_transfer_destination_display|default:"-" }}</td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {% if salary.status == 'Paid' %}
                                        <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">Paid</span>
                                        {% elif salary.status == 'Pending' %}
                                        <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-yellow-100 text-yellow-700">Pending</span>
                                        {% elif salary.status == 'Hold' %}
                                        <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-orange-100 text-orange-700">On Hold</span>
                                        {% else %}
                                        <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">Cancelled</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="p-6 text-center text-sm text-gray-500">No salary payment records found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RETURNS APPROVAL SECTION -->
            <div id="returns" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass mb-6">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-5">
                        <div>
                            <p class="text-[0.7rem] uppercase tracking-[0.3em] text-gray-400 m-0">Return Workflow</p>
                            <h3 class="text-2xl font-bold text-ayur-dark m-0 font-serif">Returns Approval Hub</h3>
                            <p class="text-sm text-gray-500 mt-1 m-0">Approve returns, assign pickup partners, and
                                process refunds in one flow.</p>
                        </div>
                        <div class="flex gap-2.5"></div>
                    </div>

                    <div class="flex flex-wrap gap-2 border-b border-gray-200 mb-5">
                        <button
                            class="return-tab-btn px-5 py-3 text-sm font-semibold text-ayur-primary border-b-2 border-ayur-primary transition-all duration-300 bg-transparent border-none cursor-pointer"
                            data-return-tab="approval">
                            Sale Returns
                        </button>
                        <button
                            class="return-tab-btn px-5 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:text-ayur-primary bg-transparent border-none cursor-pointer"
                            data-return-tab="pickups">
                            Active Pickups
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div
                            class="flex items-center gap-2 bg-white border border-gray-200 rounded-xl px-4 py-2 md:col-span-2">
                            <i class="fas fa-magnifying-glass text-gray-400 text-sm"></i>
                            <input type="text" id="returnSearch" placeholder="Search customer or item"
                                class="w-full bg-transparent outline-none text-sm text-gray-700">
                        </div>
                        <input type="date" id="returnDateFrom"
                            class="px-4 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-ayur-primary"
                            placeholder="From date">
                        <div class="flex gap-2">
                            <input type="date" id="returnDateTo"
                                class="px-4 py-2 border border-gray-200 rounded-xl text-sm flex-1 focus:outline-none focus:ring-2 focus:ring-ayur-primary"
                                placeholder="To date">
                            <button id="clearReturnFilters"
                                class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <div class="return-tab-panel" data-return-panel="approval">
                    <div
                        class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass mb-6">
                        <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                            <h4 class="text-lg font-semibold text-ayur-dark m-0">Return Approval</h4>
                            <span class="text-xs text-gray-500">Approve & assign pickup partner in one step.</span>
                        </div>
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Return</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Customer</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Item</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Reason</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Status</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Assign Pickup</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="returnsTableBody">
                                {% for return_request in returns %}
                                <tr class="border-b border-gray-100 transition-all duration-300 return-row"
                                    data-return-search="{{ return_request.order.full_name|default:return_request.user.get_full_name|default:return_request.user.username|default:'Customer'|lower }} {% with first_item=return_request.order.items.first %}{% if first_item and first_item.product %}{{ first_item.product.name|lower }}{% endif %}{% endwith %}"
                                    data-return-date="{{ return_request.created_at|date:"Y-m-d" }}">
                                    <td class="p-4 text-sm text-gray-700">
                                        <strong>#RET-{{ return_request.id }}</strong>
                                        <div class="text-xs text-gray-400">#{{ return_request.order.order_number }}
                                        </div>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {{ return_request.order.full_name|default:return_request.user.get_full_name|default:return_request.user.username|default:"Customer" }}
                                        <div class="text-xs text-gray-400">{{ return_request.created_at|date:"M j, Y" }}
                                        </div>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {% with first_item=return_request.order.items.first %}
                                        {% if first_item and first_item.product %}
                                        {{ first_item.product.name }}{% if return_request.order.items.count > 1 %}, +{{ return_request.order.items.count|add:"-1" }} more{% endif %}
                                        {% else %}
                                        —
                                        {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">{{ return_request.get_reason_display }}</td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <span class="px-3 py-1 rounded-[10px] text-xs font-semibold
                                            {% if return_request.status == 'Approved' %}bg-green-100 text-green-700
                                            {% elif return_request.status == 'Rejected' %}bg-red-100 text-red-700
                                            {% elif return_request.status == 'Completed' %}bg-blue-100 text-blue-700
                                            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                            {{ return_request.status }}
                                        </span>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {% if return_request.assigned_to %}
                                        <span
                                            class="inline-flex items-center gap-2 px-3 py-1 rounded-lg bg-emerald-50 text-emerald-700 text-xs font-semibold">
                                            <i class="fas fa-user-check"></i>
                                            {{ return_request.assigned_to.get_full_name|default:return_request.assigned_to.username }}
                                        </span>
                                        {% else %}
                                        <form method="post" action="{% url 'approve_return' return_request.id %}"
                                            class="flex items-center gap-2">
                                            {% csrf_token %}
                                            <select name="assigned_to"
                                                class="px-3 py-2 border border-gray-200 rounded-lg text-xs bg-white focus:outline-none focus:ring-2 focus:ring-ayur-primary cursor-pointer">
                                                <option value="">Select Partner</option>
                                                {% for partner in all_delivery_partners %}
                                                <option value="{{ partner.user.id }}">
                                                    {{ partner.user.get_full_name|default:partner.user.username }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <button type="submit"
                                                class="px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-semibold hover:bg-emerald-700 transition-all duration-300 border-none cursor-pointer">
                                                Approve & Assign
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <div class="flex flex-col gap-2">
                                            {% if return_request.status != 'Rejected' and return_request.status != 'Completed' %}
                                            <form method="post" action="{% url 'reject_return' return_request.id %}">
                                                {% csrf_token %}
                                                <button type="submit"
                                                    class="w-full px-4 py-2 bg-red-500 text-white rounded-lg text-xs font-semibold hover:bg-red-600 transition-all duration-300 border-none cursor-pointer">Reject</button>
                                            </form>
                                            {% endif %}
                                            <button
                                                class="return-view-btn px-4 py-2 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition-all duration-300 border-none cursor-pointer inline-flex items-center justify-center gap-2"
                                                data-return-id="{{ return_request.id }}"
                                                data-order="{{ return_request.order.order_number }}"
                                                data-customer="{{ return_request.order.full_name|default:return_request.user.get_full_name|default:return_request.user.username|default:'Customer' }}"
                                                data-reason="{{ return_request.get_reason_display }}"
                                                data-status="{{ return_request.status }}"
                                                data-payment="{{ return_request.order.payment_method|default:'N/A' }}"
                                                data-date="{{ return_request.created_at|date:'M d, Y' }}"
                                                data-assigned="{% if return_request.assigned_to %}{{ return_request.assigned_to.get_full_name|default:return_request.assigned_to.username }}{% else %}Unassigned{% endif %}">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td class="p-6 text-sm text-gray-500" colspan="7">No return requests found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                            <h4 class="text-lg font-semibold text-ayur-dark m-0">Pickup Completed (Ready for Refund)
                            </h4>
                            <span class="text-xs text-gray-500">Inspect items and trigger refunds.</span>
                        </div>
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Item</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Reason</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Amount</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                {% if returns_ready_for_refund %}
                                {% for return_request in returns_ready_for_refund %}
                                <tr class="border-b border-gray-100 transition-all duration-300">
                                    <td class="p-4 text-sm text-gray-700">
                                        {% with first_item=return_request.order.items.first %}
                                        {% if first_item and first_item.product %}
                                        <div class="font-semibold text-gray-800">{{ first_item.product.name }}</div>
                                        <div class="text-xs text-gray-500">{{return_request.order.full_name|default:return_request.user.get_full_name|default:"Customer" }}</div>
                                        {% else %}
                                        —
                                        {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">{{ return_request.get_reason_display }}</td>
                                    <td class="p-4 text-sm text-gray-700"><strong>&#8377;{{ return_request.refund_amount|default:return_request.order.total_amount|floatformat:2 }}</strong></td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <button
                                            class="return-refund-btn px-4 py-2 text-xs font-semibold text-white bg-ayur-primary rounded-lg transition-all duration-300 hover:bg-ayur-dark border-none cursor-pointer"
                                            data-return-id="{{ return_request.id }}"
                                            data-item="{% with first_item=return_request.order.items.first %}{% if first_item and first_item.product %}{{ first_item.product.name }}{% endif %}{% endwith %}"
                                            data-customer="{{return_request.order.full_name|default:return_request.user.get_full_name|default:return_request.user.username|default:'Customer' }}"
                                            data-reason="{{ return_request.get_reason_display }}"
                                            data-amount="{{ return_request.refund_amount|default:return_request.order.total_amount|floatformat:2 }}">
                                            Inspect & Refund
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td class="p-6 text-sm text-gray-500" colspan="4">No pickup completed returns.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="return-tab-panel hidden" data-return-panel="pickups">
                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                            <h4 class="text-lg font-semibold text-ayur-dark m-0">Active Pickups</h4>
                            <span class="text-xs text-gray-500">Approved returns awaiting pickup completion.</span>
                        </div>
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Return</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Customer</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Pickup Partner</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Pickup Window</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Status</th>
                                </tr>
                            </thead>
                            <tbody id="partnersTableBody">
                                {% if active_pickups %}
                                {% for pickup in active_pickups %}
                                <tr class="border-b border-gray-100 transition-all duration-300">
                                    <td class="p-4 text-sm text-gray-700"><strong>#RET-{{ pickup.id }}</strong></td>
                                    <td class="p-4 text-sm text-gray-700">{{ pickup.order.full_name|default:pickup.user.get_full_name|default:pickup.user.username|default:"Customer" }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ pickup.assigned_to.get_full_name|default:pickup.assigned_to.username }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ pickup.pickup_window|default:"Today, 3PM - 6PM" }}</td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-blue-100 text-blue-700">On
                                            the Way</span>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td class="p-6 text-sm text-gray-500" colspan="5">No active pickups scheduled.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="refunds" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass mb-6">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <h3 class="text-2xl font-bold text-ayur-dark m-0 font-serif">Refunds</h3>
                        <span class="text-xs text-gray-500">Cancelled order refunds and return refunds.</span>
                    </div>
                </div>

                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass mb-6">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <h4 class="text-lg font-semibold text-ayur-dark m-0">Cancelled Order Refunds</h4>
                        <span class="text-xs text-gray-500">Orders cancelled after online payment.</span>
                    </div>
                    <table class="w-full border-collapse data-table">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Order</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Customer</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Paid Amount</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Method</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Status</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Cancelled On</th>
                            </tr>
                        </thead>
                        <tbody id="cancelledRefundsTableBody">
                            {% for row in cancelled_refund_rows %}
                            <tr class="border-b border-gray-100 transition-all duration-300">
                                <td class="p-4 text-sm text-gray-700"><strong>#{{ row.order.order_number }}</strong></td>
                                <td class="p-4 text-sm text-gray-700">{{ row.order.full_name|default:row.order.user.get_full_name|default:row.order.user.username|default:"Customer" }}</td>
                                <td class="p-4 text-sm text-gray-700"><strong>&#8377;{{ row.refund_amount|floatformat:2 }}</strong></td>
                                <td class="p-4 text-sm text-gray-700">{{ row.order.payment_method|default:"Online" }}</td>
                                <td class="p-4 text-sm text-gray-700">
                                    {% if row.display_status == 'Paid' %}
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">PAID</span>
                                    {% elif row.display_status == 'Pending' %}
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-yellow-100 text-yellow-700">PENDING</span>
                                    {% else %}
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">{{ row.display_status|upper }}</span>
                                    {% endif %}
                                </td>
                                <td class="p-4 text-sm text-gray-700">{{ row.updated_at|date:"M d, Y h:i A" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td class="p-6 text-sm text-gray-500" colspan="6">No cancelled order refunds found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <h4 class="text-lg font-semibold text-ayur-dark m-0">Return Refunds</h4>
                        <span class="text-xs text-gray-500">Refunds processed from return requests.</span>
                    </div>
                    <table class="w-full border-collapse data-table">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Refund ID</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Order</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Customer</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Refund Amount</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Damage</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Status</th>
                                <th class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">Processed On</th>
                            </tr>
                        </thead>
                        <tbody id="refundsTableBody">
                            {% for refund in refunds %}
                            <tr class="border-b border-gray-100 transition-all duration-300">
                                <td class="p-4 text-sm text-gray-700"><strong>{{ refund.refund_id|default:refund.id }}</strong></td>
                                <td class="p-4 text-sm text-gray-700">#{{ refund.order.order_number }}</td>
                                <td class="p-4 text-sm text-gray-700">{{ refund.order.full_name|default:refund.order.user.get_full_name|default:refund.order.user.username|default:"Customer" }}</td>
                                <td class="p-4 text-sm text-gray-700"><strong>&#8377;{{ refund.amount|floatformat:2 }}</strong></td>
                                <td class="p-4 text-sm text-gray-700">&#8377;{{ refund.damage_amount|floatformat:2 }}</td>
                                <td class="p-4 text-sm text-gray-700">
                                    {% if refund.status == 'Processed' %}
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">PROCESSED</span>
                                    {% elif refund.status == 'Pending' %}
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-yellow-100 text-yellow-700">PENDING</span>
                                    {% else %}
                                    <span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">{{ refund.status|upper }}</span>
                                    {% endif %}
                                </td>
                                <td class="p-4 text-sm text-gray-700">
                                    {% if refund.processed_at %}{{ refund.processed_at|date:"M d, Y h:i A" }}{% else %}{{ refund.created_at|date:"M d, Y h:i A" }}{% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td class="p-6 text-sm text-gray-500" colspan="7">No return refunds found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- INSPECT & REFUND MODAL -->
            <div id="refundInspectModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[520px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <button id="closeRefundInspectModal"
                        class="absolute top-5 right-5 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="p-6">
                        <div class="bg-ayur-dark text-white rounded-2xl p-5 mb-5">
                            <h3 class="text-xl font-serif font-bold m-0">Inspect & Refund</h3>
                            <p class="text-xs text-gray-200 mt-1 m-0">Review return details and finalize refund.</p>
                            <span id="refundInspectReturnId"
                                class="inline-flex items-center gap-2 mt-3 px-3 py-1 rounded-full text-xs font-semibold bg-white/10">
                                Return ID: —
                            </span>
                        </div>

                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 mb-5">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Item</span>
                                <span id="refundInspectItem" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Customer</span>
                                <span id="refundInspectCustomer" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Reason</span>
                                <span id="refundInspectReason" class="font-semibold text-gray-800">—</span>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Damage
                                    Amount (&#8377;)</label>
                                <input id="refundDamageAmount" type="number" min="0" value="0"
                                    class="w-full mt-2 px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-ayur-primary">
                                <p class="text-xs text-gray-400 mt-2">This reduces the refund shown below (display
                                    only).</p>
                            </div>
                            <div
                                class="flex justify-between items-center bg-emerald-50 border border-emerald-100 rounded-2xl px-4 py-3">
                                <span class="text-sm font-semibold text-emerald-700">Refund Amount</span>
                                <span id="refundFinalAmount"
                                    class="text-xl font-bold text-emerald-700">&#8377;0.00</span>
                            </div>
                        </div>

                        <div class="mt-6 space-y-3">
                            <button id="processRefundBtn"
                                class="w-full px-4 py-3 bg-ayur-primary text-white rounded-2xl font-semibold transition-all duration-300 hover:bg-ayur-dark border-none cursor-pointer">
                                Process Refund
                            </button>
                            <button id="cancelRefundBtn"
                                class="w-full px-4 py-3 bg-gray-100 text-gray-600 rounded-2xl font-semibold transition-all duration-300 hover:bg-gray-200 border-none cursor-pointer">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RETURN DETAILS MODAL -->
            <div id="returnDetailsModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[520px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <button id="closeReturnDetailsModal"
                        class="absolute top-5 right-5 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="p-6">
                        <div class="bg-ayur-dark text-white rounded-2xl p-5 mb-5">
                            <h3 class="text-xl font-serif font-bold m-0">Return Details</h3>
                            <p class="text-xs text-gray-200 mt-1 m-0" id="returnDetailsId">Return ID: —</p>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 space-y-3">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Order</span>
                                <span id="returnDetailsOrder" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Customer</span>
                                <span id="returnDetailsCustomer" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Reason</span>
                                <span id="returnDetailsReason" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Status</span>
                                <span id="returnDetailsStatus" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Payment Mode</span>
                                <span id="returnDetailsPayment" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Assigned To</span>
                                <span id="returnDetailsAssigned" class="font-semibold text-gray-800">—</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Requested On</span>
                                <span id="returnDetailsDate" class="font-semibold text-gray-800">—</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ORDERS SECTION -->
            <div id="orders" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                    <!-- Header -->
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-ayur-dark m-0 font-serif mb-1">Manage Orders</h3>
                        <p class="text-gray-500 text-sm m-0">Track fulfillment, assign drivers, and resolve issues
                            faster.</p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 mb-6 border-b border-gray-200">
                        <button
                            class="order-tab-btn active px-6 py-3 text-sm font-semibold text-ayur-primary border-b-2 border-ayur-primary transition-all duration-300 bg-transparent border-none cursor-pointer"
                            data-tab="all">
                            All Orders
                            <span
                                class="ml-2 px-2 py-0.5 text-[0.7rem] rounded-full bg-ayur-mint text-ayur-dark font-semibold">{{ order_counts.total }}</span>
                        </button>
                        <button
                            class="order-tab-btn px-6 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:text-ayur-primary bg-transparent border-none cursor-pointer"
                            data-tab="unassigned">
                            Unassigned Driver
                            <span
                                class="ml-2 px-2 py-0.5 text-[0.7rem] rounded-full bg-yellow-100 text-yellow-700 font-semibold">{{ order_counts.unassigned }}</span>
                        </button>
                        <button
                            class="order-tab-btn px-6 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:text-ayur-primary bg-transparent border-none cursor-pointer"
                            data-tab="assigned">
                            Assigned Driver
                            <span
                                class="ml-2 px-2 py-0.5 text-[0.7rem] rounded-full bg-blue-100 text-blue-700 font-semibold">{{ order_counts.assigned }}</span>
                        </button>
                    </div>

                    <!-- Filters & Search -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                        <div class="flex items-center gap-2 bg-white border border-gray-300 rounded-lg px-4 py-2">
                            <i class="fas fa-magnifying-glass text-gray-400 text-sm"></i>
                            <input type="text" id="orderSearch" placeholder="Search by ID or customer"
                                class="w-full bg-transparent outline-none text-sm text-gray-700">
                        </div>
                        <select id="orderStatus"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-ayur-primary cursor-pointer">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Shipped">Shipped</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <input type="date" id="orderDateFrom" placeholder="From Date"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-ayur-primary">
                        <div class="flex gap-2">
                            <input type="date" id="orderDateTo" placeholder="To Date"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-sm flex-1 focus:outline-none focus:ring-2 focus:ring-ayur-primary">
                            <button id="clearFilters"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">
                                Clear
                            </button>
                        </div>
                    </div>

                    <!-- Orders Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        ID</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Customer</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Date</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Amount</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Status</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Assign Driver</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                {% for order in all_orders %}
                                <tr class="border-b border-gray-100 transition-all duration-300 order-row"
                                    data-order-id="{{ order.id }}"
                                    data-assigned-driver="{{ order.assigned_to.id|default:'' }}"
                                    data-order-status="{{ order.status }}"
                                    data-order-date="{{ order.created_at|date:"Y-m-d" }}"
                                    data-customer="{{ order.full_name|default:order.user.get_full_name|default:order.user.username|default:'Guest' }}">
                                    <td class="p-4 text-sm text-gray-700"><strong>#{{ order.order_number }}</strong>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {{ order.full_name|default:order.user.get_full_name|default:order.user.username|default:"Guest" }}
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">{{ order.created_at|date:"M d, Y" }}</td>
                                    <td class="p-4 text-sm text-gray-700"><strong>&#8377;{{ order.total_amount|floatformat:0 }}</strong></td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {% if order.status == 'Delivered' %}
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">DELIVERED</span>
                                        {% elif order.status == 'Pending' %}
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-yellow-100 text-yellow-700">PENDING</span>
                                        {% elif order.status == 'Shipped' %}
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-blue-100 text-blue-700">SHIPPED</span>
                                        {% elif order.status == 'Out for Delivery' %}
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-sky-100 text-sky-700">OUT
                                            FOR DELIVERY</span>
                                        {% elif order.status == 'Cancelled' %}
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">CANCELLED</span>
                                        {% if order.cancel_reason %}
                                        <div class="mt-1 text-[11px] text-red-700">Reason: {{ order.cancel_reason }}</div>
                                        {% endif %}
                                        {% else %}
                                        <span
                                            class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-gray-100 text-gray-700">{{ order.status|upper }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <div class="flex items-center gap-2">
                                            <select
                                                class="px-3 py-1 border border-gray-300 rounded-lg text-xs bg-white focus:outline-none focus:ring-2 focus:ring-ayur-primary cursor-pointer driver-select"
                                                data-order-id="{{ order.id }}">
                                                <option value="">Select Driver</option>
                                                {% for partner in all_delivery_partners %}
                                                <option value="{{ partner.user.id }}" {% if order.assigned_to.id == partner.user.id %}selected{% endif %}>
                                                    {{ partner.user.get_full_name|default:partner.user.username }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <button
                                                class="px-3 py-2 text-ayur-primary bg-ayur-mint rounded-lg transition-all duration-300 border-none cursor-pointer hover:bg-ayur-primary hover:text-white text-sm font-semibold">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <button
                                            class="order-view-btn px-4 py-2 text-xs font-semibold text-white bg-ayur-dark rounded-lg transition-all duration-300 hover:bg-ayur-primary border-none cursor-pointer"
                                            data-order-id="{{ order.id }}" data-order="{{ order|safe }}">
                                            View
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="p-6 text-center text-sm text-gray-500">No orders found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-3 mt-6">
                        <p id="orderCount" class="text-sm text-gray-500">Showing 0-0 of 0</p>
                        <div class="flex items-center gap-2">
                            <button id="orderPrev"
                                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-semibold text-gray-600 hover:text-ayur-primary hover:border-ayur-primary">Prev</button>
                            <select id="orderPerPage"
                                class="px-3 py-2 rounded-full border border-gray-200 text-xs text-gray-600">
                                <option value="10" selected>10 / page</option>
                                <option value="20">20 / page</option>
                                <option value="50">50 / page</option>
                            </select>
                            <button id="orderNext"
                                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-semibold text-gray-600 hover:text-ayur-primary hover:border-ayur-primary">Next</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ORDER DETAIL MODAL -->
            <div id="orderModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[720px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <!-- Close Button -->
                    <button id="closeOrderModal"
                        class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer z-10">
                        <i class="fas fa-times text-lg"></i>
                    </button>

                    <div class="p-6 md:p-8">
                        <!-- Invoice Header -->
                        <div
                            class="bg-ayur-dark text-white rounded-2xl p-6 mb-6 -mx-6 -mt-6 md:-mx-8 md:-mt-8 rounded-b-2xl mb-8">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xs uppercase tracking-wider text-gray-300 mb-1">INVOICE OVERVIEW</p>
                                    <h2 id="modalOrderNumber" class="text-3xl font-serif font-bold text-white">Order
                                        #52426</h2>
                                </div>
                                <div class="flex gap-2">
                                    <a id="modalInvoiceLink" href="#" target="_blank" rel="noopener"
                                        class="px-4 py-2 bg-white text-ayur-dark rounded-lg text-sm font-semibold transition-all duration-300 hover:bg-gray-100 border-none cursor-pointer inline-flex items-center gap-2">
                                        <i class="fas fa-eye"></i> View Invoice
                                    </a>
                                    <button
                                        class="px-4 py-2 bg-white text-ayur-dark rounded-lg text-sm font-semibold transition-all duration-300 hover:bg-gray-100 border-none cursor-pointer">
                                        <i class="fas fa-envelope"></i> Email PDF
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-8 text-sm">
                                <div>
                                    <p class="text-gray-300 text-xs uppercase tracking-wider mb-1">ITEMS</p>
                                    <p id="modalItemCount" class="text-lg font-semibold">1</p>
                                </div>
                                <div>
                                    <p class="text-gray-300 text-xs uppercase tracking-wider mb-1">TOTAL</p>
                                    <p id="modalTotal" class="text-lg font-semibold">₹20999.00</p>
                                </div>
                            </div>
                        </div>

                        <!-- Amount Section -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">AMOUNT DUE</p>
                                <p id="modalAmountDue" class="text-2xl font-bold text-ayur-dark">₹20999.00</p>
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">AMOUNT PAID</p>
                                <p id="modalAmountPaid" class="text-2xl font-bold text-green-600">₹0.00</p>
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">ORDER TOTAL</p>
                                <p id="modalOrderTotal" class="text-2xl font-bold text-ayur-dark">₹20999.00</p>
                            </div>
                        </div>

                        <!-- Line Items -->
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-4">LINE ITEMS</h3>
                            <p class="text-xs text-gray-500 mb-4">Products and rentals included in this order.</p>
                            <div id="modalLineItems" class="space-y-3">
                                <!-- Items will be populated here -->
                            </div>

                            <!-- Summary -->
                            <div class="mt-6 space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span id="modalSubtotal" class="font-semibold">₹20999.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Shipping</span>
                                    <span id="modalShipping" class="font-semibold">₹0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Discount</span>
                                    <span id="modalDiscount" class="font-semibold">-₹0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tax</span>
                                    <span id="modalTax" class="font-semibold">₹0.00</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-200 pt-2 font-bold text-gray-800">
                                    <span>Total</span>
                                    <span id="modalTotalSummary">₹20999.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Info -->
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-4">CUSTOMER</h3>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                <p id="modalCustomerName" class="font-semibold text-gray-800 mb-2">Rashmit Raigani</p>
                                <p id="modalCustomerEmail" class="text-sm text-gray-600 mb-1">raigani2007@gmail.com</p>
                                <p id="modalCustomerPhone" class="text-sm text-gray-600 mb-3">+91-98765-43210</p>
                                <p id="modalCustomerAddress" class="text-xs text-gray-500">prempara, visanagar,
                                    ljanagrad - 362530, Prempara</p>
                            </div>
                        </div>

                        <!-- Delivery Partner -->
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-4">DELIVERY
                                PARTNER</h3>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p id="modalDriverName" class="font-semibold text-gray-800">Not Assigned</p>
                                        <p class="text-xs text-gray-500">Partner rating summary</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">Avg Rating</p>
                                        <p class="text-lg font-semibold text-gray-800">
                                            <span id="modalDriverRating">—</span>
                                            <span class="text-xs text-gray-400">/ 5</span>
                                        </p>
                                        <p class="text-xs text-gray-500"><span id="modalDriverReviews">0</span> reviews
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Info -->
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-4">PAYMENT</h3>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-600">Method</span>
                                    <span id="modalPaymentMethod" class="font-semibold text-gray-800">Cash on
                                        Delivery</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Status</span>
                                    <span id="modalPaymentStatus"
                                        class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-yellow-100 text-yellow-700">PENDING</span>
                                </div>
                                <div id="modalCancelReasonRow" class="flex justify-between items-center mt-2 hidden">
                                    <span class="text-gray-600">Cancel Reason</span>
                                    <span id="modalCancelReason" class="font-semibold text-red-700">N/A</span>
                                </div>
                            </div>
                        </div>

                        <!-- Shipment Timeline -->
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-4">SHIPMENT
                                TIMELINE</h3>
                            <div class="space-y-3" id="modalTimeline">
                                <!-- Timeline events will be populated here -->
                            </div>
                        </div>

                        <!-- Fulfillment -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-4">FULFILLMENT
                            </h3>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 space-y-4">
                                <div>
                                    <label class="text-sm text-gray-600 font-semibold mb-2 block">Status</label>
                                    <select id="modalFulfillmentStatus"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-ayur-primary cursor-pointer">
                                        <option value="Pending">Pending</option>
                                        <option value="Shipped">Shipped</option>
                                        <option value="Out for Delivery">Out for Delivery</option>
                                        <option value="Delivered">Delivered</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-600 font-semibold mb-2 block">Assign Driver</label>
                                    <select id="modalAssignDriver"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-ayur-primary cursor-pointer">
                                        <option value="">Select Driver...</option>
                                        {% for partner in all_delivery_partners %}
                                        <option value="{{ partner.user.id }}">{{ partner.user.get_full_name|default:partner.user.username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button id="updateOrderBtn"
                                    class="w-full px-4 py-3 bg-ayur-dark text-white rounded-lg font-semibold transition-all duration-300 hover:bg-ayur-primary border-none cursor-pointer mt-4">
                                    Update Order
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DELIVERY PARTNER REVIEWS MODAL -->
            <div id="partnerReviewModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[720px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <button id="closePartnerReviewModal"
                        class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer z-10">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="p-6 md:p-8">
                        <div
                            class="bg-ayur-dark text-white rounded-2xl p-6 mb-6 -mx-6 -mt-6 md:-mx-8 md:-mt-8 rounded-b-2xl mb-6">
                            <p class="text-xs uppercase tracking-wider text-gray-300 mb-1">DELIVERY PARTNER REVIEWS</p>
                            <h2 id="partnerReviewName" class="text-3xl font-serif font-bold text-white">Partner</h2>
                            <div class="mt-4 flex gap-8 text-sm">
                                <div>
                                    <p class="text-gray-300 text-xs uppercase tracking-wider mb-1">AVG RATING</p>
                                    <p class="text-lg font-semibold"><span id="partnerReviewAvg">—</span> / 5</p>
                                </div>
                                <div>
                                    <p class="text-gray-300 text-xs uppercase tracking-wider mb-1">TOTAL REVIEWS</p>
                                    <p id="partnerReviewCount" class="text-lg font-semibold">0</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-3 mb-6">
                            <div class="flex items-center gap-2">
                                <button
                                    class="partner-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-800 text-white"
                                    data-rating="all">All</button>
                                <button
                                    class="partner-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700"
                                    data-rating="5">5★</button>
                                <button
                                    class="partner-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700"
                                    data-rating="4">4★</button>
                                <button
                                    class="partner-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700"
                                    data-rating="3">3★</button>
                                <button
                                    class="partner-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700"
                                    data-rating="2">2★</button>
                                <button
                                    class="partner-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700"
                                    data-rating="1">1★</button>
                            </div>
                            <div class="flex items-center gap-2 ml-auto">
                                <input id="partnerReviewFrom" type="date"
                                    class="px-3 py-1.5 text-xs border border-gray-300 rounded-lg text-gray-700">
                                <span class="text-xs text-gray-400">to</span>
                                <input id="partnerReviewTo" type="date"
                                    class="px-3 py-1.5 text-xs border border-gray-300 rounded-lg text-gray-700">
                            </div>
                        </div>

                        <div id="partnerReviewList" class="space-y-4">
                            <!-- Reviews will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS SECTION -->
            <div id="analytics" class="content-section">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-5 mb-8">
                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Sales by Category</h3>
                        </div>
                        <div class="relative h-64">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Top Products</h3>
                        </div>
                        <div class="relative h-64">
                            <canvas id="productsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORTS SECTION -->
            <div id="reports" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass mb-6">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div>
                            <h3 class="text-xl font-bold text-ayur-dark m-0 font-serif">Reports Center</h3>
                            <p class="text-gray-500 text-sm mt-2 m-0">Schedule, export, and share performance snapshots.
                            </p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button
                                class="px-5 py-2.5 bg-ayur-primary text-white rounded-2xl transition-all duration-300 hover:bg-ayur-dark font-medium border-none cursor-pointer">
                                <i class="fas fa-file-export"></i> Export CSV
                            </button>
                            <button
                                class="px-5 py-2.5 rounded-2xl text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">
                                <i class="fas fa-calendar-check"></i> Schedule
                            </button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-5">
                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <h4 class="font-semibold text-ayur-dark m-0">Revenue Summary</h4>
                        <p class="text-gray-500 text-sm mt-2">Last 30 days performance, channel split, and growth notes.
                        </p>
                        <button
                            class="mt-4 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">
                            Download PDF
                        </button>
                    </div>
                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <h4 class="font-semibold text-ayur-dark m-0">Inventory Risk</h4>
                        <p class="text-gray-500 text-sm mt-2">Low stock alerts, reorder dates, and supplier timelines.
                        </p>
                        <button
                            class="mt-4 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">
                            View Report
                        </button>
                    </div>
                    <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                        <h4 class="font-semibold text-ayur-dark m-0">Customer Insights</h4>
                        <p class="text-gray-500 text-sm mt-2">Repeat rate, cohorts, and top lifetime value segments.</p>
                        <button
                            class="mt-4 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">
                            Open Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- INVENTORY SECTION -->
            <div id="inventory" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-ayur-dark m-0 font-serif">Inventory</h3>
                            <p class="text-gray-500 text-sm mt-1 m-0">Manage your product catalog</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="openInventoryCategories"
                                class="px-4 py-2 rounded-full border border-gray-200 bg-white text-xs font-semibold uppercase tracking-wider text-gray-700 hover:border-ayur-primary hover:text-ayur-primary transition-all">
                                <i class="fas fa-folder-open"></i> Categories
                            </button>
                            <button id="openInventoryAddProduct"
                                class="px-5 py-2.5 rounded-full bg-ayur-dark text-white text-xs font-semibold uppercase tracking-wider shadow-[0_10px_22px_rgba(14,27,20,0.16)] hover:bg-ayur-primary transition-all">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-3 mb-6">
                        <div
                            class="flex items-center gap-2 bg-white border border-gray-200 rounded-full px-4 py-2 shadow-[0_8px_16px_rgba(14,27,20,0.06)]">
                            <i class="fas fa-magnifying-glass text-gray-400 text-sm"></i>
                            <input id="inventorySearch" class="w-52 bg-transparent outline-none text-sm text-gray-700"
                                placeholder="Search product name" />
                        </div>
                        <select id="inventoryCategory"
                            class="px-4 py-2 rounded-full border border-gray-200 bg-white text-sm text-gray-600">
                            <option value="all">All Categories</option>
                        </select>
                        <select id="inventoryStock"
                            class="px-4 py-2 rounded-full border border-gray-200 bg-white text-sm text-gray-600">
                            <option value="all">All Stock</option>
                            <option value="in">In Stock</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                        </select>
                        <button id="inventoryClear"
                            class="ml-auto px-4 py-2 rounded-full border border-gray-200 bg-white text-xs font-semibold uppercase tracking-wider text-gray-600 hover:text-ayur-primary hover:border-ayur-primary transition-all">Clear</button>
                    </div>

                    <div id="inventoryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                    </div>

                    <div class="flex flex-wrap items-center justify-between gap-3 mt-6">
                        <p id="inventoryCount" class="text-sm text-gray-500">Showing 0-0 of 0</p>
                        <div class="flex items-center gap-2">
                            <button id="inventoryPrev"
                                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-semibold text-gray-600 hover:text-ayur-primary hover:border-ayur-primary">Prev</button>
                            <select id="inventoryPerPage"
                                class="px-3 py-2 rounded-full border border-gray-200 text-xs text-gray-600">
                                <option value="8" selected>8 / page</option>
                                <option value="12">12 / page</option>
                                <option value="16">16 / page</option>
                            </select>
                            <button id="inventoryNext"
                                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-semibold text-gray-600 hover:text-ayur-primary hover:border-ayur-primary">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <script id="inventoryData" type="application/json">{{ inventory_data_json|safe }}</script>
            <script id="inventoryCategories" type="application/json">{{ inventory_categories_json|safe }}</script>
            <script id="inventoryTags" type="application/json">{{ inventory_tags_json|safe }}</script>

            <!-- INVENTORY MANAGE MODAL -->
            <div id="inventoryManageModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[820px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <button id="closeInventoryManage"
                        class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer z-10">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="p-6 md:p-8">
                        <div
                            class="bg-ayur-dark text-white rounded-2xl p-6 mb-6 -mx-6 -mt-6 md:-mx-8 md:-mt-8 rounded-b-2xl">
                            <p class="text-xs uppercase tracking-wider text-gray-300 mb-1">Manage</p>
                            <h2 class="text-2xl font-serif font-bold text-white"><span
                                    id="inventoryManageTitle">Product</span></h2>
                        </div>

                        <div class="flex items-center gap-3 border-b border-gray-200 mb-6">
                            <button
                                class="inventory-tab-btn px-4 py-2 text-sm font-semibold text-ayur-primary border-b-2 border-ayur-primary"
                                data-inventory-tab="variants">Stock & Variants</button>
                            <button
                                class="inventory-tab-btn px-4 py-2 text-sm font-semibold text-gray-500 border-b-2 border-transparent"
                                data-inventory-tab="details">Edit Details</button>
                        </div>

                        <div id="inventoryTabVariants">
                            <div class="overflow-x-auto border border-gray-200 rounded-2xl">
                                <table class="w-full text-sm min-w-[900px] table-fixed">
                                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs whitespace-nowrap">
                                        <tr>
                                            <th class="text-left p-3 w-20">Size</th>
                                            <th class="text-left p-3 w-20">Unit</th>
                                            <th class="text-left p-3 w-44">Batch Number</th>
                                            <th class="text-left p-3 w-24">Stock</th>
                                            <th class="text-left p-3 w-28">Sale Price</th>
                                            <th class="text-left p-3 w-28">Mfg</th>
                                            <th class="text-left p-3 w-28">Expiry</th>
                                            <th class="text-left p-3 w-16">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryVariantList" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>

                            <div class="mt-4 p-4 border border-gray-200 rounded-2xl bg-gray-50">
                                <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Add New Variant</p>
                                <div class="overflow-x-auto border border-gray-200 rounded-2xl bg-white">
                                    <table class="w-full text-sm min-w-[900px] table-fixed">
                                        <tbody>
                                            <tr>
                                                <td class="p-3 w-20">
                                                    <input id="newVariantSize"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs"
                                                        placeholder="Size" type="number" min="1">
                                                </td>
                                                <td class="p-3 w-20">
                                                    <select id="newVariantUnit"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs">
                                                        <option value="ml">ml</option>
                                                        <option value="g">g</option>
                                                        <option value="kg">kg</option>
                                                        <option value="l">l</option>
                                                        <option value="pc">pc</option>
                                                    </select>
                                                </td>
                                                <td class="p-3 w-44">
                                                    <input id="newVariantBatch"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs"
                                                        placeholder="Batch Number">
                                                </td>
                                                <td class="p-3 w-24">
                                                    <input id="newVariantStock"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs"
                                                        placeholder="Stock" type="number" min="0">
                                                </td>
                                                <td class="p-3 w-28">
                                                    <input id="newVariantPrice"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs"
                                                        placeholder="Sale" type="number" min="0" step="0.01">
                                                </td>
                                                <td class="p-3 w-28">
                                                    <input id="newVariantMfg"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs"
                                                        type="date">
                                                </td>
                                                <td class="p-3 w-28">
                                                    <input id="newVariantExpiry"
                                                        class="w-full px-2 py-1 rounded border border-gray-200 text-xs"
                                                        type="date">
                                                </td>
                                                <td class="p-3 w-16">
                                                    <button id="addVariantBtn"
                                                        class="px-3 py-2 rounded-lg bg-ayur-dark text-white text-xs font-semibold uppercase tracking-wider w-full">Add</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p id="variantError" class="text-xs text-red-500 mt-2 hidden">Please fill all variant
                                    fields.</p>
                            </div>
                        </div>

                        <div id="inventoryTabDetails" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Name</label>
                                    <input id="inventoryDetailName"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        placeholder="Product name">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Category</label>
                                    <select id="inventoryDetailCategory"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"></select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Sub Category</label>
                                    <select id="inventoryDetailSubcategory"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"></select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Tags (Comma
                                        Separated)</label>
                                    <input id="inventoryDetailTags"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        placeholder="e.g., Herbal, Wedding" list="inventoryTagList">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Description</label>
                                    <textarea id="inventoryDetailDescription"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        rows="4"></textarea>
                                </div>
                                <div class="md:col-span-2 flex items-center gap-6">
                                    <label class="flex items-center gap-2 text-sm text-gray-600">
                                        <input id="inventoryDetailActive" type="checkbox" class="accent-ayur-primary">
                                        Active
                                    </label>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Update Main
                                        Thumbnail</label>
                                    <input id="inventoryDetailThumbnail" type="file" class="w-full mt-2 text-xs">
                                    <div id="inventoryDetailThumbnailPreview"
                                        class="mt-3 w-20 h-20 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-400">
                                        Preview</div>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Add to Gallery
                                        (Optional)</label>
                                    <input id="inventoryDetailGallery" type="file" class="w-full mt-2 text-xs" multiple>
                                    <div id="inventoryDetailGalleryPreview" class="flex flex-wrap gap-2 mt-3"></div>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Gallery Images</label>
                                    <div id="inventoryGalleryPreview" class="flex flex-wrap gap-3 mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button id="inventorySaveBtn"
                                class="px-5 py-2 rounded-lg bg-ayur-dark text-white text-xs font-semibold uppercase tracking-wider">Update
                                Details</button>
                            <button id="inventoryDeleteBtn"
                                class="px-5 py-2 rounded-lg bg-red-500 text-white text-xs font-semibold uppercase tracking-wider">Delete
                                Product</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTORY CATEGORIES MODAL -->
            <div id="inventoryCategoryModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[520px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <button id="closeInventoryCategory"
                        class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer z-10">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="p-6 md:p-8">
                        <div
                            class="bg-ayur-dark text-white rounded-2xl p-6 mb-6 -mx-6 -mt-6 md:-mx-8 md:-mt-8 rounded-b-2xl">
                            <p class="text-xs uppercase tracking-wider text-gray-300 mb-1">Manage Categories</p>
                            <h2 class="text-2xl font-serif font-bold text-white">Categories</h2>
                        </div>

                        <div class="flex items-center gap-3 border-b border-gray-200 mb-4">
                            <button
                                class="category-tab-btn px-4 py-2 text-sm font-semibold text-ayur-primary border-b-2 border-ayur-primary"
                                data-category-tab="categories">Categories</button>
                            <button
                                class="category-tab-btn px-4 py-2 text-sm font-semibold text-gray-500 border-b-2 border-transparent"
                                data-category-tab="subcategories">Sub Categories</button>
                        </div>

                        <div id="categoryTabCategories">
                            <div id="inventoryCategoryList" class="space-y-3"></div>
                            <div class="mt-4 flex gap-2">
                                <input id="newCategoryName"
                                    class="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                    placeholder="New Category Name">
                                <button id="addCategoryBtn"
                                    class="px-3 py-2 rounded-lg bg-ayur-dark text-white text-xs font-semibold uppercase">Add</button>
                            </div>
                        </div>

                        <div id="categoryTabSubcategories" class="hidden">
                            <div id="inventorySubcategoryList" class="space-y-3"></div>
                            <div class="mt-4 grid grid-cols-1 gap-2">
                                <select id="subcategoryParent"
                                    class="px-3 py-2 rounded-lg border border-gray-200 text-sm"></select>
                                <div class="flex gap-2">
                                    <input id="newSubcategoryName"
                                        class="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        placeholder="New Sub Category Name">
                                    <button id="addSubcategoryBtn"
                                        class="px-3 py-2 rounded-lg bg-ayur-dark text-white text-xs font-semibold uppercase">Add</button>
                                </div>
                            </div>
                        </div>
                        <p id="categoryError" class="text-xs text-red-500 mt-3 hidden">Please fill required fields.</p>
                    </div>
                </div>
            </div>

            <!-- INVENTORY ADD PRODUCT MODAL -->
            <div id="inventoryAddModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                <div
                    class="bg-white rounded-3xl w-full md:w-[720px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                    <button id="closeInventoryAdd"
                        class="absolute top-6 right-6 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer z-10">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                    <div class="p-6 md:p-8">
                        <div
                            class="bg-ayur-dark text-white rounded-2xl p-6 mb-6 -mx-6 -mt-6 md:-mx-8 md:-mt-8 rounded-b-2xl">
                            <p class="text-xs uppercase tracking-wider text-gray-300 mb-1">Add New Product</p>
                            <h2 class="text-2xl font-serif font-bold text-white">Product Information</h2>
                        </div>

                        <form id="inventoryAddForm" class="space-y-6">
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Product Name
                                            *</label>
                                        <input id="addProductName"
                                            class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                            placeholder="e.g. Silk Saree" required>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Category *</label>
                                        <select id="addProductCategory"
                                            class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                            required></select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Sub
                                            Category</label>
                                        <select id="addProductSubcategory"
                                            class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"></select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Tags (Comma
                                            Separated)</label>
                                        <input id="addProductTags"
                                            class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                            placeholder="e.g. Wedding, Silk, Red" list="inventoryTagList">
                                    </div>
                                </div>
                                <div class="flex items-center gap-6">
                                    <label class="flex items-center gap-2 text-sm text-gray-600">
                                        <input id="addProductActive" type="checkbox" class="accent-ayur-primary"
                                            checked> Active
                                    </label>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Description</label>
                                    <textarea id="addProductDescription"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm" rows="4"
                                        placeholder="Material, fit, occasion, care..."></textarea>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 pt-5">
                                <h4 class="text-sm font-semibold text-gray-600 uppercase mb-3">Visuals</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Main Thumbnail
                                            *</label>
                                        <input id="addProductThumbnail" type="file" class="w-full mt-2 text-xs"
                                            required>
                                        <div id="addThumbnailPreview"
                                            class="mt-3 w-24 h-24 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-400">
                                            Preview</div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Gallery
                                            Images</label>
                                        <input id="addProductGallery" type="file" class="w-full mt-2 text-xs" multiple>
                                        <div id="addGalleryPreview" class="flex flex-wrap gap-2 mt-3"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 pt-5">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-sm font-semibold text-gray-600 uppercase">Sizes & Stock</h4>
                                    <button type="button" id="addProductVariantRow"
                                        class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-semibold text-gray-600">+
                                        Add Variant</button>
                                </div>
                                <div class="overflow-x-auto mt-3 border border-gray-200 rounded-2xl">
                                    <table class="w-full text-sm min-w-[900px] table-fixed">
                                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs whitespace-nowrap">
                                            <tr>
                                                <th class="text-left p-3 w-20">Size</th>
                                                <th class="text-left p-3 w-20">Unit</th>
                                                <th class="text-left p-3 w-44">Batch</th>
                                                <th class="text-left p-3 w-24">Stock</th>
                                                <th class="text-left p-3 w-28">Price</th>
                                                <th class="text-left p-3 w-28">Mfg</th>
                                                <th class="text-left p-3 w-28">Expiry</th>
                                                <th class="text-left p-3 w-16">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="addProductVariants"></tbody>
                                    </table>
                                </div>
                                <p id="addProductError" class="text-xs text-red-500 mt-2 hidden">Please fill all
                                    required fields and add at least one variant.</p>
                            </div>

                            <button id="addProductSubmit" type="submit"
                                class="w-full px-5 py-3 rounded-full bg-ayur-dark text-white text-xs font-semibold uppercase tracking-wider">Save
                                Product</button>
                        </form>
                    </div>
                </div>
            </div>

            <datalist id="inventoryTagList"></datalist>

            <!-- USERS SECTION -->
            <div id="users" class="content-section">
                <div class="bg-white/90 rounded-2xl border border-white/70 p-6 shadow-[var(--shadow-soft)] glass">
                    <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-ayur-dark m-0 font-serif mb-1">Manage Users</h3>
                            <p class="text-gray-500 text-sm m-0">Control delivery partners and customer accounts.</p>
                        </div>
                        <button id="openAddDeliveryPartner"
                            class="px-5 py-3 rounded-2xl bg-ayur-dark text-white text-xs font-semibold uppercase tracking-wider transition-all duration-300 hover:shadow-lg hover:translate-y-[-1px] border-none cursor-pointer">
                            <i class="fas fa-plus mr-2"></i>Add Delivery Partner
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                        <div class="flex items-center gap-2 bg-white border border-gray-300 rounded-lg px-4 py-2">
                            <i class="fas fa-magnifying-glass text-gray-400 text-sm"></i>
                            <input id="userSearchInput" type="text" placeholder="Search by name, email, or phone"
                                class="w-full bg-transparent outline-none text-sm text-gray-700">
                        </div>
                        <select id="userTypeFilter"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-ayur-primary cursor-pointer">
                            <option value="all">All Users</option>
                            <option value="customers">Customers</option>
                            <option value="partners">Delivery Partners</option>
                        </select>
                        <div class="flex justify-end">
                            <button id="userClearFilters"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">Clear</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-200 p-5 mb-6" data-user-panel="customers">
                        <h4 class="text-lg font-semibold text-ayur-dark m-0 mb-4">Customers</h4>
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        ID</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Name</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Email</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Phone</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Orders</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="customerUsersTableBody">
                                {% for customer in recent_customers %}
                                <tr class="border-b border-gray-100 transition-all duration-300"
                                    data-user-type="customer"
                                    data-user-id="{{ customer.id }}"
                                    data-user-search="{{ customer.get_full_name|default:customer.username|lower }} {{ customer.email|default:''|lower }} {{ customer.phone|default:''|lower }}">
                                    <td class="p-4 text-sm text-gray-700"><strong>#CUST-{{ customer.id }}</strong></td>
                                    <td class="p-4 text-sm text-gray-700">{{ customer.get_full_name|default:customer.username }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ customer.email|default:"—" }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ customer.phone|default:"—" }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ customer.total_orders|default:0 }}</td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <button
                                            class="customer-view-btn px-4 py-2 bg-blue-500 text-white rounded-lg no-underline transition-all duration-300 hover:bg-blue-600 text-xs border-none cursor-pointer"
                                            data-id="{{ customer.id }}"
                                            data-role="{{ customer.role|default:'Customer' }}"
                                            data-joined="{{ customer.date_joined|date:'M d, Y' }}"
                                            data-name="{{ customer.get_full_name|default:customer.username }}"
                                            data-email="{{ customer.email|default:'—' }}"
                                            data-phone="{{ customer.phone|default:'—' }}"
                                            data-orders="{{ customer.total_orders|default:0 }}"
                                            data-spent="{{ customer.total_spent|default:0 }}">
                                            View
                                        </button>
                                            <button
                                                class="user-lock-btn ml-2 w-9 h-9 inline-flex items-center justify-center rounded-lg text-white transition-all duration-300 border-none cursor-pointer {% if customer.is_active %}bg-red-500 hover:bg-red-600{% else %}bg-emerald-500 hover:bg-emerald-600{% endif %}"
                                                title="{% if customer.is_active %}Block user{% else %}Unblock user{% endif %}"
                                                data-user-id="{{ customer.id }}"
                                                data-user-active="{% if customer.is_active %}true{% else %}false{% endif %}">
                                                <i class="fas {% if customer.is_active %}fa-lock{% else %}fa-lock-open{% endif %}"></i>
                                            </button>
                                            <button
                                                class="user-delete-btn ml-2 w-9 h-9 inline-flex items-center justify-center rounded-lg text-white transition-all duration-300 border-none cursor-pointer bg-red-700 hover:bg-red-800"
                                                title="Delete user"
                                                data-user-id="{{ customer.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="p-6 text-center text-sm text-gray-500">No customers found.
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if recent_customers %}
                                <tr class="user-empty-row hidden">
                                    <td colspan="6" class="p-6 text-center text-sm text-gray-500">No matching customers
                                        found.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-white rounded-2xl border border-gray-200 p-5" data-user-panel="partners">
                        <h4 class="text-lg font-semibold text-ayur-dark m-0 mb-4">Delivery Partners</h4>
                        <table class="w-full border-collapse data-table">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Name</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Vehicle</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Pending</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Delivered (This Month)</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Rating</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Reviews</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Status</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Toggle</th>
                                    <th
                                        class="text-left p-4 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                        Delete</th>
                                </tr>
                            </thead>
                            <tbody id="deliveryPartnersUserBody">
                                {% for partner in delivery_partners %}
                                <tr class="border-b border-gray-100 transition-all duration-300"
                                    data-user-type="partner"
                                    data-user-search="{{ partner.user.get_full_name|default:partner.user.username|lower }} {{ partner.user.email|default:''|lower }} {{ partner.user.phone|default:''|lower }} {{ partner.vehicle_type|lower }} {{ partner.vehicle_number|lower }}">
                                    <td class="p-4 text-sm text-gray-700">{{ partner.user.get_full_name|default:partner.user.username }}</td>
                                    <td class="p-4 text-sm text-gray-700">{{ partner.vehicle_type }} ({{ partner.vehicle_number }})</td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">{{ partner.active_deliveries|default:0 }}</span>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <span
                                            class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">{{ partner.completed_deliveries|default:0 }}</span>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <span class="font-semibold text-gray-800">{{ partner.avg_rating|floatformat:1 }}</span>
                                        <span class="text-xs text-gray-400">/ 5</span>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">{{ partner.review_count|default:0 }}</td>
                                    <td class="p-4 text-sm text-gray-700">
                                        {% if partner.is_active %}
                                        <span
                                            class="partner-status-badge px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">Active</span>
                                        {% else %}
                                        <span
                                            class="partner-status-badge px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only user-toggle-input" data-partner-id="{{ partner.id }}" {% if partner.is_active %}checked{% endif %}>
                                            <span
                                                class="user-toggle-track w-10 h-5 rounded-full relative transition-all {% if partner.is_active %}bg-emerald-500{% else %}bg-gray-200{% endif %}">
                                                <span
                                                    class="user-toggle-knob absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transition-all {% if partner.is_active %}translate-x-5{% endif %}"></span>
                                            </span>
                                        </label>
                                    </td>
                                    <td class="p-4 text-sm text-gray-700">
                                        <button
                                            class="user-partner-delete-btn w-9 h-9 inline-flex items-center justify-center rounded-lg text-white transition-all duration-300 border-none cursor-pointer bg-red-700 hover:bg-red-800"
                                            title="Delete delivery partner"
                                            data-partner-id="{{ partner.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr class="delivery-partner-empty">
                                    <td colspan="9" class="p-6 text-center text-sm text-gray-500">No delivery partners
                                        found.</td>
                                </tr>
                                {% endfor %}
                                {% if delivery_partners %}
                                <tr class="user-empty-row hidden">
                                    <td colspan="9" class="p-6 text-center text-sm text-gray-500">No matching delivery
                                        partners found.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- CUSTOMER DETAIL MODAL -->
                <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                    <div class="bg-white rounded-3xl w-full md:w-[520px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                        <button id="closeCustomerModal" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                        <div class="p-6">
                            <div class="bg-ayur-dark text-white rounded-2xl p-5 mb-5">
                                <h3 class="text-xl font-serif font-bold m-0" id="customerModalName">Customer</h3>
                                <p class="text-xs text-gray-200 mt-1 m-0">Profile overview</p>
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 space-y-3">
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Customer ID</span>
                                    <span id="customerModalId" class="font-semibold text-gray-800">—</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Role</span>
                                    <span id="customerModalRole" class="font-semibold text-gray-800">Customer</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Joined At</span>
                                    <span id="customerModalJoined" class="font-semibold text-gray-800">—</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Email</span>
                                    <span id="customerModalEmail" class="font-semibold text-gray-800">—</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Phone</span>
                                    <span id="customerModalPhone" class="font-semibold text-gray-800">—</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Total Orders</span>
                                    <span id="customerModalOrders" class="font-semibold text-gray-800">0</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span>Total Spent</span>
                                    <span id="customerModalSpent" class="font-semibold text-emerald-700">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ADD DELIVERY PARTNER MODAL -->
                <div id="addDeliveryPartnerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center px-4 py-6">
                    <div class="bg-white rounded-3xl w-full md:w-[640px] max-h-[92vh] overflow-y-auto relative shadow-[0_20px_60px_rgba(14,27,20,0.2)]">
                        <button id="closeAddDeliveryPartnerModal" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-all duration-300 border-none cursor-pointer">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                        <div class="p-6">
                            <div class="bg-ayur-dark text-white rounded-2xl p-5 mb-5">
                                <h3 class="text-xl font-serif font-bold m-0">Add Delivery Partner</h3>
                                <p class="text-xs text-gray-200 mt-1 m-0">Create a new delivery partner account.</p>
                            </div>
                            <form id="addDeliveryPartnerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Select User</label>
                                    <select id="deliveryUserSelect" name="user_id"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                                        <option value="">Choose a user</option>
                                        {% for user in delivery_candidate_users %}
                                        <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}{% if user.email %} — {{ user.email }}{% endif %}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">License Number</label>
                                    <input id="deliveryLicense" name="license_number" type="text"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        placeholder="License number">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Vehicle Type</label>
                                    <select id="deliveryVehicleType" name="vehicle_type"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                                        <option value="Bike">Bike</option>
                                        <option value="Scooter">Scooter</option>
                                        <option value="Car">Car</option>
                                        <option value="Van">Van</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Vehicle Number</label>
                                    <input id="deliveryVehicleNumber" name="vehicle_number" type="text"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        placeholder="GJ-01-AB-1234">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Monthly Salary</label>
                                    <input id="deliverySalary" name="salary" type="number" min="0" step="0.01"
                                        class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 text-sm"
                                        placeholder="0.00">
                                </div>
                                <div class="flex items-center gap-3 mt-2 md:col-span-2">
                                    <input id="deliveryActive" name="is_active" type="checkbox" class="accent-ayur-primary" checked>
                                    <label for="deliveryActive" class="text-sm text-gray-600">Active</label>
                                </div>
                                <div class="md:col-span-2">
                                    <p id="addDeliveryPartnerError" class="text-xs text-red-500 hidden"></p>
                                </div>
                                <div class="md:col-span-2 flex items-center justify-end gap-3">
                                    <button type="button" id="cancelAddDeliveryPartner"
                                        class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 border-none cursor-pointer btn-ghost">Cancel</button>
                                    <button id="addDeliveryPartnerSubmit" type="submit"
                                        class="px-5 py-2.5 rounded-lg bg-ayur-dark text-white text-xs font-semibold uppercase tracking-wider">Add
                                        Partner</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function showDefaultNotification(message) {
            if (!message) return;
            alert(message);
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function buildSalaryRowHtml(salary) {
            const status = (salary.status || '').toLowerCase();
            let statusHtml = '<span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">Cancelled</span>';
            if (status === 'paid') {
                statusHtml = '<span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">Paid</span>';
            } else if (status === 'pending') {
                statusHtml = '<span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-yellow-100 text-yellow-700">Pending</span>';
            } else if (status === 'hold') {
                statusHtml = '<span class="px-3 py-1 rounded-[10px] text-xs font-semibold bg-orange-100 text-orange-700">On Hold</span>';
            }

            return `
                <tr class="border-b border-gray-100 transition-all duration-300">
                    <td class="p-4 text-sm text-gray-700">${escapeHtml(salary.partner_name)}</td>
                    <td class="p-4 text-sm text-gray-700">${escapeHtml(salary.period)}</td>
                    <td class="p-4 text-sm text-gray-700">&#8377;${escapeHtml(salary.base_salary)}</td>
                    <td class="p-4 text-sm text-gray-700">&#8377;${escapeHtml(salary.bonus)}</td>
                    <td class="p-4 text-sm text-gray-700">&#8377;${escapeHtml(salary.deductions)}</td>
                    <td class="p-4 text-sm text-gray-700 font-semibold text-ayur-dark">&#8377;${escapeHtml(salary.net_salary)}</td>
                    <td class="p-4 text-sm text-gray-700">${escapeHtml(salary.payment_mode || '-')}</td>
                    <td class="p-4 text-sm text-gray-700">${escapeHtml(salary.transfer_destination || '-')}</td>
                    <td class="p-4 text-sm text-gray-700">${statusHtml}</td>
                </tr>
            `;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const flashMessages = Array.isArray(window.dashboardFlashMessages) ? window.dashboardFlashMessages : [];
            flashMessages.forEach((msg, index) => {
                setTimeout(() => showDefaultNotification(msg.text), index * 220);
            });

            const salaryForm = document.getElementById('salaryPaymentForm');
            const salaryTableBody = document.getElementById('salaryPaymentsTbody');
            const salarySubmitBtn = document.getElementById('salarySubmitBtn');
            if (salaryForm && salaryTableBody) {
                salaryForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    if (!salaryForm.checkValidity()) {
                        salaryForm.reportValidity();
                        return;
                    }
                    const submitOriginal = salarySubmitBtn ? salarySubmitBtn.innerHTML : '';
                    if (salarySubmitBtn) {
                        salarySubmitBtn.disabled = true;
                        salarySubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Processing...';
                    }

                    const formData = new FormData(salaryForm);
                    fetch(salaryForm.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData,
                    })
                    .then(async (response) => {
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok || !data.success) {
                            throw new Error(data.message || 'Failed to process salary.');
                        }
                        return data;
                    })
                    .then((data) => {
                        const emptyRow = salaryTableBody.querySelector('td[colspan="9"]')?.closest('tr');
                        if (emptyRow) emptyRow.remove();
                        salaryTableBody.insertAdjacentHTML('afterbegin', buildSalaryRowHtml(data.salary));
                        showDefaultNotification(data.message || 'Salary processed.');
                        salaryForm.reset();
                        if (salaryPartnerSelect) {
                            salaryPartnerSelect.dispatchEvent(new Event('change'));
                        }
                        if (salaryMonthInput && salaryYearInput) {
                            const now = new Date();
                            salaryMonthInput.value = String(now.getMonth() + 1);
                            salaryYearInput.value = String(now.getFullYear());
                        }
                        updateTransferSalary();
                    })
                    .catch((error) => {
                        showDefaultNotification(error.message || 'Failed to process salary.');
                    })
                    .finally(() => {
                        if (salarySubmitBtn) {
                            salarySubmitBtn.disabled = false;
                            salarySubmitBtn.innerHTML = submitOriginal;
                        }
                    });
                });
            }
        });

        // ===== ORDER MANAGEMENT FUNCTIONALITY =====

        // Store filtered state
        let currentTab = 'all';
        let orderPage = 1;
        const orderCount = document.getElementById('orderCount');
        const orderPrev = document.getElementById('orderPrev');
        const orderNext = document.getElementById('orderNext');
        const orderPerPage = document.getElementById('orderPerPage');
        let orderPageSize = orderPerPage ? Number(orderPerPage.value) : 10;

        const salaryPartnerSelect = document.getElementById('salaryPartner');
        const salaryBaseInput = document.getElementById('salaryBase');
        const salaryBonusInput = document.getElementById('salaryBonus');
        const salaryDeductionInput = document.getElementById('salaryDeduction');
        const salaryNetInput = document.getElementById('salaryNet');
        const salaryMonthInput = document.getElementById('salaryMonth');
        const salaryYearInput = document.getElementById('salaryYear');
        const salaryBankPreview = document.getElementById('salaryBankPreview');

        function updateTransferSalary() {
            if (!salaryNetInput) {
                return;
            }
            const base = Number(salaryBaseInput?.value || 0);
            const bonus = Number(salaryBonusInput?.value || 0);
            const deduction = Number(salaryDeductionInput?.value || 0);
            const net = Math.max(0, base + bonus - deduction);
            salaryNetInput.value = `₹${net.toFixed(2)}`;
        }

        if (salaryMonthInput && salaryYearInput) {
            const currentDate = new Date();
            salaryMonthInput.value = salaryMonthInput.value || String(currentDate.getMonth() + 1);
            salaryYearInput.value = salaryYearInput.value || String(currentDate.getFullYear());
        }

        if (salaryPartnerSelect && salaryBaseInput) {
            salaryPartnerSelect.addEventListener('change', function () {
                const selectedOption = salaryPartnerSelect.options[salaryPartnerSelect.selectedIndex];
                const partnerSalary = selectedOption ? selectedOption.getAttribute('data-base-salary') : '';
                salaryBaseInput.value = partnerSalary || '';
                if (salaryBankPreview) {
                    if (!selectedOption || !selectedOption.value) {
                        salaryBankPreview.innerHTML = 'Select a delivery partner to view bank details for salary transfer.';
                    } else {
                        const holder = selectedOption.getAttribute('data-bank-holder') || '-';
                        const accountNumber = selectedOption.getAttribute('data-bank-number') || '';
                        const maskedAccount = accountNumber ? `****${accountNumber.slice(-4)}` : '-';
                        const ifsc = selectedOption.getAttribute('data-bank-ifsc') || '-';
                        const bankName = selectedOption.getAttribute('data-bank-name') || '-';
                        const upi = selectedOption.getAttribute('data-bank-upi') || '-';
                        salaryBankPreview.innerHTML = `
                            <div><strong>Account Holder:</strong> ${escapeHtml(holder)}</div>
                            <div><strong>Account Number:</strong> ${escapeHtml(maskedAccount)}</div>
                            <div><strong>IFSC:</strong> ${escapeHtml(ifsc)}</div>
                            <div><strong>Bank:</strong> ${escapeHtml(bankName)}</div>
                            <div><strong>UPI ID:</strong> ${escapeHtml(upi)}</div>
                        `;
                    }
                }
                updateTransferSalary();
            });
            salaryPartnerSelect.dispatchEvent(new Event('change'));
        }

        [salaryBaseInput, salaryBonusInput, salaryDeductionInput].forEach(input => {
            if (input) {
                input.addEventListener('input', updateTransferSalary);
            }
        });
        updateTransferSalary();

        // Tab Switching
        const orderTabBtns = document.querySelectorAll('.order-tab-btn');
        orderTabBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                currentTab = this.getAttribute('data-tab');

                // Update active tab styling
                orderTabBtns.forEach(b => {
                    b.classList.remove('text-ayur-primary', 'border-b-2', 'border-ayur-primary');
                    b.classList.add('text-gray-500', 'border-transparent');
                });
                this.classList.add('text-ayur-primary', 'border-b-2', 'border-ayur-primary');
                this.classList.remove('text-gray-500', 'border-transparent');

                // Apply filters with new tab
                applyAllFilters();
            });
        });

        // Driver Selection - Save to backend
        const driverSelects = document.querySelectorAll('.driver-select');
        driverSelects.forEach(select => {
            select.addEventListener('change', function () {
                const orderId = this.getAttribute('data-order-id');
                const driverId = this.value;
                const row = this.closest('.order-row');

                // Update data attribute
                row.setAttribute('data-assigned-driver', driverId);

                // Optional: Save to backend via AJAX
                console.log(`Order ${orderId} assigned to driver ${driverId}`);

                // Re-apply filters if we're on assigned/unassigned tab
                if (currentTab !== 'all') {
                    applyAllFilters();
                }
            });
        });

        // Search Functionality - Fixed
        const orderSearch = document.getElementById('orderSearch');
        if (orderSearch) {
            orderSearch.addEventListener('keyup', function () {
                applyAllFilters();
            });
        }

        // Status Filter
        const orderStatus = document.getElementById('orderStatus');
        if (orderStatus) {
            orderStatus.addEventListener('change', applyAllFilters);
        }

        // Date Filters
        const orderDateFrom = document.getElementById('orderDateFrom');
        const orderDateTo = document.getElementById('orderDateTo');
        if (orderDateFrom) orderDateFrom.addEventListener('change', applyAllFilters);
        if (orderDateTo) orderDateTo.addEventListener('change', applyAllFilters);

        // Apply All Filters - Improved
        function applyAllFilters(keepPage = false) {
            const searchTerm = (document.getElementById('orderSearch')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('orderStatus')?.value || '';
            const dateFrom = document.getElementById('orderDateFrom')?.value || '';
            const dateTo = document.getElementById('orderDateTo')?.value || '';

            const rows = Array.from(document.querySelectorAll('.order-row'));
            const filteredRows = [];

            rows.forEach(row => {
                let show = true;

                // Tab filter (unassigned/assigned driver) - Use data-assigned-driver attribute
                if (currentTab !== 'all') {
                    const assignedDriverId = row.getAttribute('data-assigned-driver') || '';

                    if (currentTab === 'unassigned' && assignedDriverId !== '') {
                        show = false;
                    } else if (currentTab === 'assigned' && assignedDriverId === '') {
                        show = false;
                    }
                }

                // Search filter - Check both Order ID and Customer name
                if (searchTerm && show) {
                    const orderNumber = row.querySelector('strong')?.textContent?.toLowerCase() || '';
                    const customerCell = row.cells[1]?.textContent?.toLowerCase() || '';

                    if (!orderNumber.includes(searchTerm) && !customerCell.includes(searchTerm)) {
                        show = false;
                    }
                }

                // Status filter
                if (statusFilter && show) {
                    const rowStatus = (row.getAttribute('data-order-status') || '').trim();
                    if (rowStatus !== statusFilter) {
                        show = false;
                    }
                }

                // Date filter
                if ((dateFrom || dateTo) && show) {
                    const rowDate = row.getAttribute('data-order-date') || '';
                    if (rowDate) {
                        if (dateFrom && rowDate < dateFrom) {
                            show = false;
                        }
                        if (dateTo && rowDate > dateTo) {
                            show = false;
                        }
                    }
                }

                if (show) {
                    filteredRows.push(row);
                }
                row.style.display = 'none';
            });

            if (!keepPage) {
                orderPage = 1;
            }

            const totalRows = filteredRows.length;
            const maxPage = Math.max(1, Math.ceil(totalRows / orderPageSize));
            if (orderPage > maxPage) {
                orderPage = maxPage;
            }

            const startIndex = (orderPage - 1) * orderPageSize;
            const endIndex = Math.min(startIndex + orderPageSize, totalRows);
            const pageRows = filteredRows.slice(startIndex, endIndex);
            pageRows.forEach(row => {
                row.style.display = 'table-row';
            });

            if (orderCount) {
                if (totalRows === 0) {
                    orderCount.textContent = 'Showing 0-0 of 0';
                } else {
                    orderCount.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalRows}`;
                }
            }

            if (orderPrev) {
                orderPrev.disabled = orderPage <= 1;
                orderPrev.classList.toggle('opacity-40', orderPage <= 1);
            }

            if (orderNext) {
                orderNext.disabled = endIndex >= totalRows;
                orderNext.classList.toggle('opacity-40', endIndex >= totalRows);
            }
        }

        function applyOrderFilters(keepPage = false) {
            applyAllFilters(keepPage);
        }

        // Clear Filters
        const clearFiltersBtn = document.getElementById('clearFilters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function () {
                document.getElementById('orderSearch').value = '';
                document.getElementById('orderStatus').value = '';
                document.getElementById('orderDateFrom').value = '';
                document.getElementById('orderDateTo').value = '';
                currentTab = 'all';

                // Reset tab styling
                orderTabBtns.forEach(b => {
                    if (b.getAttribute('data-tab') === 'all') {
                        b.classList.add('text-ayur-primary', 'border-b-2', 'border-ayur-primary');
                        b.classList.remove('text-gray-500', 'border-transparent');
                    } else {
                        b.classList.remove('text-ayur-primary', 'border-b-2', 'border-ayur-primary');
                        b.classList.add('text-gray-500', 'border-transparent');
                    }
                });

                orderPage = 1;
                applyAllFilters();
            });
        }

        if (orderPrev) {
            orderPrev.addEventListener('click', function () {
                if (orderPage > 1) {
                    orderPage -= 1;
                    applyAllFilters(true);
                }
            });
        }

        if (orderNext) {
            orderNext.addEventListener('click', function () {
                orderPage += 1;
                applyAllFilters(true);
            });
        }

        if (orderPerPage) {
            orderPerPage.addEventListener('change', function () {
                orderPageSize = Number(this.value) || 10;
                orderPage = 1;
                applyAllFilters();
            });
        }

        applyAllFilters();

        // ===== USER MANAGEMENT FILTERS =====
        const userSearchInput = document.getElementById('userSearchInput');
        const userTypeFilter = document.getElementById('userTypeFilter');
        const userClearFilters = document.getElementById('userClearFilters');

        function applyUserFilters() {
            const searchValue = (userSearchInput?.value || '').toLowerCase().trim();
            const typeValue = userTypeFilter?.value || 'all';
            const userRows = document.querySelectorAll('[data-user-type]');
            const userPanels = document.querySelectorAll('[data-user-panel]');

            userPanels.forEach(panel => {
                const panelType = panel.getAttribute('data-user-panel');
                const isTypeMatch = typeValue === 'all'
                    ? true
                    : (typeValue === 'customers' ? panelType === 'customers' : panelType === 'partners');

                if (!isTypeMatch) {
                    panel.style.display = 'none';
                    return;
                }

                panel.style.display = '';
            });

            userRows.forEach(row => {
                const rowType = row.getAttribute('data-user-type');
                const rowSearch = row.getAttribute('data-user-search') || '';
                let show = true;

                if (typeValue !== 'all') {
                    show = typeValue === 'customers' ? rowType === 'customer' : rowType === 'partner';
                }

                if (show && searchValue) {
                    show = rowSearch.includes(searchValue);
                }

                row.style.display = show ? 'table-row' : 'none';
            });

            const userTables = document.querySelectorAll('[data-user-panel] .data-table');
            userTables.forEach(table => {
                const section = table.closest('[data-user-panel]');
                if (!section) {
                    return;
                }

                const visibleRows = section.querySelectorAll('[data-user-type]');
                let hasVisible = false;
                visibleRows.forEach(row => {
                    if (row.style.display !== 'none') {
                        hasVisible = true;
                    }
                });

                const emptyRow = section.querySelector('.user-empty-row');
                if (emptyRow) {
                    emptyRow.classList.toggle('hidden', hasVisible);
                }

                if (searchValue && !hasVisible) {
                    section.style.display = 'none';
                }
            });
        }

        if (userSearchInput) {
            userSearchInput.addEventListener('input', applyUserFilters);
        }

        if (userTypeFilter) {
            userTypeFilter.addEventListener('change', applyUserFilters);
        }

        if (userClearFilters) {
            userClearFilters.addEventListener('click', function () {
                if (userSearchInput) userSearchInput.value = '';
                if (userTypeFilter) userTypeFilter.value = 'all';
                applyUserFilters();
            });
        }

        // Add Delivery Partner modal + submit
        const openAddDeliveryPartner = document.getElementById('openAddDeliveryPartner');
        const addDeliveryPartnerModal = document.getElementById('addDeliveryPartnerModal');
        const closeAddDeliveryPartnerModal = document.getElementById('closeAddDeliveryPartnerModal');
        const cancelAddDeliveryPartner = document.getElementById('cancelAddDeliveryPartner');
        const addDeliveryPartnerForm = document.getElementById('addDeliveryPartnerForm');
        const addDeliveryPartnerError = document.getElementById('addDeliveryPartnerError');
        const deliveryPartnersUserBody = document.getElementById('deliveryPartnersUserBody');
        const deliveryUserSelect = document.getElementById('deliveryUserSelect');

        function openAddDeliveryPartnerModalFn() {
            if (!addDeliveryPartnerModal) return;
            if (addDeliveryPartnerError) {
                addDeliveryPartnerError.textContent = '';
                addDeliveryPartnerError.classList.add('hidden');
            }
            if (addDeliveryPartnerForm) {
                addDeliveryPartnerForm.reset();
                const activeToggle = document.getElementById('deliveryActive');
                if (activeToggle) activeToggle.checked = true;
            }
            addDeliveryPartnerModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddDeliveryPartnerModalFn() {
            if (!addDeliveryPartnerModal) return;
            addDeliveryPartnerModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        if (openAddDeliveryPartner) {
            openAddDeliveryPartner.addEventListener('click', openAddDeliveryPartnerModalFn);
        }
        if (closeAddDeliveryPartnerModal) {
            closeAddDeliveryPartnerModal.addEventListener('click', closeAddDeliveryPartnerModalFn);
        }
        if (cancelAddDeliveryPartner) {
            cancelAddDeliveryPartner.addEventListener('click', closeAddDeliveryPartnerModalFn);
        }
        if (addDeliveryPartnerModal) {
            addDeliveryPartnerModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeAddDeliveryPartnerModalFn();
                }
            });
        }

        function buildDeliveryPartnerRow(partner) {
            const statusBadge = partner.is_active
                ? '<span class="partner-status-badge px-3 py-1 rounded-[10px] text-xs font-semibold bg-green-100 text-green-700">Active</span>'
                : '<span class="partner-status-badge px-3 py-1 rounded-[10px] text-xs font-semibold bg-red-100 text-red-700">Inactive</span>';
            const trackClass = partner.is_active ? 'bg-emerald-500' : 'bg-gray-200';
            const knobClass = partner.is_active ? 'translate-x-5' : '';
            const checked = partner.is_active ? 'checked' : '';

            return `
                <tr class="border-b border-gray-100 transition-all duration-300"
                    data-user-type="partner"
                    data-user-search="${partner.search || ''}">
                    <td class="p-4 text-sm text-gray-700">${partner.name}</td>
                    <td class="p-4 text-sm text-gray-700">${partner.vehicle_type} (${partner.vehicle_number})</td>
                    <td class="p-4 text-sm text-gray-700">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">${partner.active_deliveries || 0}</span>
                    </td>
                    <td class="p-4 text-sm text-gray-700">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">${partner.completed_deliveries || 0}</span>
                    </td>
                    <td class="p-4 text-sm text-gray-700">
                        <span class="font-semibold text-gray-800">${Number(partner.avg_rating || 0).toFixed(1)}</span>
                        <span class="text-xs text-gray-400">/ 5</span>
                    </td>
                    <td class="p-4 text-sm text-gray-700">${partner.review_count || 0}</td>
                    <td class="p-4 text-sm text-gray-700">${statusBadge}</td>
                    <td class="p-4 text-sm text-gray-700">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only user-toggle-input" data-partner-id="${partner.id}" ${checked}>
                            <span class="user-toggle-track w-10 h-5 rounded-full relative transition-all ${trackClass}">
                                <span class="user-toggle-knob absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transition-all ${knobClass}"></span>
                            </span>
                        </label>
                    </td>
                    <td class="p-4 text-sm text-gray-700">
                        <button
                            class="user-partner-delete-btn w-9 h-9 inline-flex items-center justify-center rounded-lg text-white transition-all duration-300 border-none cursor-pointer bg-red-700 hover:bg-red-800"
                            title="Delete delivery partner"
                            data-partner-id="${partner.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        if (addDeliveryPartnerForm) {
            addDeliveryPartnerForm.addEventListener('submit', function (e) {
                e.preventDefault();
                if (!addDeliveryPartnerError) {
                    return;
                }

                const userId = document.getElementById('deliveryUserSelect')?.value || '';
                const licenseNumber = document.getElementById('deliveryLicense')?.value.trim();
                const vehicleNumber = document.getElementById('deliveryVehicleNumber')?.value.trim();

                if (!userId || !licenseNumber || !vehicleNumber) {
                    addDeliveryPartnerError.textContent = 'Please fill all required fields.';
                    addDeliveryPartnerError.classList.remove('hidden');
                    return;
                }

                addDeliveryPartnerError.textContent = '';
                addDeliveryPartnerError.classList.add('hidden');

                const submitBtn = document.getElementById('addDeliveryPartnerSubmit');
                const originalText = submitBtn ? submitBtn.textContent : '';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                }

                const formData = new FormData(addDeliveryPartnerForm);
                const isActive = document.getElementById('deliveryActive')?.checked ? 'true' : 'false';
                formData.set('is_active', isActive);

                fetch('/api/delivery-partner/create/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(res => res.json().then(data => ({ ok: res.ok, data })))
                    .then(({ ok, data }) => {
                        if (!ok || !data.success) {
                            throw new Error(data.error || 'Failed to create delivery partner.');
                        }

                        if (deliveryPartnersUserBody && data.partner) {
                            const emptyRow = deliveryPartnersUserBody.querySelector('.delivery-partner-empty');
                            if (emptyRow) {
                                emptyRow.remove();
                            }
                            deliveryPartnersUserBody.insertAdjacentHTML('afterbegin', buildDeliveryPartnerRow(data.partner));
                        }

                        if (deliveryUserSelect && userId) {
                            const opt = deliveryUserSelect.querySelector(`option[value="${userId}"]`);
                            if (opt) opt.remove();
                            deliveryUserSelect.value = '';
                        }

                        if (userId) {
                            const customerRow = document.querySelector(`[data-user-type="customer"][data-user-id="${userId}"]`);
                            if (customerRow) {
                                customerRow.remove();
                            }
                        }

                        applyUserFilters();
                        refreshAdminSnapshot();
                        closeAddDeliveryPartnerModalFn();
                    })
                    .catch(error => {
                        addDeliveryPartnerError.textContent = error.message || 'Failed to create delivery partner.';
                        addDeliveryPartnerError.classList.remove('hidden');
                    })
                    .finally(() => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText || 'Add Partner';
                        }
                    });
            });
        }

        function handleUserToggleChange(toggleEl) {
            const row = toggleEl.closest('tr');
            const statusBadge = row?.querySelector('.partner-status-badge');
            const track = row?.querySelector('.user-toggle-track');
            const knob = row?.querySelector('.user-toggle-knob');
            const isActive = toggleEl.checked;
            const partnerId = toggleEl.getAttribute('data-partner-id');

            if (statusBadge) {
                statusBadge.textContent = isActive ? 'Active' : 'Inactive';
                statusBadge.classList.toggle('bg-green-100', isActive);
                statusBadge.classList.toggle('text-green-700', isActive);
                statusBadge.classList.toggle('bg-red-100', !isActive);
                statusBadge.classList.toggle('text-red-700', !isActive);
            }

            if (track) {
                track.classList.toggle('bg-emerald-500', isActive);
                track.classList.toggle('bg-gray-200', !isActive);
            }

            if (knob) {
                knob.classList.toggle('translate-x-5', isActive);
            }

            if (partnerId) {
                fetch(`/api/delivery-partner/${partnerId}/toggle/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ is_active: isActive })
                }).then(res => res.json())
                  .then(data => {
                      if (!data.success) {
                          throw new Error(data.error || 'Update failed');
                      }
                      refreshAdminSnapshot();
                  })
                  .catch(() => {
                      // revert UI
                      toggleEl.checked = !isActive;
                      if (statusBadge) {
                          statusBadge.textContent = !isActive ? 'Active' : 'Inactive';
                          statusBadge.classList.toggle('bg-green-100', !isActive);
                          statusBadge.classList.toggle('text-green-700', !isActive);
                          statusBadge.classList.toggle('bg-red-100', isActive);
                          statusBadge.classList.toggle('text-red-700', isActive);
                      }
                      if (track) {
                          track.classList.toggle('bg-emerald-500', !isActive);
                          track.classList.toggle('bg-gray-200', isActive);
                      }
                      if (knob) {
                          knob.classList.toggle('translate-x-5', !isActive);
                      }
                      alert('Failed to update partner status.');
                  });
            }
        }

        function updateLockButton(button, isActive) {
            if (!button) {
                return;
            }
            const icon = button.querySelector('i');
            button.dataset.userActive = isActive ? 'true' : 'false';
            button.title = isActive ? 'Block user' : 'Unblock user';

            if (icon) {
                icon.classList.toggle('fa-lock', isActive);
                icon.classList.toggle('fa-lock-open', !isActive);
            }

            button.classList.toggle('bg-red-500', isActive);
            button.classList.toggle('hover:bg-red-600', isActive);
            button.classList.toggle('bg-emerald-500', !isActive);
            button.classList.toggle('hover:bg-emerald-600', !isActive);
        }

        function handleUserLockClick(button) {
            const userId = button.getAttribute('data-user-id');
            const isActive = button.getAttribute('data-user-active') === 'true';
            const nextActive = !isActive;

            if (!userId) {
                return;
            }

            const actionLabel = nextActive ? 'unblock' : 'block';
            if (!confirm(`Are you sure you want to ${actionLabel} this user?`)) {
                return;
            }

            button.disabled = true;

            fetch(`/api/user/${userId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ is_active: nextActive })
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Update failed');
                    }
                    updateLockButton(button, nextActive);
                    refreshAdminSnapshot();
                })
                .catch(() => {
                    alert('Failed to update user status.');
                })
                .finally(() => {
                    button.disabled = false;
                });
        }

        function handleCustomerDeleteClick(button) {
            const userId = button.getAttribute('data-user-id');
            if (!userId) {
                return;
            }

            if (!confirm('Are you sure you want to delete this user account? This action cannot be undone.')) {
                return;
            }

            button.disabled = true;
            fetch(`/api/user/${userId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok || !data.success) {
                        throw new Error(data.error || 'Delete failed');
                    }
                    const row = button.closest('tr');
                    if (row) {
                        row.remove();
                    }
                    refreshAdminSnapshot();
                })
                .catch(error => {
                    alert(error.message || 'Failed to delete user.');
                })
                .finally(() => {
                    button.disabled = false;
                });
        }

        function handlePartnerDeleteClick(button) {
            const partnerId = button.getAttribute('data-partner-id');
            if (!partnerId) {
                return;
            }

            if (!confirm('Are you sure you want to delete this delivery partner account? This action cannot be undone.')) {
                return;
            }

            button.disabled = true;
            fetch(`/api/delivery-partner/${partnerId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok || !data.success) {
                        throw new Error(data.error || 'Delete failed');
                    }
                    const row = button.closest('tr');
                    if (row) {
                        row.remove();
                    }
                    refreshAdminSnapshot();
                })
                .catch(error => {
                    alert(error.message || 'Failed to delete delivery partner.');
                })
                .finally(() => {
                    button.disabled = false;
                });
        }

        // Customer detail modal
        const customerModal = document.getElementById('customerModal');
        const closeCustomerModal = document.getElementById('closeCustomerModal');
        function openCustomerModal(btn) {
            if (!customerModal) return;
            const id = btn.getAttribute('data-id') || '—';
            const role = btn.getAttribute('data-role') || 'Customer';
            const joined = btn.getAttribute('data-joined') || '—';
            const name = btn.getAttribute('data-name') || 'Customer';
            const email = btn.getAttribute('data-email') || '—';
            const phone = btn.getAttribute('data-phone') || '—';
            const orders = btn.getAttribute('data-orders') || '0';
            const spent = btn.getAttribute('data-spent') || '0';

            document.getElementById('customerModalName').textContent = name;
            document.getElementById('customerModalId').textContent = `#CUST-${id}`;
            document.getElementById('customerModalRole').textContent = role;
            document.getElementById('customerModalJoined').textContent = joined;
            document.getElementById('customerModalEmail').textContent = email;
            document.getElementById('customerModalPhone').textContent = phone;
            document.getElementById('customerModalOrders').textContent = orders;
            document.getElementById('customerModalSpent').textContent = `₹${Number(spent).toFixed(2)}`;

            customerModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeCustomerModalFn() {
            if (!customerModal) return;
            customerModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        if (closeCustomerModal) {
            closeCustomerModal.addEventListener('click', closeCustomerModalFn);
        }
        if (customerModal) {
            customerModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeCustomerModalFn();
                }
            });
        }

        // ===== DELIVERY PARTNER REVIEW MODAL =====
        const partnerReviewModal = document.getElementById('partnerReviewModal');
        const closePartnerReviewModal = document.getElementById('closePartnerReviewModal');
        const partnerReviewButtons = document.querySelectorAll('.partner-review-btn');
        const partnerFilterButtons = document.querySelectorAll('.partner-filter-btn');
        const partnerReviewFrom = document.getElementById('partnerReviewFrom');
        const partnerReviewTo = document.getElementById('partnerReviewTo');
        let activePartnerRating = 'all';

        function closePartnerModal() {
            partnerReviewModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function applyPartnerReviewFilters() {
            const fromDate = partnerReviewFrom?.value || '';
            const toDate = partnerReviewTo?.value || '';
            const items = document.querySelectorAll('#partnerReviewList [data-rating]');
            let visibleCount = 0;

            items.forEach(item => {
                const itemRating = item.getAttribute('data-rating');
                const itemDate = item.getAttribute('data-date');
                let show = true;

                if (activePartnerRating !== 'all' && itemRating !== activePartnerRating) {
                    show = false;
                }

                if (show && fromDate && itemDate && itemDate < fromDate) {
                    show = false;
                }

                if (show && toDate && itemDate && itemDate > toDate) {
                    show = false;
                }

                item.style.display = show ? '' : 'none';
                if (show) {
                    visibleCount += 1;
                }
            });

            const emptyState = document.getElementById('partnerReviewEmpty');
            if (emptyState) {
                emptyState.classList.toggle('hidden', visibleCount > 0);
            }
        }

        if (closePartnerReviewModal) {
            closePartnerReviewModal.addEventListener('click', closePartnerModal);
        }

        if (partnerReviewModal) {
            partnerReviewModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closePartnerModal();
                }
            });
        }

        partnerFilterButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                activePartnerRating = this.getAttribute('data-rating') || 'all';
                partnerFilterButtons.forEach(b => {
                    b.classList.remove('bg-gray-800', 'text-white');
                    b.classList.add('border', 'border-gray-300', 'text-gray-700');
                });
                this.classList.add('bg-gray-800', 'text-white');
                this.classList.remove('border', 'border-gray-300', 'text-gray-700');
                applyPartnerReviewFilters();
            });
        });

        if (partnerReviewFrom) {
            partnerReviewFrom.addEventListener('change', applyPartnerReviewFilters);
        }

        if (partnerReviewTo) {
            partnerReviewTo.addEventListener('change', applyPartnerReviewFilters);
        }

        partnerReviewButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const partnerId = this.getAttribute('data-partner-id');
                if (!partnerId) {
                    return;
                }

                partnerReviewModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                const reviewList = document.getElementById('partnerReviewList');
                reviewList.innerHTML = '<p class="text-sm text-gray-500">Loading reviews...</p>';

                fetch(`/api/delivery-partner/${partnerId}/reviews/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load reviews');
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('partnerReviewName').textContent = data.partnerName || 'Partner';
                        document.getElementById('partnerReviewAvg').textContent = data.avgRating !== null
                            ? Number(data.avgRating).toFixed(1)
                            : '—';
                        document.getElementById('partnerReviewCount').textContent = data.reviewCount || 0;

                        if (!data.reviews || data.reviews.length === 0) {
                            reviewList.innerHTML = '<p class="text-sm text-gray-500">No reviews available.</p>';
                            return;
                        }

                        reviewList.innerHTML = data.reviews.map(review => `
                            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200" data-rating="${review.rating}" data-date="${review.dateIso || ''}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-800">${review.customerName || 'Customer'}</p>
                                        <p class="text-xs text-gray-500">Order #${review.orderNumber || '—'}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-gray-800">${review.rating} / 5</p>
                                        <p class="text-xs text-gray-500">${review.date || ''}</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mt-3">${review.comment || 'No comment provided.'}</p>
                            </div>
                        `).join('');

                        reviewList.insertAdjacentHTML('beforeend', '<p id="partnerReviewEmpty" class="text-sm text-gray-500 hidden">No reviews found for the selected filters.</p>');
                        applyPartnerReviewFilters();
                    })
                    .catch(error => {
                        console.error('Error loading reviews:', error);
                        reviewList.innerHTML = '<p class="text-sm text-red-500">Failed to load reviews.</p>';
                    });
            });
        });

        // ===== INVENTORY MANAGEMENT =====
        const inventoryDataScript = document.getElementById('inventoryData');
        const inventoryCategoryScript = document.getElementById('inventoryCategories');
        const inventoryTagsScript = document.getElementById('inventoryTags');
        const inventoryData = inventoryDataScript ? JSON.parse(inventoryDataScript.textContent) : [];
        let inventoryCategories = inventoryCategoryScript ? JSON.parse(inventoryCategoryScript.textContent) : [];
        const inventoryTags = inventoryTagsScript ? JSON.parse(inventoryTagsScript.textContent) : [];
        const inventoryGrid = document.getElementById('inventoryGrid');
        const inventorySearch = document.getElementById('inventorySearch');
        const globalSearch = document.getElementById('globalSearch');
        const inventoryCategory = document.getElementById('inventoryCategory');
        const inventoryStock = document.getElementById('inventoryStock');
        const inventoryClear = document.getElementById('inventoryClear');
        const inventoryCount = document.getElementById('inventoryCount');
        const inventoryPrev = document.getElementById('inventoryPrev');
        const inventoryNext = document.getElementById('inventoryNext');
        const inventoryPerPage = document.getElementById('inventoryPerPage');
        const inventoryManageModal = document.getElementById('inventoryManageModal');
        const inventoryCategoryModal = document.getElementById('inventoryCategoryModal');
        const inventoryAddModal = document.getElementById('inventoryAddModal');
        const openInventoryCategories = document.getElementById('openInventoryCategories');
        const openInventoryAddProduct = document.getElementById('openInventoryAddProduct');
        const closeInventoryManage = document.getElementById('closeInventoryManage');
        const closeInventoryCategory = document.getElementById('closeInventoryCategory');
        const closeInventoryAdd = document.getElementById('closeInventoryAdd');
        const inventoryManageTitle = document.getElementById('inventoryManageTitle');
        const inventoryVariantList = document.getElementById('inventoryVariantList');
        const inventoryDetailName = document.getElementById('inventoryDetailName');
        const inventoryDetailCategory = document.getElementById('inventoryDetailCategory');
        const inventoryDetailSubcategory = document.getElementById('inventoryDetailSubcategory');
        const inventoryDetailTags = document.getElementById('inventoryDetailTags');
        const inventoryDetailDescription = document.getElementById('inventoryDetailDescription');
        const inventoryDetailActive = document.getElementById('inventoryDetailActive');
        const inventoryDetailThumbnail = document.getElementById('inventoryDetailThumbnail');
        const inventoryDetailGallery = document.getElementById('inventoryDetailGallery');
        const inventoryDetailThumbnailPreview = document.getElementById('inventoryDetailThumbnailPreview');
        const inventoryDetailGalleryPreview = document.getElementById('inventoryDetailGalleryPreview');
        const inventoryGalleryPreview = document.getElementById('inventoryGalleryPreview');
        const inventorySaveBtn = document.getElementById('inventorySaveBtn');
        const inventoryDeleteBtn = document.getElementById('inventoryDeleteBtn');
        const inventoryTabButtons = document.querySelectorAll('.inventory-tab-btn');
        const inventoryTabVariants = document.getElementById('inventoryTabVariants');
        const inventoryTabDetails = document.getElementById('inventoryTabDetails');
        const newVariantSize = document.getElementById('newVariantSize');
        const newVariantUnit = document.getElementById('newVariantUnit');
        const newVariantBatch = document.getElementById('newVariantBatch');
        const newVariantStock = document.getElementById('newVariantStock');
        const newVariantPrice = document.getElementById('newVariantPrice');
        const newVariantExpiry = document.getElementById('newVariantExpiry');
        const newVariantMfg = document.getElementById('newVariantMfg');
        const addVariantBtn = document.getElementById('addVariantBtn');
        const variantError = document.getElementById('variantError');
        const categoryTabButtons = document.querySelectorAll('.category-tab-btn');
        const categoryTabCategories = document.getElementById('categoryTabCategories');
        const categoryTabSubcategories = document.getElementById('categoryTabSubcategories');
        const inventoryCategoryList = document.getElementById('inventoryCategoryList');
        const inventorySubcategoryList = document.getElementById('inventorySubcategoryList');
        const newCategoryName = document.getElementById('newCategoryName');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const subcategoryParent = document.getElementById('subcategoryParent');
        const newSubcategoryName = document.getElementById('newSubcategoryName');
        const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');
        const categoryError = document.getElementById('categoryError');
        const addProductForm = document.getElementById('inventoryAddForm');
        const addProductName = document.getElementById('addProductName');
        const addProductCategory = document.getElementById('addProductCategory');
        const addProductSubcategory = document.getElementById('addProductSubcategory');
        const addProductTags = document.getElementById('addProductTags');
        const addProductDescription = document.getElementById('addProductDescription');
        const addProductThumbnail = document.getElementById('addProductThumbnail');
        const addProductGallery = document.getElementById('addProductGallery');
        const addProductActive = document.getElementById('addProductActive');
        const addThumbnailPreview = document.getElementById('addThumbnailPreview');
        const addGalleryPreview = document.getElementById('addGalleryPreview');
        const addProductVariantRow = document.getElementById('addProductVariantRow');
        const addProductVariants = document.getElementById('addProductVariants');
        const addProductError = document.getElementById('addProductError');
        const inventoryTagList = document.getElementById('inventoryTagList');

        let inventoryPage = 1;
        let inventoryPageSize = inventoryPerPage ? Number(inventoryPerPage.value) : 8;

        let currentInventoryProduct = null;
        const MAX_PRODUCT_IMAGE_SIZE_BYTES = 5 * 1024 * 1024;
        const MAX_PRODUCT_IMAGE_SIZE_MB = 5;
        const ALLOWED_PRODUCT_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
        const ALLOWED_PRODUCT_IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.webp', '.gif'];

        function validateProductImageFile(file) {
            if (!file) {
                return '';
            }

            const fileType = (file.type || '').toLowerCase();
            const fileName = (file.name || '').toLowerCase();
            const hasValidType = ALLOWED_PRODUCT_IMAGE_TYPES.includes(fileType);
            const hasValidExtension = ALLOWED_PRODUCT_IMAGE_EXTENSIONS.some(ext => fileName.endsWith(ext));

            if (file.size > MAX_PRODUCT_IMAGE_SIZE_BYTES) {
                return `${file.name} is too large. Max allowed size is ${MAX_PRODUCT_IMAGE_SIZE_MB}MB.`;
            }

            if (!hasValidType && !hasValidExtension) {
                return `${file.name} is not a valid image. Only JPG, JPEG, PNG, WEBP, and GIF are allowed. PDF files are not allowed.`;
            }

            return '';
        }

        function validateProductImageFiles(files) {
            for (const file of Array.from(files || [])) {
                const error = validateProductImageFile(file);
                if (error) {
                    return error;
                }
            }
            return '';
        }

        if (addProductThumbnail) {
            addProductThumbnail.setAttribute('accept', 'image/jpeg,image/png,image/webp,image/gif');
        }
        if (addProductGallery) {
            addProductGallery.setAttribute('accept', 'image/jpeg,image/png,image/webp,image/gif');
        }
        if (inventoryDetailThumbnail) {
            inventoryDetailThumbnail.setAttribute('accept', 'image/jpeg,image/png,image/webp,image/gif');
        }
        if (inventoryDetailGallery) {
            inventoryDetailGallery.setAttribute('accept', 'image/jpeg,image/png,image/webp,image/gif');
        }

        function formatStockBadge(stock) {
            if (stock === 0) {
                return '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">Out of Stock</span>';
            }
            if (stock < 20) {
                return '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-100 text-yellow-700">Low Stock</span>';
            }
            return '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">In Stock</span>';
        }

        function renderInventoryCards(items) {
            if (!inventoryGrid) {
                return;
            }

            if (!items.length) {
                inventoryGrid.innerHTML = '<p class="text-sm text-gray-500">No products found.</p>';
                if (inventoryCount) {
                    inventoryCount.textContent = 'Showing 0-0 of 0';
                }
                return;
            }

            const totalItems = items.length;
            const maxPage = Math.max(1, Math.ceil(totalItems / inventoryPageSize));
            if (inventoryPage > maxPage) {
                inventoryPage = maxPage;
            }
            const startIndex = (inventoryPage - 1) * inventoryPageSize;
            const endIndex = Math.min(startIndex + inventoryPageSize, totalItems);
            const pageItems = items.slice(startIndex, endIndex);

            if (inventoryCount) {
                inventoryCount.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalItems}`;
            }

            if (inventoryPrev) {
                inventoryPrev.disabled = inventoryPage <= 1;
                inventoryPrev.classList.toggle('opacity-40', inventoryPage <= 1);
            }

            if (inventoryNext) {
                inventoryNext.disabled = endIndex >= totalItems;
                inventoryNext.classList.toggle('opacity-40', endIndex >= totalItems);
            }

            inventoryGrid.innerHTML = pageItems.map(item => {
                const imageUrl = item.thumbnail || '/static/images/default-product.png';
                const categoryText = item.subcategory ? `${item.category} > ${item.subcategory}` : item.category;
                return `
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-[0_10px_24px_rgba(14,27,20,0.08)]">
                        <div class="relative">
                            <img src="${imageUrl}" alt="${item.name}" class="w-full h-44 object-cover" onerror="this.src='/static/images/default-product.png'">
                            <div class="absolute top-3 right-3 bg-white rounded-full px-3 py-2 font-semibold text-sm flex items-center gap-1 shadow-lg">
                                <i class="fas fa-box text-ayur-primary"></i>
                                <span class="text-ayur-primary">${item.total_stock}</span>
                            </div>
                            <button class="inventory-manage-btn absolute bottom-3 right-3 w-10 h-10 rounded-full bg-white text-gray-700 shadow hover:bg-ayur-primary hover:text-white transition-all" data-product-id="${item.id}">
                                <i class="fas fa-gear"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <p class="text-[10px] uppercase tracking-widest text-gray-400">${categoryText}</p>
                            <h4 class="mt-2 font-semibold text-gray-800">${item.name}</h4>
                            <p class="text-xs text-gray-500 mt-1">Buy Only</p>
                            <div class="flex items-center justify-between mt-3">
                                <span class="text-xs font-semibold text-ayur-primary">${item.variant_count} Variants</span>
                                ${formatStockBadge(item.total_stock)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateCategoryOptions() {
            if (!inventoryCategory || !inventoryDetailCategory || !subcategoryParent || !addProductCategory) {
                return;
            }

            inventoryCategory.innerHTML = '<option value="all">All Categories</option>';
            inventoryDetailCategory.innerHTML = '';
            subcategoryParent.innerHTML = '';
            addProductCategory.innerHTML = '';

            inventoryCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = String(category.id);
                option.textContent = category.name;
                inventoryCategory.appendChild(option.cloneNode(true));
                inventoryDetailCategory.appendChild(option.cloneNode(true));
                subcategoryParent.appendChild(option.cloneNode(true));
                addProductCategory.appendChild(option.cloneNode(true));
            });
        }

        if (inventoryTagList && inventoryTags.length) {
            inventoryTagList.innerHTML = inventoryTags.map(tag => `<option value="${tag}"></option>`).join('');
        }

        function populateSubcategoryOptions(categoryId, targetSelect) {
            if (!targetSelect) {
                return;
            }
            targetSelect.innerHTML = '';
            const selected = inventoryCategories.find(cat => String(cat.id) === String(categoryId));
            if (!selected || !selected.subcategories.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No Sub Category';
                targetSelect.appendChild(opt);
                return;
            }
            selected.subcategories.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = String(sub.id);
                opt.textContent = sub.name;
                targetSelect.appendChild(opt);
            });
        }

        function renderCategoryLists() {
            if (!inventoryCategoryList || !inventorySubcategoryList) {
                return;
            }

            inventoryCategoryList.innerHTML = inventoryCategories.map(category => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${category.name}</p>
                        <p class="text-xs text-gray-400">${category.subcategories.length} sub categories</p>
                    </div>
                    <button class="category-remove-btn text-red-500" data-category-id="${category.id}"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');

            const subItems = [];
            inventoryCategories.forEach(category => {
                category.subcategories.forEach(sub => {
                    subItems.push({
                        id: sub.id,
                        name: sub.name,
                        categoryName: category.name,
                        categoryId: category.id
                    });
                });
            });

            inventorySubcategoryList.innerHTML = subItems.map(sub => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${sub.name}</p>
                        <p class="text-xs text-gray-400">${sub.categoryName}</p>
                    </div>
                    <button class="subcategory-remove-btn text-red-500" data-category-id="${sub.categoryId}" data-sub-id="${sub.id}"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function applyInventoryFilters(keepPage = false) {
            const searchValue = (globalSearch?.value || inventorySearch?.value || '').toLowerCase().trim();
            const categoryValue = inventoryCategory?.value || 'all';
            const stockValue = inventoryStock?.value || 'all';

            const filtered = inventoryData.filter(item => {
                const matchesSearch = !searchValue || item.name.toLowerCase().includes(searchValue);
                const matchesCategory = categoryValue === 'all' || String(item.category_id) === String(categoryValue);
                let matchesStock = true;
                if (stockValue === 'out') {
                    matchesStock = item.total_stock === 0;
                } else if (stockValue === 'low') {
                    matchesStock = item.total_stock > 0 && item.total_stock < 20;
                } else if (stockValue === 'in') {
                    matchesStock = item.total_stock >= 20;
                }
                return matchesSearch && matchesCategory && matchesStock;
            });

            if (!keepPage) {
                inventoryPage = 1;
            }
            renderInventoryCards(filtered);
        }

        function resetInventoryTabs() {
            inventoryTabButtons.forEach(btn => {
                btn.classList.remove('text-ayur-primary', 'border-ayur-primary');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            inventoryTabButtons[0]?.classList.add('text-ayur-primary', 'border-ayur-primary');
            inventoryTabButtons[0]?.classList.remove('text-gray-500', 'border-transparent');
            inventoryTabVariants?.classList.remove('hidden');
            inventoryTabDetails?.classList.add('hidden');
        }

        function openInventoryModal(productId) {
            currentInventoryProduct = inventoryData.find(item => String(item.id) === String(productId)) || null;
            inventoryManageTitle.textContent = currentInventoryProduct ? currentInventoryProduct.name : 'New Product';

            if (currentInventoryProduct) {
                inventoryDetailName.value = currentInventoryProduct.name;
                inventoryDetailCategory.value = currentInventoryProduct.category_id || '';
                populateSubcategoryOptions(currentInventoryProduct.category_id, inventoryDetailSubcategory);
                inventoryDetailSubcategory.value = currentInventoryProduct.subcategory_id || '';
                inventoryDetailTags.value = currentInventoryProduct.tags.join(', ');
                inventoryDetailDescription.value = currentInventoryProduct.description;
                inventoryDetailActive.checked = currentInventoryProduct.is_active;
                if (inventoryDetailThumbnailPreview) {
                    if (currentInventoryProduct.thumbnail) {
                        inventoryDetailThumbnailPreview.innerHTML = `<img src="${currentInventoryProduct.thumbnail}" class="w-full h-full object-cover rounded-xl" alt="Thumbnail">`;
                        inventoryDetailThumbnailPreview.classList.remove('text-gray-400');
                    } else {
                        inventoryDetailThumbnailPreview.innerHTML = 'Preview';
                        inventoryDetailThumbnailPreview.classList.add('text-gray-400');
                    }
                }
                if (inventoryDetailGalleryPreview) {
                    inventoryDetailGalleryPreview.innerHTML = '';
                }
            } else {
                inventoryDetailName.value = '';
                inventoryDetailCategory.value = inventoryCategories[0]?.id || '';
                populateSubcategoryOptions(inventoryDetailCategory.value, inventoryDetailSubcategory);
                inventoryDetailSubcategory.value = '';
                inventoryDetailTags.value = '';
                inventoryDetailDescription.value = '';
                inventoryDetailActive.checked = true;
                if (inventoryDetailThumbnailPreview) {
                    inventoryDetailThumbnailPreview.innerHTML = 'Preview';
                    inventoryDetailThumbnailPreview.classList.add('text-gray-400');
                }
                if (inventoryDetailGalleryPreview) {
                    inventoryDetailGalleryPreview.innerHTML = '';
                }
            }

            const variants = currentInventoryProduct ? currentInventoryProduct.variants : [];
            inventoryVariantList.innerHTML = variants.length
                ? variants.map(variant => `
                    <tr data-variant-id="${variant.id}">
                        <td class="p-3"><input class="variant-size w-full px-2 py-1 rounded border border-gray-200 text-xs" type="number" min="1" value="${variant.unit_value}"></td>
                        <td class="p-3">
                            <select class="variant-unit w-full px-2 py-1 rounded border border-gray-200 text-xs">
                                <option value="ml" ${variant.unit_type === 'ml' ? 'selected' : ''}>ml</option>
                                <option value="g" ${variant.unit_type === 'g' ? 'selected' : ''}>g</option>
                                <option value="kg" ${variant.unit_type === 'kg' ? 'selected' : ''}>kg</option>
                                <option value="l" ${variant.unit_type === 'l' ? 'selected' : ''}>l</option>
                                <option value="pc" ${variant.unit_type === 'pc' ? 'selected' : ''}>pc</option>
                            </select>
                        </td>
                        <td class="p-3"><input class="variant-batch w-full px-2 py-1 rounded border border-gray-200 text-xs" value="${variant.batch_number}"></td>
                        <td class="p-3"><input class="variant-stock w-full px-2 py-1 rounded border border-gray-200 text-xs" type="number" min="0" value="${variant.stock}"></td>
                        <td class="p-3"><input class="variant-price w-full px-2 py-1 rounded border border-gray-200 text-xs" type="number" min="0" step="0.01" value="${variant.price}"></td>
                        <td class="p-3"><input class="variant-mfg w-full px-2 py-1 rounded border border-gray-200 text-xs" type="date" value="${variant.manufacturing_date || ''}"></td>
                        <td class="p-3"><input class="variant-expiry w-full px-2 py-1 rounded border border-gray-200 text-xs" type="date" value="${variant.expiry_date || ''}"></td>
                        <td class="p-3">
                            <button class="variant-remove-btn text-red-500" data-variant-id="${variant.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="7" class="p-4 text-center text-gray-500">No variants found.</td></tr>';

            inventoryGalleryPreview.innerHTML = currentInventoryProduct && currentInventoryProduct.gallery.length
                ? currentInventoryProduct.gallery.map(url => `
                    <div class="w-16 h-16 rounded-lg overflow-hidden border border-gray-200">
                        <img src="${url}" alt="Gallery" class="w-full h-full object-cover" onerror="this.style.display='none'">
                    </div>
                `).join('')
                : '<p class="text-xs text-gray-400">No gallery images yet.</p>';

            resetInventoryTabs();
            inventoryManageModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function openAddProductModal() {
            if (addProductForm) {
                addProductForm.reset();
            }
            if (addProductVariants) {
                addProductVariants.innerHTML = '';
            }
            if (addThumbnailPreview) {
                addThumbnailPreview.innerHTML = 'Preview';
                addThumbnailPreview.classList.add('text-gray-400');
            }
            if (addGalleryPreview) {
                addGalleryPreview.innerHTML = '';
            }
            addProductError?.classList.add('hidden');
            populateSubcategoryOptions(addProductCategory.value, addProductSubcategory);
            inventoryAddModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddProductModal() {
            inventoryAddModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function closeInventoryModal() {
            inventoryManageModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function openCategoryModal() {
            renderCategoryLists();
            inventoryCategoryModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeCategoryModal() {
            inventoryCategoryModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        if (inventoryGrid) {
            inventoryGrid.addEventListener('click', event => {
                const button = event.target.closest('.inventory-manage-btn');
                if (button) {
                    const productId = button.getAttribute('data-product-id');
                    openInventoryModal(productId);
                }
            });
        }

        if (openInventoryCategories) {
            openInventoryCategories.addEventListener('click', openCategoryModal);
        }

        if (openInventoryAddProduct) {
            openInventoryAddProduct.addEventListener('click', openAddProductModal);
        }

        if (closeInventoryManage) {
            closeInventoryManage.addEventListener('click', closeInventoryModal);
        }

        if (closeInventoryCategory) {
            closeInventoryCategory.addEventListener('click', closeCategoryModal);
        }

        if (closeInventoryAdd) {
            closeInventoryAdd.addEventListener('click', closeAddProductModal);
        }

        if (inventoryManageModal) {
            inventoryManageModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeInventoryModal();
                }
            });
        }

        if (inventoryCategoryModal) {
            inventoryCategoryModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeCategoryModal();
                }
            });
        }

        if (inventoryAddModal) {
            inventoryAddModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeAddProductModal();
                }
            });
        }

        inventoryTabButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const target = this.getAttribute('data-inventory-tab');
                inventoryTabButtons.forEach(item => {
                    item.classList.remove('text-ayur-primary', 'border-ayur-primary');
                    item.classList.add('text-gray-500', 'border-transparent');
                });
                this.classList.add('text-ayur-primary', 'border-ayur-primary');
                this.classList.remove('text-gray-500', 'border-transparent');
                inventoryTabVariants.classList.toggle('hidden', target !== 'variants');
                inventoryTabDetails.classList.toggle('hidden', target !== 'details');
            });
        });

        categoryTabButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const target = this.getAttribute('data-category-tab');
                categoryTabButtons.forEach(item => {
                    item.classList.remove('text-ayur-primary', 'border-ayur-primary');
                    item.classList.add('text-gray-500', 'border-transparent');
                });
                this.classList.add('text-ayur-primary', 'border-ayur-primary');
                this.classList.remove('text-gray-500', 'border-transparent');
                categoryTabCategories.classList.toggle('hidden', target !== 'categories');
                categoryTabSubcategories.classList.toggle('hidden', target !== 'subcategories');
            });
        });

        if (inventoryDetailCategory) {
            inventoryDetailCategory.addEventListener('change', function () {
                populateSubcategoryOptions(this.value, inventoryDetailSubcategory);
            });
        }

        if (addProductCategory) {
            addProductCategory.addEventListener('change', function () {
                populateSubcategoryOptions(this.value, addProductSubcategory);
            });
        }

        if (inventorySearch) {
            inventorySearch.addEventListener('input', applyInventoryFilters);
        }

        if (inventoryCategory) {
            inventoryCategory.addEventListener('change', applyInventoryFilters);
        }

        if (inventoryStock) {
            inventoryStock.addEventListener('change', applyInventoryFilters);
        }

        if (inventoryClear) {
            inventoryClear.addEventListener('click', function () {
                inventorySearch.value = '';
                inventoryCategory.value = 'all';
                inventoryStock.value = 'all';
                applyInventoryFilters();
            });
        }

        if (inventoryPrev) {
            inventoryPrev.addEventListener('click', function () {
                if (inventoryPage > 1) {
                    inventoryPage -= 1;
                    applyInventoryFilters(true);
                }
            });
        }

        if (inventoryNext) {
            inventoryNext.addEventListener('click', function () {
                inventoryPage += 1;
                applyInventoryFilters(true);
            });
        }

        if (inventoryPerPage) {
            inventoryPerPage.addEventListener('change', function () {
                inventoryPageSize = Number(this.value);
                inventoryPage = 1;
                applyInventoryFilters();
            });
        }

        if (addVariantBtn) {
            addVariantBtn.addEventListener('click', function () {
                const size = newVariantSize.value.trim();
                const unit = newVariantUnit.value;
                const batch = newVariantBatch.value.trim();
                const stock = newVariantStock.value.trim();
                const price = newVariantPrice.value.trim();
                const mfg = newVariantMfg.value.trim();
                const expiry = newVariantExpiry.value.trim();

                if (!size || !batch || stock === '' || price === '' || !expiry) {
                    variantError.classList.remove('hidden');
                    return;
                }

                variantError.classList.add('hidden');
                const emptyRow = inventoryVariantList.querySelector('tr td');
                if (emptyRow && emptyRow.textContent.includes('No variants')) {
                    inventoryVariantList.innerHTML = '';
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3">${size}${unit}</td>
                    <td class="p-3">${batch}</td>
                    <td class="p-3">${stock}</td>
                    <td class="p-3">₹${Number(price).toFixed(2)}</td>
                    <td class="p-3">${mfg || '-'}</td>
                    <td class="p-3">${expiry}</td>
                    <td class="p-3"><button class="variant-remove-btn text-red-500"><i class="fas fa-trash"></i></button></td>
                `;
                inventoryVariantList.appendChild(row);
                newVariantSize.value = '';
                newVariantBatch.value = '';
                newVariantStock.value = '';
                newVariantPrice.value = '';
                newVariantMfg.value = '';
                newVariantExpiry.value = '';
            });
        }

        if (inventoryVariantList) {
            inventoryVariantList.addEventListener('click', function (event) {
                const btn = event.target.closest('.variant-remove-btn');
                if (btn) {
                    const row = btn.closest('tr');
                    if (row) {
                        row.remove();
                    }
                }
            });
        }

        if (addCategoryBtn) {
            addCategoryBtn.addEventListener('click', function () {
                const name = newCategoryName.value.trim();
                if (!name) {
                    categoryError.classList.remove('hidden');
                    return;
                }
                categoryError.classList.add('hidden');
                const newCategory = {
                    id: Date.now(),
                    name,
                    subcategories: []
                };
                inventoryCategories.push(newCategory);
                newCategoryName.value = '';
                populateCategoryOptions();
                renderCategoryLists();
            });
        }

        if (addSubcategoryBtn) {
            addSubcategoryBtn.addEventListener('click', function () {
                const parentId = subcategoryParent.value;
                const name = newSubcategoryName.value.trim();
                if (!parentId || !name) {
                    categoryError.classList.remove('hidden');
                    return;
                }
                categoryError.classList.add('hidden');
                const parent = inventoryCategories.find(cat => String(cat.id) === String(parentId));
                if (!parent) {
                    return;
                }
                parent.subcategories.push({ id: Date.now(), name });
                newSubcategoryName.value = '';
                populateCategoryOptions();
                renderCategoryLists();
            });
        }

        if (inventoryCategoryList) {
            inventoryCategoryList.addEventListener('click', function (event) {
                const btn = event.target.closest('.category-remove-btn');
                if (!btn) {
                    return;
                }
                const id = btn.getAttribute('data-category-id');
                inventoryCategories = inventoryCategories.filter(cat => String(cat.id) !== String(id));
                populateCategoryOptions();
                renderCategoryLists();
            });
        }

        if (inventorySubcategoryList) {
            inventorySubcategoryList.addEventListener('click', function (event) {
                const btn = event.target.closest('.subcategory-remove-btn');
                if (!btn) {
                    return;
                }
                const catId = btn.getAttribute('data-category-id');
                const subId = btn.getAttribute('data-sub-id');
                const parent = inventoryCategories.find(cat => String(cat.id) === String(catId));
                if (!parent) {
                    return;
                }
                parent.subcategories = parent.subcategories.filter(sub => String(sub.id) !== String(subId));
                populateCategoryOptions();
                renderCategoryLists();
            });
        }

        if (inventorySaveBtn) {
            inventorySaveBtn.addEventListener('click', function () {
                if (!currentInventoryProduct) {
                    return;
                }
                const rows = Array.from(inventoryVariantList.querySelectorAll('tr'));
                const variants = rows.map(row => ({
                    id: row.getAttribute('data-variant-id'),
                    unit_value: row.querySelector('.variant-size')?.value || '',
                    unit_type: row.querySelector('.variant-unit')?.value || 'ml',
                    batch_number: row.querySelector('.variant-batch')?.value || '',
                    stock: row.querySelector('.variant-stock')?.value || '',
                    price: row.querySelector('.variant-price')?.value || '',
                    manufacturing_date: row.querySelector('.variant-mfg')?.value || '',
                    expiry_date: row.querySelector('.variant-expiry')?.value || ''
                }));

                const invalidVariant = variants.some(variant => !variant.unit_value || !variant.batch_number || variant.stock === '' || variant.price === '' || !variant.expiry_date);
                if (invalidVariant) {
                    variantError.textContent = 'Please fill all variant fields.';
                    variantError.classList.remove('hidden');
                    return;
                }

                const detailThumbnailError = validateProductImageFiles(inventoryDetailThumbnail?.files);
                if (detailThumbnailError) {
                    variantError.textContent = detailThumbnailError;
                    variantError.classList.remove('hidden');
                    return;
                }

                const detailGalleryError = validateProductImageFiles(inventoryDetailGallery?.files);
                if (detailGalleryError) {
                    variantError.textContent = detailGalleryError;
                    variantError.classList.remove('hidden');
                    return;
                }

                variantError.classList.add('hidden');

                const formData = new FormData();
                formData.append('name', inventoryDetailName.value.trim());
                formData.append('category', inventoryDetailCategory.value || '');
                formData.append('subcategory', inventoryDetailSubcategory.value || '');
                formData.append('tags', inventoryDetailTags.value.trim());
                formData.append('description', inventoryDetailDescription.value.trim());
                formData.append('is_active', inventoryDetailActive.checked ? 'true' : 'false');
                formData.append('variants', JSON.stringify(variants));
                if (inventoryDetailThumbnail?.files?.length) {
                    formData.append('thumbnail', inventoryDetailThumbnail.files[0]);
                }
                Array.from(inventoryDetailGallery?.files || []).forEach(file => {
                    formData.append('gallery_images', file);
                });

                fetch(`/inventory/products/${currentInventoryProduct.id}/update/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.error || 'Failed to update product');
                        }
                        const index = inventoryData.findIndex(item => item.id === data.product.id);
                        if (index > -1) {
                            inventoryData[index] = data.product;
                        }
                        if (inventoryTagList && data.product.tags && data.product.tags.length) {
                            data.product.tags.forEach(tag => {
                                if (!inventoryTags.includes(tag)) {
                                    inventoryTags.push(tag);
                                }
                            });
                            inventoryTagList.innerHTML = inventoryTags.map(tag => `<option value="${tag}"></option>`).join('');
                        }
                        applyInventoryFilters(true);
                        closeInventoryModal();
                    })
                    .catch(error => {
                        console.error('Error updating product:', error);
                        variantError.textContent = error.message || 'Failed to update product.';
                        variantError.classList.remove('hidden');
                    });
            });
        }

        if (inventoryDeleteBtn) {
            inventoryDeleteBtn.addEventListener('click', function () {
                if (!currentInventoryProduct) {
                    return;
                }
                if (!confirm('Delete this product?')) {
                    return;
                }
                fetch(`/inventory/products/${currentInventoryProduct.id}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.error || 'Failed to delete product');
                        }
                        const index = inventoryData.findIndex(item => item.id === currentInventoryProduct.id);
                        if (index > -1) {
                            inventoryData.splice(index, 1);
                        }
                        applyInventoryFilters(true);
                        closeInventoryModal();
                    })
                    .catch(error => {
                        console.error('Error deleting product:', error);
                        alert(error.message || 'Failed to delete product.');
                    });
            });
        }

        if (inventoryDetailThumbnail) {
            inventoryDetailThumbnail.addEventListener('change', function () {
                const file = this.files[0];
                const error = validateProductImageFile(file);
                if (error) {
                    variantError.textContent = error;
                    variantError.classList.remove('hidden');
                    this.value = '';
                    return;
                }
                variantError.classList.add('hidden');
                if (!file || !inventoryDetailThumbnailPreview) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = function (e) {
                    inventoryDetailThumbnailPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-xl" alt="Thumbnail">`;
                    inventoryDetailThumbnailPreview.classList.remove('text-gray-400');
                };
                reader.readAsDataURL(file);
            });
        }

        if (inventoryDetailGallery) {
            inventoryDetailGallery.addEventListener('change', function () {
                const error = validateProductImageFiles(this.files);
                if (error) {
                    variantError.textContent = error;
                    variantError.classList.remove('hidden');
                    this.value = '';
                    if (inventoryDetailGalleryPreview) {
                        inventoryDetailGalleryPreview.innerHTML = '';
                    }
                    return;
                }
                variantError.classList.add('hidden');
                if (!inventoryDetailGalleryPreview) {
                    return;
                }
                inventoryDetailGalleryPreview.innerHTML = '';
                Array.from(this.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'w-16 h-16 rounded-lg overflow-hidden border border-gray-200';
                        wrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="Gallery">`;
                        inventoryDetailGalleryPreview.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        if (addProductVariantRow) {
            addProductVariantRow.addEventListener('click', function () {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3"><input class="variant-size w-full px-2 py-1 rounded border border-gray-200 text-xs" placeholder="100" type="number" min="1" required></td>
                    <td class="p-3">
                        <select class="variant-unit w-full px-2 py-1 rounded border border-gray-200 text-xs">
                            <option value="ml">ml</option>
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="l">l</option>
                            <option value="pc">pc</option>
                        </select>
                    </td>
                    <td class="p-3"><input class="variant-batch w-full px-2 py-1 rounded border border-gray-200 text-xs" placeholder="Batch" required></td>
                    <td class="p-3"><input class="variant-stock w-full px-2 py-1 rounded border border-gray-200 text-xs" type="number" min="0" placeholder="10" required></td>
                    <td class="p-3"><input class="variant-price w-full px-2 py-1 rounded border border-gray-200 text-xs" type="number" min="0" step="0.01" placeholder="30" required></td>
                    <td class="p-3"><input class="variant-mfg w-full px-2 py-1 rounded border border-gray-200 text-xs" type="date"></td>
                    <td class="p-3"><input class="variant-expiry w-full px-2 py-1 rounded border border-gray-200 text-xs" type="date" required></td>
                    <td class="p-3"><button type="button" class="remove-add-variant text-red-500"><i class="fas fa-trash"></i></button></td>
                `;
                addProductVariants.appendChild(row);
            });
        }

        if (addProductVariants) {
            addProductVariants.addEventListener('click', function (event) {
                const btn = event.target.closest('.remove-add-variant');
                if (btn) {
                    const row = btn.closest('tr');
                    if (row) {
                        row.remove();
                    }
                }
            });
        }

        if (addProductForm) {
            addProductForm.addEventListener('submit', function (event) {
                event.preventDefault();

                const rows = Array.from(addProductVariants.querySelectorAll('tr'));
                const hasVariants = rows.length > 0;
                const requiredOk = addProductName.value.trim() && addProductCategory.value && addProductThumbnail.files.length > 0;

                const variants = rows.map(row => ({
                    unit_value: row.querySelector('.variant-size')?.value || '',
                    unit_type: row.querySelector('.variant-unit')?.value || 'ml',
                    batch_number: row.querySelector('.variant-batch')?.value || '',
                    stock: row.querySelector('.variant-stock')?.value || '',
                    price: row.querySelector('.variant-price')?.value || '',
                    manufacturing_date: row.querySelector('.variant-mfg')?.value || '',
                    expiry_date: row.querySelector('.variant-expiry')?.value || '',
                }));

                const variantsValid = variants.every(variant => (
                    variant.unit_value && variant.batch_number && variant.stock !== '' && variant.price !== '' && variant.expiry_date
                ));

                if (!hasVariants || !requiredOk || !variantsValid) {
                    addProductError.classList.remove('hidden');
                    return;
                }

                const addThumbnailError = validateProductImageFiles(addProductThumbnail?.files);
                if (addThumbnailError) {
                    addProductError.textContent = addThumbnailError;
                    addProductError.classList.remove('hidden');
                    return;
                }

                const addGalleryError = validateProductImageFiles(addProductGallery?.files);
                if (addGalleryError) {
                    addProductError.textContent = addGalleryError;
                    addProductError.classList.remove('hidden');
                    return;
                }

                addProductError.classList.add('hidden');
                const formData = new FormData();
                formData.append('name', addProductName.value.trim());
                formData.append('category', addProductCategory.value);
                formData.append('subcategory', addProductSubcategory.value || '');
                formData.append('tags', addProductTags.value.trim());
                formData.append('description', addProductDescription.value.trim());
                formData.append('is_active', addProductActive?.checked ? 'true' : 'false');
                formData.append('variants', JSON.stringify(variants));
                formData.append('thumbnail', addProductThumbnail.files[0]);
                Array.from(addProductGallery?.files || []).forEach(file => {
                    formData.append('gallery_images', file);
                });

                fetch('/inventory/products/create/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.error || 'Failed to save product');
                        }
                        inventoryData.unshift(data.product);
                        if (inventoryTagList && data.product.tags && data.product.tags.length) {
                            data.product.tags.forEach(tag => {
                                if (!inventoryTags.includes(tag)) {
                                    inventoryTags.push(tag);
                                }
                            });
                            inventoryTagList.innerHTML = inventoryTags.map(tag => `<option value="${tag}"></option>`).join('');
                        }
                        applyInventoryFilters();
                        closeAddProductModal();
                    })
                    .catch(error => {
                        console.error('Error saving product:', error);
                        addProductError.textContent = error.message || 'Failed to save product.';
                        addProductError.classList.remove('hidden');
                    });
            });
        }

        if (addProductThumbnail) {
            addProductThumbnail.addEventListener('change', function () {
                const file = this.files[0];
                const error = validateProductImageFile(file);
                if (error) {
                    addProductError.textContent = error;
                    addProductError.classList.remove('hidden');
                    this.value = '';
                    return;
                }
                addProductError.classList.add('hidden');
                if (!file || !addThumbnailPreview) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = function (e) {
                    addThumbnailPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-xl" alt="Preview">`;
                    addThumbnailPreview.classList.remove('text-gray-400');
                };
                reader.readAsDataURL(file);
            });
        }

        if (addProductGallery) {
            addProductGallery.addEventListener('change', function () {
                const error = validateProductImageFiles(this.files);
                if (error) {
                    addProductError.textContent = error;
                    addProductError.classList.remove('hidden');
                    this.value = '';
                    if (addGalleryPreview) {
                        addGalleryPreview.innerHTML = '';
                    }
                    return;
                }
                addProductError.classList.add('hidden');
                if (!addGalleryPreview) {
                    return;
                }
                addGalleryPreview.innerHTML = '';
                Array.from(this.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'w-16 h-16 rounded-lg overflow-hidden border border-gray-200';
                        wrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="Gallery">`;
                        addGalleryPreview.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        const addProductLinks = document.querySelectorAll('[data-action="open-add-product"]');
        if (addProductLinks.length) {
            addProductLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    if (window.location.hash !== '#inventory') {
                        window.location.hash = '#inventory';
                    }
                    activateSection('inventory');
                    openAddProductModal();
                });
            });
        }

        if (inventoryCategory && inventoryCategories.length) {
            populateCategoryOptions();
            populateSubcategoryOptions(inventoryDetailCategory.value, inventoryDetailSubcategory);
            populateSubcategoryOptions(addProductCategory.value, addProductSubcategory);
        }

        applyInventoryFilters();


        // Update Order Button Handler
        const updateOrderBtn = document.getElementById('updateOrderBtn');
        if (updateOrderBtn) {
            updateOrderBtn.addEventListener('click', function () {
                const orderId = orderModal.getAttribute('data-current-order-id');
                const newStatus = document.getElementById('modalFulfillmentStatus').value;
                const newDriverId = document.getElementById('modalAssignDriver').value;

                if (!orderId) {
                    console.error('Order ID not found');
                    return;
                }

                // Show loading state
                const originalText = this.textContent;
                this.textContent = 'Updating...';
                this.disabled = true;

                // Prepare data
                const updateData = {
                    status: newStatus,
                    assigned_to: newDriverId || null
                };

                // Send update to backend
                fetch(`/api/order/${orderId}/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(updateData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update the row in the table
                            const rowElement = document.querySelector(`[data-order-id="${orderId}"]`);
                            if (rowElement) {
                                rowElement.setAttribute('data-assigned-driver', newDriverId || '');
                                const driverSelect = rowElement.querySelector('.driver-select');
                                if (driverSelect) {
                                    driverSelect.value = newDriverId || '';
                                }
                            }

                            // Show success message
                            alert('Order updated successfully!');

                            // Close modal
                            orderModal.classList.add('hidden');
                            document.body.style.overflow = 'auto';
                        } else {
                            alert('Error updating order: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to update order. Please try again.');
                    })
                    .finally(() => {
                        // Restore button state
                        this.textContent = originalText;
                        this.disabled = false;
                    });
            });
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ===== ORDER DETAIL MODAL =====

        const orderModal = document.getElementById('orderModal');
        const closeOrderModal = document.getElementById('closeOrderModal');
        const orderViewBtns = document.querySelectorAll('.order-view-btn');

        // Open Modal on View Button Click - Fetch from API
        orderViewBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const orderId = this.getAttribute('data-order-id');
                loadOrderDetails(orderId);
            });
        });

        // Fetch order details from API
        function loadOrderDetails(orderId) {
            // Show loading state
            const orderModal = document.getElementById('orderModal');
            orderModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Fetch from API
            fetch(`/api/order/${orderId}/details/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load order details');
                    }
                    return response.json();
                })
                .then(data => {
                    populateOrderModal(data);
                })
                .catch(error => {
                    console.error('Error loading order:', error);
                    document.getElementById('modalLineItems').innerHTML =
                        '<p class="text-red-500">Error loading order details. Please try again.</p>';
                });
        }

        // Close Modal
        if (closeOrderModal) {
            closeOrderModal.addEventListener('click', function () {
                orderModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
        }

        // Close modal when clicking outside
        if (orderModal) {
            orderModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Populate Modal with Order Data from API
        function populateOrderModal(orderData) {
            // Update header
            document.getElementById('modalOrderNumber').textContent = orderData.orderNumber;
            document.getElementById('modalItemCount').textContent = orderData.items;
            document.getElementById('modalTotal').textContent = orderData.total;
            const invoiceLink = document.getElementById('modalInvoiceLink');
            if (invoiceLink) {
                invoiceLink.href = `/invoice/${orderData.id}/`;
            }

            // Update amounts
            document.getElementById('modalAmountDue').textContent = orderData.amountDue;
            document.getElementById('modalAmountPaid').textContent = orderData.amountPaid;
            document.getElementById('modalOrderTotal').textContent = orderData.total;

            // Update line items
            const lineItemsContainer = document.getElementById('modalLineItems');
            lineItemsContainer.innerHTML = '';

            if (orderData.lineItems && orderData.lineItems.length > 0) {
                orderData.lineItems.forEach(item => {
                    const itemHTML = `
                        <div class="flex gap-3 pb-3 border-b border-gray-200">
                            <div class="w-16 h-16 bg-gray-200 rounded-lg flex-shrink-0 flex items-center justify-center">
                                <i class="fas fa-box text-gray-400"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800 text-sm">${item.name}</p>
                                <div class="flex gap-4 mt-1 text-xs text-gray-500">
                                    <span><strong>SKU:</strong> ${item.sku}</span>
                                    <span><strong>QTY:</strong> ${item.qty}x</span>
                                    <span><strong>SIZE:</strong> ${item.size}</span>
                                </div>
                                <p class="font-semibold text-gray-800 mt-2">${item.price}</p>
                            </div>
                        </div>
                    `;
                    lineItemsContainer.innerHTML += itemHTML;
                });
            }

            // Update summary
            document.getElementById('modalSubtotal').textContent = orderData.subtotal;
            document.getElementById('modalShipping').textContent = orderData.shipping;
            document.getElementById('modalDiscount').textContent = orderData.discount;
            document.getElementById('modalTax').textContent = orderData.tax;
            document.getElementById('modalTotalSummary').textContent = orderData.total;

            // Update customer info
            document.getElementById('modalCustomerName').textContent = orderData.customerName || 'N/A';
            document.getElementById('modalCustomerEmail').textContent = orderData.customerEmail || 'N/A';
            document.getElementById('modalCustomerPhone').textContent = orderData.customerPhone || 'N/A';
            document.getElementById('modalCustomerAddress').textContent = orderData.customerAddress || 'N/A';

            // Update delivery partner info
            document.getElementById('modalDriverName').textContent = orderData.assignedDriver || 'Not Assigned';
            const driverRating = orderData.driverRatingAvg !== null && orderData.driverRatingAvg !== undefined
                ? orderData.driverRatingAvg.toFixed(1)
                : '—';
            document.getElementById('modalDriverRating').textContent = driverRating;
            document.getElementById('modalDriverReviews').textContent = orderData.driverRatingCount || 0;

            // Update payment info
            document.getElementById('modalPaymentMethod').textContent = orderData.paymentMethod || 'N/A';
            document.getElementById('modalPaymentStatus').textContent = orderData.paymentStatus || 'N/A';
            const modalCancelReasonRow = document.getElementById('modalCancelReasonRow');
            const modalCancelReason = document.getElementById('modalCancelReason');
            if (modalCancelReasonRow && modalCancelReason) {
                const hasCancelReason = orderData.status === 'Cancelled' && !!orderData.cancelReason;
                modalCancelReasonRow.classList.toggle('hidden', !hasCancelReason);
                modalCancelReason.textContent = hasCancelReason ? orderData.cancelReason : 'N/A';
            }

            // Update timeline
            const timelineContainer = document.getElementById('modalTimeline');
            timelineContainer.innerHTML = '';

            if (orderData.timeline && orderData.timeline.length > 0) {
                orderData.timeline.forEach((event, index) => {
                    const timelineHTML = `
                        <div class="flex gap-3">
                            <div class="flex flex-col items-center">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center ${event.color} bg-gray-100">
                                    <i class="fas ${event.icon} text-sm"></i>
                                </div>
                                ${index < orderData.timeline.length - 1 ? '<div class="w-0.5 h-8 bg-gray-300 mt-1"></div>' : ''}
                            </div>
                            <div class="pt-1">
                                <p class="font-semibold text-gray-800 text-sm">${event.status}</p>
                                <p class="text-xs text-gray-500">${event.date}</p>
                            </div>
                        </div>
                    `;
                    timelineContainer.innerHTML += timelineHTML;
                });
            }

            // Update fulfillment status
            const fulfillmentStatus = document.getElementById('modalFulfillmentStatus');
            if (fulfillmentStatus) {
                fulfillmentStatus.value = orderData.status || 'Pending';

                // Store current order ID in modal
                orderModal.setAttribute('data-current-order-id', orderData.id);

                // Set assigned driver in dropdown
                const assignDriverSelect = document.getElementById('modalAssignDriver');
                if (assignDriverSelect) {
                    assignDriverSelect.value = orderData.assignedDriverId || '';
                }
            }
        }

        // Returns tabs + Inspect & Refund modal
        const returnTabBtns = document.querySelectorAll('.return-tab-btn');
        const returnTabPanels = document.querySelectorAll('.return-tab-panel');

        function activateReturnTab(tabId) {
            returnTabBtns.forEach(btn => {
                const isActive = btn.getAttribute('data-return-tab') === tabId;
                btn.classList.toggle('text-ayur-primary', isActive);
                btn.classList.toggle('border-ayur-primary', isActive);
                btn.classList.toggle('border-b-2', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
                btn.classList.toggle('border-transparent', !isActive);
            });

            returnTabPanels.forEach(panel => {
                const shouldShow = panel.getAttribute('data-return-panel') === tabId;
                panel.classList.toggle('hidden', !shouldShow);
            });
        }

        if (returnTabBtns.length) {
            activateReturnTab('approval');
            returnTabBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    activateReturnTab(this.getAttribute('data-return-tab'));
                });
            });
        }

        const refundInspectModal = document.getElementById('refundInspectModal');
        const closeRefundInspectModal = document.getElementById('closeRefundInspectModal');
        const cancelRefundBtn = document.getElementById('cancelRefundBtn');
        const refundDamageAmount = document.getElementById('refundDamageAmount');
        const refundFinalAmount = document.getElementById('refundFinalAmount');

        function updateRefundFinal() {
            if (!refundInspectModal || !refundFinalAmount || !refundDamageAmount) {
                return;
            }
            const baseAmount = parseFloat(refundInspectModal.dataset.baseAmount || '0') || 0;
            const damageAmount = Math.max(0, parseFloat(refundDamageAmount.value || '0') || 0);
            const finalAmount = Math.max(0, baseAmount - damageAmount);
            refundFinalAmount.textContent = `\u20B9${finalAmount.toFixed(2)}`;
        }

        function openRefundInspectModal(trigger) {
            if (!refundInspectModal) {
                return;
            }
            const baseAmount = parseFloat(trigger.dataset.amount || '0') || 0;
            refundInspectModal.dataset.baseAmount = baseAmount.toString();
            refundInspectModal.dataset.returnId = trigger.dataset.returnId || '';

            const returnIdEl = document.getElementById('refundInspectReturnId');
            const itemEl = document.getElementById('refundInspectItem');
            const customerEl = document.getElementById('refundInspectCustomer');
            const reasonEl = document.getElementById('refundInspectReason');

            if (returnIdEl) {
                returnIdEl.textContent = `Return ID: ${trigger.dataset.returnId || '-'}`;
            }
            if (itemEl) {
                itemEl.textContent = trigger.dataset.item || '-';
            }
            if (customerEl) {
                customerEl.textContent = trigger.dataset.customer || '-';
            }
            if (reasonEl) {
                reasonEl.textContent = trigger.dataset.reason || '-';
            }
            if (refundDamageAmount) {
                refundDamageAmount.value = 0;
            }
            updateRefundFinal();
            refundInspectModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeRefundInspect() {
            if (!refundInspectModal) {
                return;
            }
            refundInspectModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        const processRefundBtn = document.getElementById('processRefundBtn');
        if (processRefundBtn) {
            processRefundBtn.addEventListener('click', function () {
                if (!refundInspectModal) {
                    return;
                }
                const returnId = refundInspectModal.dataset.returnId;
                const baseAmount = parseFloat(refundInspectModal.dataset.baseAmount || '0') || 0;
                const damageAmount = refundDamageAmount ? Math.max(0, parseFloat(refundDamageAmount.value || '0') || 0) : 0;
                const finalAmount = Math.max(0, baseAmount - damageAmount);

                if (!returnId) {
                    alert('Missing return reference.');
                    return;
                }

                processRefundBtn.disabled = true;
                const originalText = processRefundBtn.textContent;
                processRefundBtn.textContent = 'Processing...';

                fetch(`/returns/${returnId}/refund/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ amount: finalAmount, damage_amount: damageAmount })
                })
                    .then(response => response.json().then(data => ({ ok: response.ok, data })))
                    .then(({ ok, data }) => {
                        if (!ok || data.status !== 'success') {
                            throw new Error(data.message || 'Refund failed.');
                        }
                        alert('Refund processed successfully.');
                        closeRefundInspect();
                        location.reload();
                    })
                    .catch(error => {
                        alert(error.message || 'Refund failed.');
                    })
                    .finally(() => {
                        processRefundBtn.disabled = false;
                        processRefundBtn.textContent = originalText;
                    });
            });
        }

        document.querySelectorAll('.return-refund-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                openRefundInspectModal(this);
            });
        });

        // Return details modal
        const returnDetailsModal = document.getElementById('returnDetailsModal');
        const closeReturnDetailsModal = document.getElementById('closeReturnDetailsModal');
        const returnViewBtns = document.querySelectorAll('.return-view-btn');

        function openReturnDetailsModal(btn) {
            if (!returnDetailsModal) return;
            const returnId = btn.getAttribute('data-return-id') || '—';
            document.getElementById('returnDetailsId').textContent = `Return ID: ${returnId}`;
            document.getElementById('returnDetailsOrder').textContent = btn.getAttribute('data-order') || '—';
            document.getElementById('returnDetailsCustomer').textContent = btn.getAttribute('data-customer') || '—';
            document.getElementById('returnDetailsReason').textContent = btn.getAttribute('data-reason') || '—';
            document.getElementById('returnDetailsStatus').textContent = btn.getAttribute('data-status') || '—';
            document.getElementById('returnDetailsPayment').textContent = btn.getAttribute('data-payment') || '—';
            document.getElementById('returnDetailsAssigned').textContent = btn.getAttribute('data-assigned') || '—';
            document.getElementById('returnDetailsDate').textContent = btn.getAttribute('data-date') || '—';
            returnDetailsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeReturnDetailsModalFn() {
            if (!returnDetailsModal) return;
            returnDetailsModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        returnViewBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                openReturnDetailsModal(this);
            });
        });

        if (closeReturnDetailsModal) {
            closeReturnDetailsModal.addEventListener('click', closeReturnDetailsModalFn);
        }
        if (returnDetailsModal) {
            returnDetailsModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeReturnDetailsModalFn();
                }
            });
        }

        if (closeRefundInspectModal) {
            closeRefundInspectModal.addEventListener('click', closeRefundInspect);
        }
        if (cancelRefundBtn) {
            cancelRefundBtn.addEventListener('click', closeRefundInspect);
        }
        if (refundDamageAmount) {
            refundDamageAmount.addEventListener('input', updateRefundFinal);
        }
        if (refundInspectModal) {
            refundInspectModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeRefundInspect();
                }
            });
        }

        // Return filters (search + date)
        const returnSearch = document.getElementById('returnSearch');
        const returnDateFrom = document.getElementById('returnDateFrom');
        const returnDateTo = document.getElementById('returnDateTo');
        const clearReturnFilters = document.getElementById('clearReturnFilters');

        function applyReturnFilters() {
            const term = (returnSearch?.value || '').toLowerCase().trim();
            const from = returnDateFrom?.value || '';
            const to = returnDateTo?.value || '';
            const rows = document.querySelectorAll('.return-row');

            rows.forEach(row => {
                let show = true;
                const searchText = row.getAttribute('data-return-search') || '';
                const dateVal = row.getAttribute('data-return-date') || '';

                if (term && !searchText.includes(term)) {
                    show = false;
                }
                if (show && from && dateVal && dateVal < from) {
                    show = false;
                }
                if (show && to && dateVal && dateVal > to) {
                    show = false;
                }

                row.style.display = show ? 'table-row' : 'none';
            });
        }

        if (returnSearch) returnSearch.addEventListener('input', applyReturnFilters);
        if (returnDateFrom) returnDateFrom.addEventListener('change', applyReturnFilters);
        if (returnDateTo) returnDateTo.addEventListener('change', applyReturnFilters);
        if (clearReturnFilters) {
            clearReturnFilters.addEventListener('click', function () {
                if (returnSearch) returnSearch.value = '';
                if (returnDateFrom) returnDateFrom.value = '';
                if (returnDateTo) returnDateTo.value = '';
                applyReturnFilters();
            });
        }

        // Navigation functionality
        const navItems = document.querySelectorAll('[data-section]');
        const contentSections = document.querySelectorAll('.content-section');

        function activateSection(sectionId) {
            if (!sectionId) {
                return;
            }

            const target = document.getElementById(sectionId);
            if (!target) {
                return;
            }

            navItems.forEach(nav => nav.classList.remove('nav-item-active', 'text-ayur-primary', 'font-semibold'));
            contentSections.forEach(section => section.classList.remove('active'));

            const activeNav = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeNav) {
                activeNav.classList.add('nav-item-active', 'text-ayur-primary', 'font-semibold');
            }

            target.classList.add('active');
        }

        if (globalSearch) {
            const syncGlobalProductSearch = () => {
                const value = (globalSearch.value || '').trim();
                if (value) {
                    if (window.location.hash !== '#inventory') {
                        window.location.hash = '#inventory';
                    }
                    activateSection('inventory');
                }
                applyInventoryFilters();
            };

            globalSearch.addEventListener('input', syncGlobalProductSearch);
            globalSearch.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    syncGlobalProductSearch();
                }
            });
        }

        navItems.forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                if (sectionId) {
                    window.location.hash = `#${sectionId}`;
                }
                activateSection(sectionId);
            });
        });

        if (window.location.hash) {
            activateSection(window.location.hash.replace('#', ''));
        }

        window.addEventListener('hashchange', () => {
            activateSection(window.location.hash.replace('#', ''));
        });

        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart');
        let revenueChart = null;
        if (revenueCtx) {
            const weeklyRevenueLabelsScript = document.getElementById('weeklyRevenueLabels');
            const weeklyRevenueValuesScript = document.getElementById('weeklyRevenueValues');
            const revenueLabels = weeklyRevenueLabelsScript ? JSON.parse(weeklyRevenueLabelsScript.textContent) : [];
            const revenueValues = weeklyRevenueValuesScript ? JSON.parse(weeklyRevenueValuesScript.textContent) : [];
        revenueChart = new Chart(revenueCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Revenue (\u20B9)',
                    data: revenueValues,
                    borderColor: '#2D5A27',
                    backgroundColor: 'rgba(45, 90, 39, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return '\u20B9' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        }

        // Order Status Chart
        const orderCtx = document.getElementById('orderChart');
        if (orderCtx) {
            const orderStatusLabelsScript = document.getElementById('orderStatusLabels');
            const orderStatusValuesScript = document.getElementById('orderStatusValues');
            const orderStatusLabels = orderStatusLabelsScript ? JSON.parse(orderStatusLabelsScript.textContent) : [];
            const orderStatusValues = orderStatusValuesScript ? JSON.parse(orderStatusValuesScript.textContent) : [];
        new Chart(orderCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: orderStatusLabels,
                datasets: [{
                    data: orderStatusValues,
                    backgroundColor: ['#F59E0B', '#3B82F6', '#8B5CF6', '#10B981', '#EF4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        }

        // Revenue Trend Chart
        const revenueTrendCtx = document.getElementById('revenueTrendChart');
        if (revenueTrendCtx) {
            const monthlyRevenueLabelsScript = document.getElementById('monthlyRevenueLabels');
            const monthlyRevenueValuesScript = document.getElementById('monthlyRevenueValues');
            const revenueLabels = monthlyRevenueLabelsScript ? JSON.parse(monthlyRevenueLabelsScript.textContent) : [];
            const revenueValues = monthlyRevenueValuesScript ? JSON.parse(monthlyRevenueValuesScript.textContent) : [];
        new Chart(revenueTrendCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Monthly Revenue',
                    data: revenueValues,
                    backgroundColor: '#2D5A27'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return '\u20B9' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        }

        // Category Chart
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            const categoryLabelsScript = document.getElementById('categoryLabels');
            const categoryValuesScript = document.getElementById('categoryValues');
            const categoryLabels = categoryLabelsScript ? JSON.parse(categoryLabelsScript.textContent) : [];
            const categoryValues = categoryValuesScript ? JSON.parse(categoryValuesScript.textContent) : [];
        new Chart(categoryCtx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryValues,
                    backgroundColor: ['#2D5A27', '#D4AF37', '#1A3C34', '#6B9B37']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        }
        // Products Chart
        const productsCtx = document.getElementById('productsChart');
        if (productsCtx) {
            const topProductLabelsScript = document.getElementById('topProductLabels');
            const topProductValuesScript = document.getElementById('topProductValues');
            const topProductLabels = topProductLabelsScript ? JSON.parse(topProductLabelsScript.textContent) : [];
            const topProductValues = topProductValuesScript ? JSON.parse(topProductValuesScript.textContent) : [];
            const formatTopProductLabel = (label) => {
                const text = String(label || '').trim();
                if (text.length <= 34) return text;

                const words = text.split(' ');
                const lines = [];
                let line = '';
                words.forEach(word => {
                    const next = line ? `${line} ${word}` : word;
                    if (next.length > 34 && line) {
                        lines.push(line);
                        line = word;
                    } else {
                        line = next;
                    }
                });
                if (line) lines.push(line);
                return lines;
            };
        new Chart(productsCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: topProductLabels,
                datasets: [{
                    label: 'Units Sold',
                    data: topProductValues,
                    backgroundColor: '#2D5A27'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                layout: {
                    padding: {
                        left: 18,
                        right: 8
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            autoSkip: false,
                            padding: 10,
                            callback: function (value) {
                                const label = this.getLabelForValue(value);
                                return formatTopProductLabel(label);
                            }
                        }
                    },
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
        }

        // Revenue filter (no page refresh)
        const revenueRange = document.getElementById('revenueRange');
        const revenueCustomInputs = document.getElementById('revenueCustomInputs');
        const revenueFrom = document.getElementById('revenueFrom');
        const revenueTo = document.getElementById('revenueTo');
        const revenueApply = document.getElementById('revenueApply');
        const revenueStatus = document.getElementById('revenueStatus');

        function toggleRevenueCustomInputs() {
            if (!revenueCustomInputs || !revenueRange) return;
            const isCustom = revenueRange.value === 'custom';
            revenueCustomInputs.classList.toggle('hidden', !isCustom);
        }

        async function applyRevenueFilter() {
            if (!revenueChart || !revenueRange) return;
            const params = new URLSearchParams();
            params.set('ajax', '1');
            params.set('revenue_range', revenueRange.value || 'week');
            if (revenueRange.value === 'custom') {
                if (revenueFrom?.value) params.set('from', revenueFrom.value);
                if (revenueTo?.value) params.set('to', revenueTo.value);
            }
            if (revenueStatus) revenueStatus.textContent = 'Loading...';
            try {
                const res = await fetch(`/admin_dashboard/?${params.toString()}`);
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                revenueChart.data.labels = data.labels || [];
                revenueChart.data.datasets[0].data = data.values || [];
                revenueChart.update();
                if (revenueStatus) revenueStatus.textContent = 'Updated';
                setTimeout(() => {
                    if (revenueStatus) revenueStatus.textContent = '';
                }, 1500);
            } catch (err) {
                if (revenueStatus) revenueStatus.textContent = 'Failed';
            }
        }

        if (revenueRange) {
            revenueRange.addEventListener('change', toggleRevenueCustomInputs);
        }
        if (revenueApply) {
            revenueApply.addEventListener('click', function (e) {
                e.preventDefault();
                applyRevenueFilter();
            });
        }
        toggleRevenueCustomInputs();

        // Delegate handlers for dynamically refreshed rows
        document.addEventListener('click', function (event) {
            const userLockBtn = event.target.closest('.user-lock-btn');
            if (userLockBtn) {
                handleUserLockClick(userLockBtn);
                return;
            }

            const userDeleteBtn = event.target.closest('.user-delete-btn');
            if (userDeleteBtn) {
                handleCustomerDeleteClick(userDeleteBtn);
                return;
            }

            const partnerDeleteBtn = event.target.closest('.user-partner-delete-btn');
            if (partnerDeleteBtn) {
                handlePartnerDeleteClick(partnerDeleteBtn);
                return;
            }

            const customerViewBtn = event.target.closest('.customer-view-btn');
            if (customerViewBtn) {
                openCustomerModal(customerViewBtn);
                return;
            }

            const orderBtn = event.target.closest('.order-view-btn');
            if (orderBtn) {
                const orderId = orderBtn.getAttribute('data-order-id');
                if (orderId) {
                    loadOrderDetails(orderId);
                }
                return;
            }

            const returnViewBtn = event.target.closest('.return-view-btn');
            if (returnViewBtn) {
                openReturnDetailsModal(returnViewBtn);
                return;
            }

            const refundBtn = event.target.closest('.return-refund-btn');
            if (refundBtn) {
                openRefundInspectModal(refundBtn);
                return;
            }
        });

        document.addEventListener('change', function (event) {
            const toggle = event.target.closest('.user-toggle-input');
            if (toggle) {
                handleUserToggleChange(toggle);
            }
        });

        // Live refresh for admin dashboard data (no full page reload)
        function refreshAdminSnapshot() {
            const url = new URL(window.location.href);
            url.searchParams.set('live', '1');

            fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.text())
                .then(html => {
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const idsToSync = [
                        'stat-total-revenue',
                        'stat-total-orders',
                        'stat-active-users',
                        'stat-active-delivery',
                        'badge-returns',
                        'badge-refunds',
                        'badge-orders',
                        'badge-inventory',
                        'recentOrdersBody',
                        'ordersTableBody',
                        'returnsTableBody',
                        'customerUsersTableBody',
                        'deliveryPartnersUserBody',
                        'customersTableBody',
                        'partnersTableBody',
                        'cancelledRefundsTableBody',
                        'refundsTableBody'
                    ];

                    idsToSync.forEach(id => {
                        const current = document.getElementById(id);
                        const next = doc.getElementById(id);
                        if (current && next) {
                            current.innerHTML = next.innerHTML;
                        }
                    });

                    if (typeof applyReturnFilters === 'function') {
                        applyReturnFilters();
                    }
                    if (typeof applyUserFilters === 'function') {
                        applyUserFilters();
                    }
                    if (typeof applyOrderFilters === 'function') {
                        applyOrderFilters();
                    }
                })
                .catch(() => {});
        }

        setInterval(refreshAdminSnapshot, 30000);
    </script>
</body>
</html>
